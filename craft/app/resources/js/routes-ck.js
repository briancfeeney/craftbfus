/**
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2014, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */(function(e){var t=Garnish.Base.extend({tokens:null,routes:null,$container:null,$addRouteBtn:null,sorter:null,init:function(){this.tokens={};this.routes=[];this.$container=e("#routes");var t=this.getRoutes();for(var r=0;r<t.length;r++){var i=new n(t[r]);this.routes.push(i)}this.sorter=new Garnish.DragSort(t,{axis:Garnish.Y_AXIS,onSortChange:e.proxy(this,"updateRouteOrder")});this.$addRouteBtn=e("#add-route-btn");this.addListener(this.$addRouteBtn,"click","addRoute")},getRoutes:function(){return this.$container.children()},updateRouteOrder:function(){var t=this.getRoutes(),n={};for(var r=0;r<t.length;r++)n["routeIds["+r+"]"]=e(t[r]).attr("data-id");Craft.postActionRequest("routes/updateRouteOrder",n,e.proxy(function(e,t){t=="success"&&(e.success?Craft.cp.displayNotice(Craft.t("New route order saved.")):Craft.cp.displayError(Craft.t("Couldn’t save new route order.")))},this))},addRoute:function(){new r}}),n=Garnish.Base.extend({$container:null,id:null,locale:null,$locale:null,$url:null,$template:null,modal:null,init:function(t){this.$container=e(t);this.id=this.$container.data("id");this.locale=this.$container.data("locale");this.$locale=this.$container.find(".locale:first");this.$url=this.$container.find(".url:first");this.$template=this.$container.find(".template:first");this.addListener(this.$container,"click","edit")},edit:function(){this.modal?this.modal.show():this.modal=new r(this)},updateHtmlFromModal:function(){Craft.routes.locales&&(this.locale?this.$locale.text(this.locale):this.$locale.text(Craft.t("Global")));var e="";for(var t=0;t<this.modal.urlInput.elements.length;t++){var n=this.modal.urlInput.elements[t];this.modal.urlInput.isText(n)?e+=n.val():e+=n.prop("outerHTML")}this.$url.html(e);this.$template.html(this.modal.$templateInput.val())}}),r=Garnish.Modal.extend({route:null,$heading:null,$urlInput:null,urlElements:null,$templateInput:null,$saveBtn:null,$cancelBtn:null,$spinner:null,$deleteBtn:null,loading:!1,init:function(t){this.route=t;var n="<h4>"+Craft.t("Add a token")+"</h4>";for(var r in Craft.routes.tokens){var i=Craft.routes.tokens[r];n+='<div class="token" data-name="'+r+'" data-value="'+i+'"><span>'+r+"</span></div>"}var s='<form class="modal fitted route-settings" accept-charset="UTF-8"><div class="header"><h1></h1></div><div class="body"><div class="field"><div class="heading"><label for="url">'+Craft.t("If the URI looks like this")+":</label>"+"</div>";Craft.routes.locales&&(s+='<table class="inputs fullwidth"><tr><td>');s+='<div id="url" class="text url ltr"></div>';if(Craft.routes.locales){s+='</td><td class="thin"><div class="select"><select class="locale"><option value="">'+Craft.t("Global")+"</option>";for(var o=0;o<Craft.routes.locales.length;o++){var u=Craft.routes.locales[o];s+='<option value="'+u+'">'+u+"</option>"}s+="</select></div></td></tr></table>"}s+='<div class="url-tokens">'+n+"</div>"+"</div>"+'<div class="field">'+'<div class="heading">'+'<label for="template">'+Craft.t("Load this template")+":</label>"+"</div>"+'<input id="template" type="text" class="text fullwidth template ltr">'+"</div>"+"</div>"+'<div class="footer">'+'<div class="buttons right last">'+'<input type="button" class="btn cancel" value="'+Craft.t("Cancel")+'">'+'<input type="submit" class="btn submit" value="'+Craft.t("Save")+'"> '+'<div class="spinner" style="display: none;"></div>'+"</div>"+'<a class="delete">'+Craft.t("Delete")+"</a>"+"</div>"+"</form>";var a=e(s).appendTo(Garnish.$bod);this.$heading=a.find("h1:first");this.$localeInput=a.find(".locale:first");this.$urlInput=a.find(".url:first");this.$templateInput=a.find(".template:first");this.$saveBtn=a.find(".submit:first");this.$cancelBtn=a.find(".cancel:first");this.$spinner=a.find(".spinner:first");this.$deleteBtn=a.find(".delete:first");this.route||this.$deleteBtn.hide();this.urlInput=new Garnish.MixedInput(this.$urlInput,{dir:"ltr"});this.route?this.$heading.html(Craft.t("Edit Route")):this.$heading.html(Craft.t("Create a new route"));if(this.route){this.$localeInput.val(this.route.locale);var f=this.route.$url.prop("childNodes");for(var o=0;o<f.length;o++){var l=f[o];if(Garnish.isTextNode(l)){var c=this.urlInput.addTextElement();c.setVal(l.nodeValue)}else this.addUrlVar(l)}setTimeout(e.proxy(function(){var e=this.urlInput.elements[0];this.urlInput.setFocus(e);this.urlInput.setCarotPos(e,0)},this),1);var h=this.route.$template.text();this.$templateInput.val(h)}else setTimeout(e.proxy(function(){this.$urlInput.focus()},this),100);this.base(a);var p=this.$container.find(".url-tokens").children("div");this.addListener(p,"mousedown",function(e){this.addUrlVar(e.currentTarget)});this.addListener(this.$container,"submit","saveRoute");this.addListener(this.$cancelBtn,"click","cancel");this.addListener(this.$deleteBtn,"click","deleteRoute")},addUrlVar:function(t){var n=e(t).clone().attr("tabindex","0");this.urlInput.addElement(n);this.addListener(n,"keydown",function(t){switch(t.keyCode){case Garnish.LEFT_KEY:setTimeout(e.proxy(function(){this.urlInput.focusPreviousElement(n)},this),1);break;case Garnish.RIGHT_KEY:setTimeout(e.proxy(function(){this.urlInput.focusNextElement(n)},this),1);break;case Garnish.DELETE_KEY:setTimeout(e.proxy(function(){this.urlInput.removeElement(n)},this),1);t.preventDefault()}})},show:function(){if(this.route){this.$heading.html(Craft.t("Edit Route"));this.$deleteBtn.show()}this.base()},saveRoute:function(t){t.preventDefault();if(this.loading)return;var r={locale:this.$localeInput.val()};this.route&&(r.routeId=this.route.id);for(var i=0;i<this.urlInput.elements.length;i++){var s=this.urlInput.elements[i];if(this.urlInput.isText(s))r["url["+i+"]"]=s.val();else{r["url["+i+"][0]"]=s.attr("data-name");r["url["+i+"][1]"]=s.attr("data-value")}}r.template=this.$templateInput.val();this.loading=!0;this.$saveBtn.addClass("active");this.$spinner.show();Craft.postActionRequest("routes/saveRoute",r,e.proxy(function(t,r){this.$saveBtn.removeClass("active");this.$spinner.hide();this.loading=!1;if(r=="success")if(t.success){if(!this.route){var i='<div class="pane route" data-id="'+t.routeId+'"'+(t.locale?' data-locale="'+t.locale+'"':"")+">"+'<div class="url-container">';Craft.routes.locales&&(i+='<span class="locale"></span>');i+='<span class="url" dir="ltr"></span></div><div class="template" dir="ltr"></div></div>';var s=e(i);s.appendTo("#routes");this.route=new n(s);this.route.modal=this;Craft.routes.sorter.addItems(s);Craft.routes.sorter.$items.length==1&&e("#noroutes").addClass("hidden")}this.route.locale=t.locale;this.route.updateHtmlFromModal();this.hide();Craft.cp.displayNotice(Craft.t("Route saved."))}else Craft.cp.displayError(Craft.t("Couldn’t save route."))},this))},cancel:function(){this.hide();this.route&&(this.route.modal=null)},deleteRoute:function(){if(confirm(Craft.t("Are you sure you want to delete this route?"))){Craft.postActionRequest("routes/deleteRoute",{routeId:this.route.id},function(e,t){t=="success"&&Craft.cp.displayNotice(Craft.t("Route deleted."))});Craft.routes.sorter.removeItems(this.route.$container);this.route.$container.remove();this.hide();Craft.routes.sorter.$items.length==0&&e("#noroutes").removeClass("hidden")}}});Craft.routes=new t})(jQuery);