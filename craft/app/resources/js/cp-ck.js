/**
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2014, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */(function(e){var t=Garnish.Base.extend({$alerts:null,$header:null,$nav:null,$overflowNavMenuItem:null,$overflowNavMenuBtn:null,$overflowNavMenu:null,$overflowNavMenuList:null,$notificationWrapper:null,$notificationContainer:null,$main:null,$content:null,$collapsibleTables:null,navItems:null,totalNavItems:null,visibleNavItems:null,totalNavWidth:null,showingOverflowNavMenu:!1,fixedNotifications:!1,runningTaskInfo:null,trackTaskProgressTimeout:null,taskProgressIcon:null,$upgradePromo:null,upgradeModal:null,init:function(){this.$alerts=e("#alerts");this.$header=e("#header");this.$nav=e("#nav");this.$notificationWrapper=e("#notifications-wrapper");this.$notificationContainer=e("#notifications");this.$main=e("#main");this.$content=e("#content");this.$collapsibleTables=this.$content.find("table.collapsible");this.$upgradePromo=e("#upgradepromo > a");this.navItems=[];this.totalNavWidth=t.baseNavWidth;var n=this.$nav.children();this.totalNavItems=n.length;this.visibleNavItems=this.totalNavItems;for(var r=0;r<this.totalNavItems;r++){var i=e(n[r]),s=i.width();this.navItems.push(i);this.totalNavWidth+=s}this.addListener(Garnish.$win,"resize","onWindowResize");this.onWindowResize();this.addListener(Garnish.$win,"scroll","updateFixedNotifications");this.updateFixedNotifications();var o=this.$notificationContainer.children(".error"),u=this.$notificationContainer.children(":not(.error)");o.delay(t.notificationDuration*2).fadeOut();u.delay(t.notificationDuration).fadeOut();this.addListener(e(".formsubmit"),"activate",function(t){var n=e(t.currentTarget);if(n.attr("data-confirm")&&!confirm(n.attr("data-confirm")))return;if(n.data("menu"))var r=n.data("menu").$trigger.closest("form");else var r=n.closest("form");n.attr("data-action")&&e('<input type="hidden" name="action" value="'+n.attr("data-action")+'"/>').appendTo(r);n.attr("data-redirect")&&e('<input type="hidden" name="redirect" value="'+n.attr("data-redirect")+'"/>').appendTo(r);r.submit()});this.$alerts.length&&this.initAlerts();var a=e('form[data-saveshortcut="1"]:first');a.length==1&&this.addListener(Garnish.$doc,"keydown",function(t){if((t.metaKey||t.ctrlKey)&&t.keyCode==Garnish.S_KEY){t.preventDefault();this.trigger("beforeSaveShortcut");a.data("saveshortcut-redirect")&&e('<input type="hidden" name="redirect" value="'+a.data("saveshortcut-redirect")+'"/>').appendTo(a);a.submit()}return!0});this.addListener(this.$upgradePromo,"click","showUpgradeModal");var f=e("#wrongedition-modal");f.length&&new Craft.WrongEditionModal(f)},onWindowResize:function(){this.onWindowResize._cpWidth=Math.min(Garnish.$win.width(),t.maxWidth);this.updateResponsiveNav();this.updateResponsiveTables()},updateResponsiveNav:function(){if(this.onWindowResize._cpWidth<this.totalNavWidth){if(!this.showingOverflowNavMenu){if(!this.$overflowNavMenuBtn){this.$overflowNavMenuItem=e("<li/>").appendTo(this.$nav);this.$overflowNavMenuBtn=e('<a class="menubtn" title="'+Craft.t("More")+'">â€¦</a>').appendTo(this.$overflowNavMenuItem);this.$overflowNavMenu=e('<div id="overflow-nav" class="menu" data-align="right"/>').appendTo(this.$overflowNavMenuItem);this.$overflowNavMenuList=e("<ul/>").appendTo(this.$overflowNavMenu);new Garnish.MenuBtn(this.$overflowNavMenuBtn)}else this.$overflowNavMenuItem.show();this.showingOverflowNavMenu=!0}if(this.$nav.height()>t.navHeight){do this.addLastVisibleNavItemToOverflowMenu();while(this.$nav.height()>t.navHeight&&this.visibleNavItems>0)}else{do this.addFirstOverflowNavItemToMainMenu();while(this.$nav.height()==t.navHeight&&this.visibleNavItems<this.totalNavItems);this.addLastVisibleNavItemToOverflowMenu()}}else if(this.showingOverflowNavMenu){this.$overflowNavMenuItem.hide();while(this.visibleNavItems<this.totalNavItems)this.addFirstOverflowNavItemToMainMenu();this.showingOverflowNavMenu=!1}},updateResponsiveTables:function(){if(!Garnish.isMobileBrowser())return;this.updateResponsiveTables._contentWidth=this.$content.width();for(this.updateResponsiveTables._i=0;this.updateResponsiveTables._i<this.$collapsibleTables.length;this.updateResponsiveTables._i++){this.updateResponsiveTables._$table=e(this.$collapsibleTables[this.updateResponsiveTables._i]);this.updateResponsiveTables._check=!1;if(typeof this.updateResponsiveTables._lastContentWidth!="undefined"){this.updateResponsiveTables._isLinear=this.updateResponsiveTables._$table.hasClass("collapsed");if(this.updateResponsiveTables._contentWidth>this.updateResponsiveTables._lastContentWidth){if(this.updateResponsiveTables._isLinear){this.updateResponsiveTables._$table.removeClass("collapsed");this.updateResponsiveTables._check=!0}}else this.updateResponsiveTables._isLinear||(this.updateResponsiveTables._check=!0)}else this.updateResponsiveTables._check=!0;this.updateResponsiveTables._check&&this.updateResponsiveTables._$table.width()>this.updateResponsiveTables._contentWidth&&this.updateResponsiveTables._$table.addClass("collapsed")}this.updateResponsiveTables._lastContentWidth=this.updateResponsiveTables._contentWidth},addLastVisibleNavItemToOverflowMenu:function(){this.navItems[this.visibleNavItems-1].prependTo(this.$overflowNavMenuList);this.visibleNavItems--},addFirstOverflowNavItemToMainMenu:function(){this.navItems[this.visibleNavItems].insertBefore(this.$overflowNavMenuItem);this.visibleNavItems++},updateFixedNotifications:function(){this.updateFixedNotifications._headerHeight=this.$header.height();if(Garnish.$win.scrollTop()>this.updateFixedNotifications._headerHeight){if(!this.fixedNotifications){this.$notificationWrapper.addClass("fixed");this.fixedNotifications=!0}}else if(this.fixedNotifications){this.$notificationWrapper.removeClass("fixed");this.fixedNotifications=!1}},displayNotification:function(n,r){var i=t.notificationDuration;n=="error"&&(i*=2);e('<div class="notification '+n+'">'+r+"</div>").appendTo(this.$notificationContainer).hide().fadeIn("fast").delay(i).fadeOut()},displayNotice:function(e){this.displayNotification("notice",e)},displayError:function(e){e||(e=Craft.t("An unknown error occurred."));this.displayNotification("error",e)},fetchAlerts:function(){var t={path:Craft.path};Craft.queueActionRequest("app/getCpAlerts",t,e.proxy(this,"displayAlerts"))},displayAlerts:function(t){if(Garnish.isArray(t)&&t.length){this.$alerts=e('<ul id="alerts"/>').insertBefore(e("#header"));for(var n=0;n<t.length;n++)e("<li>"+t[n]+"</li>").appendTo(this.$alerts);var r=this.$alerts.height();this.$alerts.height(0).animate({height:r},"fast",e.proxy(function(){this.$alerts.height("auto")},this));this.initAlerts()}},initAlerts:function(){var t=this.$alerts.find(".domain-mismatch:first");t.length&&this.addListener(t,"click",e.proxy(function(n){n.preventDefault();confirm(Craft.t("Are you sure you want to transfer your license to this domain?"))&&Craft.queueActionRequest("app/transferLicenseToCurrentDomain",e.proxy(function(e,n){if(n=="success")if(e.success){t.parent().remove();this.displayNotice(Craft.t("License transferred."))}else Craft.cp.displayError(e.error)},this))},this));var n=this.$alerts.find('a[class^="shun:"]');for(var r=0;r<n.length;r++)this.addListener(n[r],"click",e.proxy(function(t){t.preventDefault();var n=e(t.currentTarget),r={message:n.prop("className").substr(5)};Craft.queueActionRequest("app/shunCpAlert",r,e.proxy(function(e,t){t=="success"&&(e.success?n.parent().remove():Craft.cp.displayError(e.error))},this))},this))},checkForUpdates:function(){Craft.queueActionRequest("app/checkForUpdates",e.proxy(function(e){this.displayUpdateInfo(e);this.trigger("checkForUpdates",{updateInfo:e})},this))},displayUpdateInfo:function(t){e("#header-actions > li.updates").remove();if(t.total){if(t.total==1)var n=Craft.t("1 update available");else var n=Craft.t("{num} updates available",{num:t.total});e('<li class="updates'+(t.critical?" critical":"")+'">'+'<a data-icon="newstamp" href="'+Craft.getUrl("updates")+'" title="'+n+'">'+"<span>"+t.total+"</span>"+"</a>"+"</li>").prependTo(e("#header-actions"));e("#footer-updates").text(n)}},runPendingTasks:function(){Craft.queueActionRequest("tasks/runPendingTasks",e.proxy(function(e,t){if(e){this.setRunningTaskInfo(e);this.trackTaskProgress()}},this))},trackTaskProgress:function(){if(this.trackTaskProgressTimeout)return;this.trackTaskProgressTimeout=setTimeout(e.proxy(function(){Craft.queueActionRequest("tasks/getRunningTaskInfo",e.proxy(function(e,t){if(t=="success"){this.setRunningTaskInfo(e,!0);e.status=="running"&&this.trackTaskProgress()}},this))},this),1e3)},stopTrackingTaskProgress:function(){if(this.trackTaskProgressTimeout){clearTimeout(this.trackTaskProgressTimeout);this.trackTaskProgressTimeout=null}},setRunningTaskInfo:function(e,t){this.runningTaskInfo=e;if(e){this.taskProgressIcon||(this.taskProgressIcon=new n);if(e.status=="running"){this.taskProgressIcon.hideFailMode();this.taskProgressIcon.setDescription(e.description);this.taskProgressIcon.setProgress(e.progress,t)}else e.status=="error"&&this.taskProgressIcon.showFailMode()}else if(this.taskProgressIcon){this.taskProgressIcon.hideFailMode();this.taskProgressIcon.complete()}},showUpgradeModal:function(){this.upgradeModal?this.upgradeModal.show():this.upgradeModal=new Craft.UpgradeModal}},{maxWidth:1051,navHeight:38,baseNavWidth:30,notificationDuration:2e3});Craft.cp=new t;var n=Garnish.Base.extend({$li:null,$a:null,hud:null,completed:!1,failMode:!1,_canvasSupported:null,_$bgCanvas:null,_$staticCanvas:null,_$hoverCanvas:null,_$failCanvas:null,_staticCtx:null,_hoverCtx:null,_canvasSize:null,_arcPos:null,_arcRadius:null,_lineWidth:null,_arcStartPos:0,_arcEndPos:0,_arcStartStepSize:null,_arcEndStepSize:null,_arcStep:null,_arcStepTimeout:null,_arcAnimateCallback:null,_progressBar:null,init:function(){this.$li=e("<li/>").prependTo(e("#header-actions"));this.$a=e('<a id="taskicon"/>').appendTo(this.$li);this._canvasSupported=!!document.createElement("canvas").getContext;if(this._canvasSupported){var t=window.devicePixelRatio>1?2:1;this._canvasSize=30*t;this._arcPos=this._canvasSize/2;this._arcRadius=7*t;this._lineWidth=3*t;this._$bgCanvas=this._createCanvas("bg","#61666b");this._$staticCanvas=this._createCanvas("static","#d7d9db");this._$hoverCanvas=this._createCanvas("hover","#fff");this._$failCanvas=this._createCanvas("fail","#da5a47").hide();this._staticCtx=this._$staticCanvas[0].getContext("2d");this._hoverCtx=this._$hoverCanvas[0].getContext("2d");this._drawArc(this._$bgCanvas[0].getContext("2d"),0,1);this._drawArc(this._$failCanvas[0].getContext("2d"),0,1)}else{this._progressBar=new Craft.ProgressBar(this.$a);this._progressBar.showProgressBar()}this.addListener(this.$a,"click","toggleHud")},setDescription:function(e){this.$a.attr("title",e)},setProgress:function(e,t){this._canvasSupported?t?this._animateArc(0,e):this._setArc(0,e):this._progressBar.setProgressPercentage(e*100)},complete:function(){this.completed=!0;if(this._canvasSupported)this._animateArc(0,1,e.proxy(function(){this._$bgCanvas.fadeOut();this._animateArc(1,1,e.proxy(function(){this.$li.remove();this.destroy()},this))},this));else{this._progressBar.setProgressPercentage(100);this.$a.fadeOut()}},showFailMode:function(){if(this.failMode)return;this.failMode=!0;if(this._canvasSupported){this._$bgCanvas.hide();this._$staticCanvas.hide();this._$hoverCanvas.hide();this._$failCanvas.show()}else{this._progressBar.$progressBar.css("border-color","#da5a47");this._progressBar.$innerProgressBar.css("background-color","#da5a47");this._progressBar.setProgressPercentage(50)}this.setDescription(Craft.t("Failed task"))},hideFailMode:function(){if(!this.failMode)return;this.failMode=!1;if(this._canvasSupported){this._$bgCanvas.show();this._$staticCanvas.show();this._$hoverCanvas.show();this._$failCanvas.hide()}else{this._progressBar.$progressBar.css("border-color","");this._progressBar.$innerProgressBar.css("background-color","");this._progressBar.setProgressPercentage(50)}},toggleHud:function(){this.hud?this.hud.toggle():this.hud=new r},_createCanvas:function(t,n){var r=e('<canvas id="taskicon-'+t+'" width="'+this._canvasSize+'" height="'+this._canvasSize+'"/>').appendTo(this.$a),i=r[0].getContext("2d");i.strokeStyle=n;i.lineWidth=this._lineWidth;i.lineCap="round";return r},_setArc:function(e,t){this._arcStartPos=e;this._arcEndPos=t;this._drawArc(this._staticCtx,e,t);this._drawArc(this._hoverCtx,e,t)},_drawArc:function(e,t,n){e.clearRect(0,0,this._canvasSize,this._canvasSize);e.beginPath();e.arc(this._arcPos,this._arcPos,this._arcRadius,(1.5+t*2)*Math.PI,(1.5+n*2)*Math.PI);e.stroke();e.closePath()},_animateArc:function(e,t,n){this._arcStepTimeout&&clearTimeout(this._arcStepTimeout);this._arcStep=0;this._arcStartStepSize=(e-this._arcStartPos)/10;this._arcEndStepSize=(t-this._arcEndPos)/10;this._arcAnimateCallback=n;this._takeNextArcStep()},_takeNextArcStep:function(){this._setArc(this._arcStartPos+this._arcStartStepSize,this._arcEndPos+this._arcEndStepSize);this._arcStep++;this._arcStep<10?this._arcStepTimeout=setTimeout(e.proxy(this,"_takeNextArcStep"),50):this._arcAnimateCallback&&this._arcAnimateCallback()}}),r=Garnish.HUD.extend({icon:null,tasksById:null,completedTasks:null,updateTasksTimeout:null,completed:!1,init:function(){this.icon=Craft.cp.taskProgressIcon;this.tasksById={};this.completedTasks=[];this.base(this.icon.$a);this.$body.attr("id","tasks-hud");Craft.cp.runningTaskInfo&&Craft.cp.runningTaskInfo.status!="error"&&this.showTaskInfo([Craft.cp.runningTaskInfo]);this.$hud.trigger("resize")},onShow:function(){Craft.cp.stopTrackingTaskProgress();this.updateTasks();this.base()},onHide:function(){this.updateTasksTimeout&&clearTimeout(this.updateTasksTimeout);this.completed||Craft.cp.trackTaskProgress();if(this.completedTasks.length){for(var e=0;e<this.completedTasks.length;e++)this.completedTasks[e].destroy();this.completedTasks=[]}this.base()},updateTasks:function(){this.completed=!1;Craft.postActionRequest("tasks/getTaskInfo",e.proxy(function(e,t){t=="success"&&this.showTaskInfo(e)},this))},showTaskInfo:function(t){var n=[];if(t)for(var i=0;i<t.length;i++)n.push(t[i].id);for(var s in this.tasksById)if(!Craft.inArray(s,n)){this.tasksById[s].complete();this.completedTasks.push(this.tasksById[s]);delete this.tasksById[s]}if(t&&t.length){var o=!1,u=!1;for(var i=0;i<t.length;i++){var a=t[i];!o&&a.status=="running"?o=!0:!u&&a.status=="error"&&(u=!0);if(this.tasksById[a.id])this.tasksById[a.id].updateStatus(a);else{this.tasksById[a.id]=new r.Task(this,a);for(var f=i+1;f<t.length;f++)if(this.tasksById[t[f].id]){this.tasksById[a.id].$container.insertBefore(this.tasksById[t[f].id].$container);break}}}if(o)this.updateTasksTimeout=setTimeout(e.proxy(this,"updateTasks"),500);else{this.completed=!0;u&&Craft.cp.setRunningTaskInfo({status:"error"})}}else{this.completed=!0;Craft.cp.setRunningTaskInfo(null);this.hide()}}});r.Task=Garnish.Base.extend({hud:null,id:null,level:null,description:null,status:null,progress:null,$container:null,$statusContainer:null,$descriptionContainer:null,_progressBar:null,init:function(t,n){this.hud=t;this.id=n.id;this.level=n.level;this.description=n.description;this.$container=e('<div class="task"/>').appendTo(this.hud.$body);this.$statusContainer=e('<div class="task-status"/>').appendTo(this.$container);this.$descriptionContainer=e('<div class="task-description"/>').appendTo(this.$container).text(n.description);this.$container.data("task",this);if(this.level!=0){this.$container.css("padding-"+Craft.left,24+this.level*24);e('<div class="indent" data-icon="'+(Craft.orientation=="ltr"?"rarr":"larr")+'"/>').appendTo(this.$descriptionContainer)}this.updateStatus(n)},updateStatus:function(t){if(this.status!=t.status){this.$statusContainer.empty();this.status=t.status;switch(this.status){case"pending":this.$statusContainer.text(Craft.t("Pending"));break;case"running":this._progressBar=new Craft.ProgressBar(this.$statusContainer);this._progressBar.showProgressBar();break;case"error":e('<span class="error">'+Craft.t("Failed")+"</span>").appendTo(this.$statusContainer);if(this.level==0){var n=e('<a class="menubtn error" title="'+Craft.t("Options")+'"/>').appendTo(this.$statusContainer);e('<div class="menu"><ul><li><a data-action="rerun">'+Craft.t("Try again")+"</a></li>"+'<li><a data-action="cancel">'+Craft.t("Cancel")+"</a></li>"+"</ul>"+"</div>").appendTo(this.$statusContainer);new Garnish.MenuBtn(n,{onOptionSelect:e.proxy(this,"performErrorAction")})}}}if(this.status=="running"){this._progressBar.setProgressPercentage(t.progress*100);this.level==0&&Craft.cp.setRunningTaskInfo(t,!0)}},performErrorAction:function(t){var n=this.$container.nextAll();for(var r=0;r<n.length;r++){var i=e(n[r]).data("task");if(!i||i.level==0)break;i.destroy()}switch(e(t).data("action")){case"rerun":Craft.postActionRequest("tasks/rerunTask",{taskId:this.id},e.proxy(function(e,t){if(t=="success"){this.updateStatus(e);this.hud.completed&&this.hud.updateTasks()}},this));break;case"cancel":Craft.postActionRequest("tasks/deleteTask",{taskId:this.id},e.proxy(function(e,t){if(t=="success"){this.destroy();this.hud.completed&&this.hud.updateTasks()}},this))}},complete:function(){this.$statusContainer.empty();e('<div data-icon="check"/>').appendTo(this.$statusContainer)},destroy:function(){this.hud.tasksById[this.id]&&delete this.hud.tasksById[this.id];this.$container.remove();this.base()}})})(jQuery);