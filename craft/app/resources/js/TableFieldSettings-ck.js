/**
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2014, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */(function(e){Craft.TableFieldSettings=Garnish.Base.extend({columnsTableName:null,defaultsTableName:null,columnsTableId:null,defaultsTableId:null,columnsTableInputPath:null,defaultsTableInputPath:null,defaults:null,columnSettings:null,columnsTable:null,defaultsTable:null,init:function(e,t,n,r,i){this.columnsTableName=e;this.defaultsTableName=t;this.columnsTableId=Craft.formatInputId(this.columnsTableName);this.defaultsTableId=Craft.formatInputId(this.defaultsTableName);this.columnsTableInputPath=this.columnsTableId.split("-");this.defaultsTableInputPath=this.defaultsTableId.split("-");this.defaults=r;this.columnSettings=i;this.initColumnsTable();this.initDefaultsTable(n)},initColumnsTable:function(){this.columnsTable=new Craft.EditableTable(this.columnsTableId,this.columnsTableName,this.columnSettings,{rowIdPrefix:"col",onAddRow:e.proxy(this,"onAddColumn"),onDeleteRow:e.proxy(this,"reconstructDefaultsTable")});this.initColumnSettingInputs(this.columnsTable.$tbody);this.columnsTable.sorter.settings.onSortChange=e.proxy(this,"reconstructDefaultsTable")},initDefaultsTable:function(e){this.defaultsTable=new Craft.EditableTable(this.defaultsTableId,this.defaultsTableName,e,{rowIdPrefix:"row"})},onAddColumn:function(e){this.reconstructDefaultsTable();this.initColumnSettingInputs(e)},initColumnSettingInputs:function(e){var t=e.find("td:first-child textarea, td:nth-child(3) textarea"),n=e.find("td:nth-child(4) select");this.addListener(t,"textchange","reconstructDefaultsTable");this.addListener(n,"change","reconstructDefaultsTable")},reconstructDefaultsTable:function(){var e=Craft.expandPostArray(Garnish.getPostData(this.columnsTable.$tbody)),t=Craft.expandPostArray(Garnish.getPostData(this.defaultsTable.$tbody)),n=e,r=t;for(var i=0;i<this.columnsTableInputPath.length;i++){var s=this.columnsTableInputPath[i];n=n[s]}for(var i=0;i<this.defaultsTableInputPath.length;i++){var s=this.defaultsTableInputPath[i];r=r[s]}var o='<table id="'+this.defaultsTableId+'" class="editable shadow-box">'+"<thead>"+"<tr>";for(var u in n)o+='<th scope="col" class="header">'+(n[u].heading?n[u].heading:"&nbsp;")+"</th>";o+='<th class="header" colspan="2"></th></tr></thead><tbody>';for(var a in r)o+=Craft.EditableTable.getRowHtml(a,n,this.defaultsTableName,r[a]);o+="</tbody></table>";this.defaultsTable.$table.replaceWith(o);this.defaultsTable.destroy();delete this.defaultsTable;this.initDefaultsTable(n)}})})(jQuery);