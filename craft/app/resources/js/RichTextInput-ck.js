/**
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2014, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */(function(e){Craft.RichTextInput=Garnish.Base.extend({id:null,sectionSources:null,elementLocale:null,redactorConfig:null,$textarea:null,redactor:null,init:function(t,n,r,i,s){this.id=t;this.sectionSources=n;this.elementLocale=r;this.redactorConfig=i;this.redactorConfig.lang=s;this.redactorConfig.direction=Craft.orientation;this.$textarea=e("#"+this.id);this.initRedactor();if(typeof Craft.livePreview!="undefined"){Craft.livePreview.on("beforeEnter beforeExit",e.proxy(function(){this.redactor.destroy()},this));Craft.livePreview.on("enter slideOut",e.proxy(function(){this.initRedactor()},this))}},initRedactor:function(){this.$textarea.redactor(this.redactorConfig);this.redactor=this.$textarea.data("redactor");this.replaceRedactorButton("image",Craft.t("Insert image"),null,{from_web:{title:Craft.t("Insert URL"),func:"imageShow"},from_assets:{title:Craft.t("Choose image"),callback:function(){this.selectionSave();var t=this;typeof this.assetSelectionModal=="undefined"?this.assetSelectionModal=Craft.createElementSelectorModal("Asset",{storageKey:"RichTextFieldType.ChooseImage",multiSelect:!0,criteria:{locale:this.elementLocale,kind:"image"},onSelect:e.proxy(function(n,r){if(n.length){t.selectionRestore();for(var i=0;i<n.length;i++){var s=n[i],o=s.url+"#asset:"+s.id;r&&(o+=":"+r);t.insertNode(e('<img src="'+o+'" />')[0]);t.sync()}this.observeImages();t.dropdownHideAll()}},this),closeOtherModals:!1,canSelectImageTransforms:!0}):this.assetSelectionModal.show()}}});this.replaceRedactorButton("link",Craft.t("Link"),null,{link_entry:{title:Craft.t("Link to an entry"),callback:function(){this.selectionSave();var t=this;typeof this.entrySelectionModal=="undefined"?this.entrySelectionModal=Craft.createElementSelectorModal("Entry",{storageKey:"RichTextFieldType.LinkToEntry",sources:this.sectionSources,criteria:{locale:this.elementLocale},onSelect:function(n){if(n.length){t.selectionRestore();var r=n[0],i=r.url+"#entry:"+r.id,s=t.getSelectionText(),o=s.length>0?s:r.label;t.insertNode(e('<a href="'+i+'">'+o+"</a>")[0]);t.sync()}t.dropdownHideAll()},closeOtherModals:!1}):this.entrySelectionModal.show()}},link_asset:{title:Craft.t("Link to an asset"),callback:function(){this.selectionSave();var t=this;typeof this.assetLinkSelectionModal=="undefined"?this.assetLinkSelectionModal=Craft.createElementSelectorModal("Asset",{storageKey:"RichTextFieldType.LinkToAsset",criteria:{locale:this.elementLocale},onSelect:function(n){if(n.length){t.selectionRestore();var r=n[0],i=r.url+"#asset:"+r.id,s=t.getSelectionText(),o=s.length>0?s:r.label;t.insertNode(e('<a href="'+i+'">'+o+"</a>")[0]);t.sync()}t.dropdownHideAll()},closeOtherModals:!1,canSelectImageTransforms:!0}):this.assetLinkSelectionModal.show()}},link:{title:Craft.t("Insert link"),func:"linkShow"},unlink:{title:Craft.t("Unlink"),exec:"unlink"}});typeof this.redactor.fullscreen!="undefined"&&typeof this.redactor.toggleFullscreen=="function"&&Craft.cp.on("beforeSaveShortcut",e.proxy(function(){this.redactor.fullscreen&&this.redactor.toggleFullscreen()},this))},replaceRedactorButton:function(e,t,n,r){if(!this.redactor.buttonGet(e).length)return;var i=e+"_placeholder";this.redactor.buttonAddAfter(e,i);this.redactor.buttonRemove(e);this.redactor.buttonAddAfter(i,e,t,n,r);this.redactor.buttonRemove(i)}})})(jQuery);