/**
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2014, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */(function(e){Craft.Locales=Garnish.Base.extend({$addLocaleField:null,$addLocaleInput:null,$addLocaleSpinner:null,$resultsSheet:null,$resultsList:null,$activeLocale:null,locales:null,selectedLocales:null,adminTable:null,inputVal:null,showingResultsSheet:!1,init:function(t,n){this.locales={};for(var r in t)this.locales[r]={name:t[r],words:Craft.asciiString(r+" "+t[r]).match(Craft.Locales.wordRegex)};this.selectedLocales=n;this.$addLocaleField=e("#addlocale");this.$addLocaleInput=e("#addlocaleinput");this.$addLocaleSpinner=this.$addLocaleField.find(".spinner");this.adminTable=new Craft.AdminTable({tableSelector:"#locales",sortable:!0,minObjects:1,reorderAction:"localization/reorderLocales",deleteAction:"localization/deleteLocale",confirmDeleteMessage:Craft.t("Are you sure you want to delete “{name}” and all its associated content?"),onDeleteObject:e.proxy(function(t){var n=e.inArray(t,this.selectedLocales);n!=-1&&this.selectedLocales.splice(n,1)},this)});this.addListener(this.$addLocaleInput,"keydown","onKeyDown");this.addListener(this.$addLocaleInput,"focus","onFocus");this.addListener(this.$addLocaleInput,"blur","onBlur")},onKeyDown:function(t){switch(t.keyCode){case Garnish.ESC_KEY:this.$addLocaleInput.val("");this.hideResultsSheet();return;case Garnish.RETURN_KEY:t.preventDefault();this.addSelectedLocale();return;case Garnish.UP_KEY:this.setRelativeActiveLocale("prev");return;case Garnish.DOWN_KEY:this.setRelativeActiveLocale("next");return}setTimeout(e.proxy(this,"checkInputVal"),1)},onFocus:function(){this.inputVal&&this.showResultsSheet()},onBlur:function(){this.hideResultsSheet()},setRelativeActiveLocale:function(e){if(this.$activeLocale){var t=this.$activeLocale.parent()[e]().children("a");if(t.length){this.$activeLocale.removeClass("hover");t.addClass("hover");this.$activeLocale=t}}},checkInputVal:function(){if(this.inputVal!==(this.inputVal=this.$addLocaleInput.val())){var t=this.findMatchingLocales();if(t.length){t=t.sort(function(e,t){return e.length-t.length});this.showResultsSheet();this.$resultsList.html("");for(var n=0;n<t.length;n++){var r=this.locales[t[n]],i=e("<li/>").appendTo(this.$resultsList),s=e('<a data-id="'+t[n]+'">'+r.name+" ("+t[n]+")</a>").appendTo(i);if(n==0){s.addClass("hover");this.$activeLocale=s}}}else{this.hideResultsSheet();this.$activeLocale=null}}},findMatchingLocales:function(){var e=[],t=Craft.asciiString(this.inputVal).match(Craft.Locales.wordRegex);if(t){var n=[];for(var r=0;r<t.length;r++)n.push(new RegExp("^"+t[r],"i"));for(var i in this.locales){if(Craft.inArray(i,this.selectedLocales))continue;var s=!0;for(var r=0;r<n.length;r++){var o=!1;for(var u=0;u<this.locales[i].words.length;u++)if(this.locales[i].words[u].search(n[r])!=-1){o=!0;break}if(!o){s=!1;break}}s&&e.push(i)}}return e},showResultsSheet:function(){if(!this.showingResultsSheet){if(!this.$resultsSheet){this.$resultsSheet=e('<div id="addlocaleresults" class="menu" style="position: relative; margin: 0 1px;"/>').appendTo(this.$addLocaleField);this.$resultsList=e("<ul/>").appendTo(this.$resultsSheet);this.addListener(this.$resultsList,"mousedown","addSelectedLocale")}this.$resultsSheet.show();this.showingResultsSheet=!0}},hideResultsSheet:function(){if(this.showingResultsSheet){this.$resultsSheet.hide();this.showingResultsSheet=!1}},addSelectedLocale:function(t){if(t)var n=e(t.target);else{if(!this.$activeLocale)return;var n=this.$activeLocale}this.hideResultsSheet();this.$addLocaleInput.val(this.$activeLocale.text()).prop("disabled",!0);this.$addLocaleSpinner.removeClass("hidden");var r=n.attr("data-id");Craft.postActionRequest("localization/addLocale",{id:r},e.proxy(function(t,n){this.$addLocaleSpinner.addClass("hidden");if(n=="success")if(t.success){var i=e('<tr data-id="'+r+'" data-name="'+this.locales[r].name+'">'+'<th scope="row" data-title="'+Craft.t("Name")+'" width="40%">'+this.locales[r].name+"</th>"+'<td data-title="'+Craft.t("Locale ID")+'">'+r+"</td>"+'<td class="thin"><a class="move icon" title="'+Craft.t("Reorder")+'"></a></td>'+'<td class="thin"><a class="delete icon" title="'+Craft.t("Delete")+'"></a></td>'+"</tr>");this.adminTable.addRow(i);this.selectedLocales.push(r);this.$addLocaleInput.val("").prop("disabled",!1).trigger("keydown");this.checkInputVal();Craft.cp.displayNotice(Craft.t("New locale added."));Craft.cp.runPendingTasks()}else Craft.cp.displayError(Craft.t("Unable to add the new locale."))},this))}},{wordRegex:new RegExp("[a-zA-Z]+","g")})})(jQuery);