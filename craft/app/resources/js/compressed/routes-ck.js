/*
 Copyright (c) 2014, Pixel & Tonic, Inc.
 @license   http://buildwithcraft.com/license Craft License Agreement
 @link      http://buildwithcraft.com
*/(function(e){var t=Garnish.Base.extend({tokens:null,routes:null,$container:null,$addRouteBtn:null,sorter:null,init:function(){this.tokens={};this.routes=[];this.$container=e("#routes");for(var t=this.getRoutes(),r=0;r<t.length;r++){var i=new n(t[r]);this.routes.push(i)}this.sorter=new Garnish.DragSort(t,{axis:Garnish.Y_AXIS,onSortChange:e.proxy(this,"updateRouteOrder")});this.$addRouteBtn=e("#add-route-btn");this.addListener(this.$addRouteBtn,"click","addRoute")},getRoutes:function(){return this.$container.children()},updateRouteOrder:function(){for(var t=this.getRoutes(),n={},r=0;r<t.length;r++)n["routeIds["+r+"]"]=e(t[r]).attr("data-id");Craft.postActionRequest("routes/updateRouteOrder",n,e.proxy(function(e,t){"success"==t&&(e.success?Craft.cp.displayNotice(Craft.t("New route order saved.")):Craft.cp.displayError(Craft.t("Couldn’t save new route order.")))},this))},addRoute:function(){new r}}),n=Garnish.Base.extend({$container:null,id:null,locale:null,$locale:null,$url:null,$template:null,modal:null,init:function(t){this.$container=e(t);this.id=this.$container.data("id");this.locale=this.$container.data("locale");this.$locale=this.$container.find(".locale:first");this.$url=this.$container.find(".url:first");this.$template=this.$container.find(".template:first");this.addListener(this.$container,"click","edit")},edit:function(){this.modal?this.modal.show():this.modal=new r(this)},updateHtmlFromModal:function(){Craft.routes.locales&&(this.locale?this.$locale.text(this.locale):this.$locale.text(Craft.t("Global")));for(var e="",t=0;t<this.modal.urlInput.elements.length;t++)var n=this.modal.urlInput.elements[t],e=this.modal.urlInput.isText(n)?e+n.val():e+n.prop("outerHTML");this.$url.html(e);this.$template.html(this.modal.$templateInput.val())}}),r=Garnish.Modal.extend({route:null,$heading:null,$urlInput:null,urlElements:null,$templateInput:null,$saveBtn:null,$cancelBtn:null,$spinner:null,$deleteBtn:null,loading:!1,init:function(t){this.route=t;t="<h4>"+Craft.t("Add a token")+"</h4>";for(var n in Craft.routes.tokens)t+='<div class="token" data-name="'+n+'" data-value="'+Craft.routes.tokens[n]+'"><span>'+n+"</span></div>";var r='<form class="modal fitted route-settings" accept-charset="UTF-8"><div class="header"><h1></h1></div><div class="body"><div class="field"><div class="heading"><label for="url">'+Craft.t("If the URI looks like this")+":</label></div>";Craft.routes.locales&&(r+='<table class="inputs fullwidth"><tr><td>');r+='<div id="url" class="text url ltr"></div>';if(Craft.routes.locales){r+='</td><td class="thin"><div class="select"><select class="locale"><option value="">'+Craft.t("Global")+"</option>";for(n=0;n<Craft.routes.locales.length;n++)var i=Craft.routes.locales[n],r=r+('<option value="'+i+'">'+i+"</option>");r+="</select></div></td></tr></table>"}r+='<div class="url-tokens">'+t+'</div></div><div class="field"><div class="heading"><label for="template">'+Craft.t("Load this template")+':</label></div><input id="template" type="text" class="text fullwidth template ltr"></div></div><div class="footer"><div class="buttons right last"><input type="button" class="btn cancel" value="'+Craft.t("Cancel")+'"><input type="submit" class="btn submit" value="'+Craft.t("Save")+'"> <div class="spinner" style="display: none;"></div></div><a class="delete">'+Craft.t("Delete")+"</a></div></form>";t=e(r).appendTo(Garnish.$bod);this.$heading=t.find("h1:first");this.$localeInput=t.find(".locale:first");this.$urlInput=t.find(".url:first");this.$templateInput=t.find(".template:first");this.$saveBtn=t.find(".submit:first");this.$cancelBtn=t.find(".cancel:first");this.$spinner=t.find(".spinner:first");this.$deleteBtn=t.find(".delete:first");this.route||this.$deleteBtn.hide();this.urlInput=new Garnish.MixedInput(this.$urlInput,{dir:"ltr"});this.route?this.$heading.html(Craft.t("Edit Route")):this.$heading.html(Craft.t("Create a new route"));if(this.route){this.$localeInput.val(this.route.locale);r=this.route.$url.prop("childNodes");for(n=0;n<r.length;n++)i=r[n],Garnish.isTextNode(i)?this.urlInput.addTextElement().setVal(i.nodeValue):this.addUrlVar(i);setTimeout(e.proxy(function(){var e=this.urlInput.elements[0];this.urlInput.setFocus(e);this.urlInput.setCarotPos(e,0)},this),1);n=this.route.$template.text();this.$templateInput.val(n)}else setTimeout(e.proxy(function(){this.$urlInput.focus()},this),100);this.base(t);n=this.$container.find(".url-tokens").children("div");this.addListener(n,"mousedown",function(e){this.addUrlVar(e.currentTarget)});this.addListener(this.$container,"submit","saveRoute");this.addListener(this.$cancelBtn,"click","cancel");this.addListener(this.$deleteBtn,"click","deleteRoute")},addUrlVar:function(t){var n=e(t).clone().attr("tabindex","0");this.urlInput.addElement(n);this.addListener(n,"keydown",function(t){switch(t.keyCode){case Garnish.LEFT_KEY:setTimeout(e.proxy(function(){this.urlInput.focusPreviousElement(n)},this),1);break;case Garnish.RIGHT_KEY:setTimeout(e.proxy(function(){this.urlInput.focusNextElement(n)},this),1);break;case Garnish.DELETE_KEY:setTimeout(e.proxy(function(){this.urlInput.removeElement(n)},this),1),t.preventDefault()}})},show:function(){this.route&&(this.$heading.html(Craft.t("Edit Route")),this.$deleteBtn.show());this.base()},saveRoute:function(t){t.preventDefault();if(!this.loading){t={locale:this.$localeInput.val()};this.route&&(t.routeId=this.route.id);for(var r=0;r<this.urlInput.elements.length;r++){var i=this.urlInput.elements[r];this.urlInput.isText(i)?t["url["+r+"]"]=i.val():(t["url["+r+"][0]"]=i.attr("data-name"),t["url["+r+"][1]"]=i.attr("data-value"))}t.template=this.$templateInput.val();this.loading=!0;this.$saveBtn.addClass("active");this.$spinner.show();Craft.postActionRequest("routes/saveRoute",t,e.proxy(function(t,r){this.$saveBtn.removeClass("active");this.$spinner.hide();this.loading=!1;if("success"==r)if(t.success){if(!this.route){var i='<div class="pane route" data-id="'+t.routeId+'"'+(t.locale?' data-locale="'+t.locale+'"':"")+'><div class="url-container">';Craft.routes.locales&&(i+='<span class="locale"></span>');i=e(i+'<span class="url" dir="ltr"></span></div><div class="template" dir="ltr"></div></div>');i.appendTo("#routes");this.route=new n(i);this.route.modal=this;Craft.routes.sorter.addItems(i);1==Craft.routes.sorter.$items.length&&e("#noroutes").addClass("hidden")}this.route.locale=t.locale;this.route.updateHtmlFromModal();this.hide();Craft.cp.displayNotice(Craft.t("Route saved."))}else Craft.cp.displayError(Craft.t("Couldn’t save route."))},this))}},cancel:function(){this.hide();this.route&&(this.route.modal=null)},deleteRoute:function(){confirm(Craft.t("Are you sure you want to delete this route?"))&&(Craft.postActionRequest("routes/deleteRoute",{routeId:this.route.id},function(e,t){"success"==t&&Craft.cp.displayNotice(Craft.t("Route deleted."))}),Craft.routes.sorter.removeItems(this.route.$container),this.route.$container.remove(),this.hide(),0==Craft.routes.sorter.$items.length&&e("#noroutes").removeClass("hidden"))}});Craft.routes=new t})(jQuery);