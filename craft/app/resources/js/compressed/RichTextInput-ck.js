/*
 Copyright (c) 2014, Pixel & Tonic, Inc.
 @license   http://buildwithcraft.com/license Craft License Agreement
 @link      http://buildwithcraft.com
*/(function(e){Craft.RichTextInput=Garnish.Base.extend({id:null,sectionSources:null,elementLocale:null,redactorConfig:null,$textarea:null,redactor:null,init:function(t,n,r,i,s){this.id=t;this.sectionSources=n;this.elementLocale=r;this.redactorConfig=i;this.redactorConfig.lang=s;this.redactorConfig.direction=Craft.orientation;this.$textarea=e("#"+this.id);this.initRedactor();"undefined"!=typeof Craft.livePreview&&(Craft.livePreview.on("beforeEnter beforeExit",e.proxy(function(){this.redactor.destroy()},this)),Craft.livePreview.on("enter slideOut",e.proxy(function(){this.initRedactor()},this)))},initRedactor:function(){this.$textarea.redactor(this.redactorConfig);this.redactor=this.$textarea.data("redactor");this.replaceRedactorButton("image",Craft.t("Insert image"),null,{from_web:{title:Craft.t("Insert URL"),func:"imageShow"},from_assets:{title:Craft.t("Choose image"),callback:function(){this.selectionSave();var t=this;"undefined"==typeof this.assetSelectionModal?this.assetSelectionModal=Craft.createElementSelectorModal("Asset",{storageKey:"RichTextFieldType.ChooseImage",multiSelect:!0,criteria:{locale:this.elementLocale,kind:"image"},onSelect:e.proxy(function(n,r){if(n.length){t.selectionRestore();for(var i=0;i<n.length;i++){var s=n[i],s=s.url+"#asset:"+s.id;r&&(s+=":"+r);t.insertNode(e('<img src="'+s+'" />')[0]);t.sync()}this.observeImages();t.dropdownHideAll()}},this),closeOtherModals:!1,canSelectImageTransforms:!0}):this.assetSelectionModal.show()}}});this.replaceRedactorButton("link",Craft.t("Link"),null,{link_entry:{title:Craft.t("Link to an entry"),callback:function(){this.selectionSave();var t=this;"undefined"==typeof this.entrySelectionModal?this.entrySelectionModal=Craft.createElementSelectorModal("Entry",{storageKey:"RichTextFieldType.LinkToEntry",sources:this.sectionSources,criteria:{locale:this.elementLocale},onSelect:function(n){if(n.length){t.selectionRestore();n=n[0];var r=n.url+"#entry:"+n.id,i=t.getSelectionText();t.insertNode(e('<a href="'+r+'">'+(0<i.length?i:n.label)+"</a>")[0]);t.sync()}t.dropdownHideAll()},closeOtherModals:!1}):this.entrySelectionModal.show()}},link_asset:{title:Craft.t("Link to an asset"),callback:function(){this.selectionSave();var t=this;"undefined"==typeof this.assetLinkSelectionModal?this.assetLinkSelectionModal=Craft.createElementSelectorModal("Asset",{storageKey:"RichTextFieldType.LinkToAsset",criteria:{locale:this.elementLocale},onSelect:function(n){if(n.length){t.selectionRestore();n=n[0];var r=n.url+"#asset:"+n.id,i=t.getSelectionText();t.insertNode(e('<a href="'+r+'">'+(0<i.length?i:n.label)+"</a>")[0]);t.sync()}t.dropdownHideAll()},closeOtherModals:!1,canSelectImageTransforms:!0}):this.assetLinkSelectionModal.show()}},link:{title:Craft.t("Insert link"),func:"linkShow"},unlink:{title:Craft.t("Unlink"),exec:"unlink"}});"undefined"!=typeof this.redactor.fullscreen&&"function"==typeof this.redactor.toggleFullscreen&&Craft.cp.on("beforeSaveShortcut",e.proxy(function(){this.redactor.fullscreen&&this.redactor.toggleFullscreen()},this))},replaceRedactorButton:function(e,t,n,r){if(this.redactor.buttonGet(e).length){var i=e+"_placeholder";this.redactor.buttonAddAfter(e,i);this.redactor.buttonRemove(e);this.redactor.buttonAddAfter(i,e,t,n,r);this.redactor.buttonRemove(i)}}})})(jQuery);