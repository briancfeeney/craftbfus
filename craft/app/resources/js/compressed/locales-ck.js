/*
 Copyright (c) 2014, Pixel & Tonic, Inc.
 @license   http://buildwithcraft.com/license Craft License Agreement
 @link      http://buildwithcraft.com
*/(function(e){Craft.Locales=Garnish.Base.extend({$addLocaleField:null,$addLocaleInput:null,$addLocaleSpinner:null,$resultsSheet:null,$resultsList:null,$activeLocale:null,locales:null,selectedLocales:null,adminTable:null,inputVal:null,showingResultsSheet:!1,init:function(t,n){this.locales={};for(var r in t)this.locales[r]={name:t[r],words:Craft.asciiString(r+" "+t[r]).match(Craft.Locales.wordRegex)};this.selectedLocales=n;this.$addLocaleField=e("#addlocale");this.$addLocaleInput=e("#addlocaleinput");this.$addLocaleSpinner=this.$addLocaleField.find(".spinner");this.adminTable=new Craft.AdminTable({tableSelector:"#locales",sortable:!0,minObjects:1,reorderAction:"localization/reorderLocales",deleteAction:"localization/deleteLocale",confirmDeleteMessage:Craft.t("Are you sure you want to delete “{name}” and all its associated content?"),onDeleteObject:e.proxy(function(t){t=e.inArray(t,this.selectedLocales);-1!=t&&this.selectedLocales.splice(t,1)},this)});this.addListener(this.$addLocaleInput,"keydown","onKeyDown");this.addListener(this.$addLocaleInput,"focus","onFocus");this.addListener(this.$addLocaleInput,"blur","onBlur")},onKeyDown:function(t){switch(t.keyCode){case Garnish.ESC_KEY:this.$addLocaleInput.val("");this.hideResultsSheet();return;case Garnish.RETURN_KEY:t.preventDefault();this.addSelectedLocale();return;case Garnish.UP_KEY:this.setRelativeActiveLocale("prev");return;case Garnish.DOWN_KEY:this.setRelativeActiveLocale("next");return}setTimeout(e.proxy(this,"checkInputVal"),1)},onFocus:function(){this.inputVal&&this.showResultsSheet()},onBlur:function(){this.hideResultsSheet()},setRelativeActiveLocale:function(e){this.$activeLocale&&(e=this.$activeLocale.parent()[e]().children("a"),e.length&&(this.$activeLocale.removeClass("hover"),e.addClass("hover"),this.$activeLocale=e))},checkInputVal:function(){if(this.inputVal!==(this.inputVal=this.$addLocaleInput.val())){var t=this.findMatchingLocales();if(t.length){t=t.sort(function(e,t){return e.length-t.length});this.showResultsSheet();this.$resultsList.html("");for(var n=0;n<t.length;n++){var r=this.locales[t[n]],i=e("<li/>").appendTo(this.$resultsList),r=e('<a data-id="'+t[n]+'">'+r.name+" ("+t[n]+")</a>").appendTo(i);0==n&&(r.addClass("hover"),this.$activeLocale=r)}}else this.hideResultsSheet(),this.$activeLocale=null}},findMatchingLocales:function(){var e=[],t=Craft.asciiString(this.inputVal).match(Craft.Locales.wordRegex);if(t){for(var n=[],r=0;r<t.length;r++)n.push(RegExp("^"+t[r],"i"));for(var i in this.locales)if(!Craft.inArray(i,this.selectedLocales)){t=!0;for(r=0;r<n.length;r++){for(var s=!1,o=0;o<this.locales[i].words.length;o++)if(-1!=this.locales[i].words[o].search(n[r])){s=!0;break}if(!s){t=!1;break}}t&&e.push(i)}}return e},showResultsSheet:function(){this.showingResultsSheet||(this.$resultsSheet||(this.$resultsSheet=e('<div id="addlocaleresults" class="menu" style="position: relative; margin: 0 1px;"/>').appendTo(this.$addLocaleField),this.$resultsList=e("<ul/>").appendTo(this.$resultsSheet),this.addListener(this.$resultsList,"mousedown","addSelectedLocale")),this.$resultsSheet.show(),this.showingResultsSheet=!0)},hideResultsSheet:function(){this.showingResultsSheet&&(this.$resultsSheet.hide(),this.showingResultsSheet=!1)},addSelectedLocale:function(t){if(t)t=e(t.target);else{if(!this.$activeLocale)return;t=this.$activeLocale}this.hideResultsSheet();this.$addLocaleInput.val(this.$activeLocale.text()).prop("disabled",!0);this.$addLocaleSpinner.removeClass("hidden");var n=t.attr("data-id");Craft.postActionRequest("localization/addLocale",{id:n},e.proxy(function(t,r){this.$addLocaleSpinner.addClass("hidden");if("success"==r)if(t.success){var i=e('<tr data-id="'+n+'" data-name="'+this.locales[n].name+'"><th scope="row" data-title="'+Craft.t("Name")+'" width="40%">'+this.locales[n].name+'</th><td data-title="'+Craft.t("Locale ID")+'">'+n+'</td><td class="thin"><a class="move icon" title="'+Craft.t("Reorder")+'"></a></td><td class="thin"><a class="delete icon" title="'+Craft.t("Delete")+'"></a></td></tr>');this.adminTable.addRow(i);this.selectedLocales.push(n);this.$addLocaleInput.val("").prop("disabled",!1).trigger("keydown");this.checkInputVal();Craft.cp.displayNotice(Craft.t("New locale added."));Craft.cp.runPendingTasks()}else Craft.cp.displayError(Craft.t("Unable to add the new locale."))},this))}},{wordRegex:RegExp("[a-zA-Z]+","g")})})(jQuery);