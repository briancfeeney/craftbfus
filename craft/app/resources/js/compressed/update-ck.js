/*
 Copyright (c) 2014, Pixel & Tonic, Inc.
 @license   http://buildwithcraft.com/license Craft License Agreement
 @link      http://buildwithcraft.com
*/(function(e){Craft.Updater=Garnish.Base.extend({$graphic:null,$status:null,$errorDetails:null,data:null,init:function(t,n){this.$graphic=e("#graphic");this.$status=e("#status");t?(this.data={handle:t,manualUpdate:n},this.postActionRequest("update/prepare")):this.showError(Craft.t("Unable to determine what to update."))},updateStatus:function(e){this.$status.html(e)},showError:function(e){this.updateStatus(e);this.$graphic.addClass("error")},postActionRequest:function(t){Craft.postActionRequest(t,{data:this.data},e.proxy(function(e,t,n){"success"==t&&e.alive?this.onSuccessResponse(e):this.onErrorResponse(n)},this),{complete:e.noop})},onSuccessResponse:function(e){e.data&&(this.data=e.data);e.errorDetails&&(this.$errorDetails=e.errorDetails);e.nextStatus&&this.updateStatus(e.nextStatus);e.nextAction&&this.postActionRequest(e.nextAction);if(e.finished){var t=!1;e.rollBack&&(t=!0);this.onFinish(e.returnUrl,t)}},onErrorResponse:function(e){this.$graphic.addClass("error");e=Craft.t("An error has occurred.  Please contact {email} and be sure to include the error message.",{email:'<a href="mailto:support@buildwithcraft.com?subject=Craft+Update+Failure">support@buildwithcraft.com</a>'})+"<br /><p>"+e.statusText+"</p><br /><p>"+e.responseText+"</p>";this.updateStatus(e)},onFinish:function(e,t){if(this.$errorDetails){this.$graphic.addClass("error");var n=Craft.t("Craft was unable to install this update :(")+"<br /><p>",n=t?n+(Craft.t("The site has been restored to the state it was in before the attempted update.")+"</p><br /><p>"):n+(Craft.t("No files have been updated and the database has not been touched.")+"</p><br /><p>"),n=n+(this.$errorDetails+"</p>");this.updateStatus(n)}else this.updateStatus(Craft.t("All done!")),this.$graphic.addClass("success"),setTimeout(function(){window.location=e?Craft.getUrl(e):Craft.getUrl("dashboard")},500)}})})(jQuery);