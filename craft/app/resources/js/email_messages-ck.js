/**
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2014, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */(function(e){var t=Garnish.Base.extend({messages:null,init:function(){this.messages=[];var t=e("#messages"),r=t.find(".message");for(var i=0;i<r.length;i++){var s=new n(r[i]);this.messages.push(s)}}}),n=Garnish.Base.extend({$container:null,key:null,$subject:null,$body:null,modal:null,init:function(t){this.$container=e(t);this.key=this.$container.attr("data-key");this.$subject=this.$container.find(".subject:first");this.$body=this.$container.find(".body:first");this.addListener(this.$container,"click","edit")},edit:function(){this.modal?this.modal.show():this.modal=new r(this)},updateHtmlFromModal:function(){var e=this.modal.$subjectInput.val(),t=this.modal.$bodyInput.val().replace(/\n/g,"<br>");this.$subject.html(e);this.$body.html(t)}}),r=Garnish.Modal.extend({message:null,$localeSelect:null,$subjectInput:null,$bodyInput:null,$saveBtn:null,$cancelBtn:null,$spinner:null,loading:!1,init:function(e){this.message=e;this.base(null,{resizable:!0});this.loadContainer()},loadContainer:function(t){var n={key:this.message.key,locale:t};e.post(Craft.getUrl("settings/email/_message_modal"),n,e.proxy(function(t,n,r){if(n=="success"){if(!this.$container){var i=e('<form class="modal fitted message-settings" accept-charset="UTF-8">'+t+"</form>").appendTo(Garnish.$bod);this.setContainer(i);this.show()}else this.$container.html(t);this.$localeSelect=this.$container.find(".locale:first > select");this.$subjectInput=this.$container.find(".message-subject:first");this.$bodyInput=this.$container.find(".message-body:first");this.$saveBtn=this.$container.find(".submit:first");this.$cancelBtn=this.$container.find(".cancel:first");this.$spinner=this.$container.find(".spinner:first");this.addListener(this.$localeSelect,"change","switchLocale");this.addListener(this.$container,"submit","saveMessage");this.addListener(this.$cancelBtn,"click","cancel");setTimeout(e.proxy(function(){this.$subjectInput.focus()},this),100)}},this))},switchLocale:function(){var e=this.$localeSelect.val();this.loadContainer(e)},saveMessage:function(t){t.preventDefault();if(this.loading)return;var n={key:this.message.key,locale:this.$localeSelect.length?this.$localeSelect.val():Craft.locale,subject:this.$subjectInput.val(),body:this.$bodyInput.val()};this.$subjectInput.removeClass("error");this.$bodyInput.removeClass("error");if(!n.subject||!n.body){n.subject||this.$subjectInput.addClass("error");n.body||this.$bodyInput.addClass("error");Garnish.shake(this.$container);return}this.loading=!0;this.$saveBtn.addClass("active");this.$spinner.show();Craft.postActionRequest("emailMessages/saveMessage",n,e.proxy(function(e,t){this.$saveBtn.removeClass("active");this.$spinner.hide();this.loading=!1;if(t=="success")if(e.success){n.locale==Craft.locale&&this.message.updateHtmlFromModal();this.hide();Craft.cp.displayNotice(Craft.t("Message saved."))}else Craft.cp.displayError()},this))},cancel:function(){this.hide();this.message&&(this.message.modal=null)}});new t})(jQuery);