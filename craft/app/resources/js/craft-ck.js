/**
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2014, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */(function(e){typeof Craft=="undefined"&&(Craft={});e.extend(Craft,{navHeight:48,asciiCharMap:{223:"ss",224:"a",225:"a",226:"a",229:"a",227:"ae",230:"ae",228:"ae",231:"c",232:"e",233:"e",234:"e",235:"e",236:"i",237:"i",238:"i",239:"i",241:"n",242:"o",243:"o",244:"o",245:"o",246:"oe",249:"u",250:"u",251:"u",252:"ue",255:"y",257:"aa",269:"ch",275:"ee",291:"gj",299:"ii",311:"kj",316:"lj",326:"nj",353:"sh",363:"uu",382:"zh",256:"aa",268:"ch",274:"ee",290:"gj",298:"ii",310:"kj",315:"lj",325:"nj",352:"sh",362:"uu",381:"zh"},t:function(e,t){typeof Craft.translations[e]!="undefined"&&(e=Craft.translations[e]);if(t)for(var n in t)e=e.replace("{"+n+"}",t[n]);return e},escapeHtml:function(t){return e("<div/>").text(t).html()},getText:function(t){return e("<div/>").html(t).text()},encodeUriComponent:function(e){e=encodeURIComponent(e);var t={"!":"%21","*":"%2A","'":"%27","(":"%28",")":"%29"};for(var n in t){var r=new RegExp("\\"+n,"g");e=e.replace(r,t[n])}return e},formatInputId:function(e){return this.rtrim(e.replace(/[\[\]]+/g,"-"),"-")},getUrl:function(t,n,r){typeof t!="string"&&(t="");if(t.search("://")!=-1||t.substr(0,2)=="//")return t;t=Craft.trim(t,"/");var i="";if(e.isPlainObject(n)){var s=[];for(var o in n){var u=n[o];o=="#"?i=u:u!==null&&u!==""&&s.push(o+"="+u)}n=s}Garnish.isArray(n)?n=n.join("&"):n=Craft.trim(n,"&?");var a=t.indexOf("?");if(a!=-1){n=t.substr(a+1)+(n?"&"+n:"");t=t.substr(0,a)}if(r){var f=r;if(t){var l=f.match(/[&\?]p=[^&]+/);if(l){f=f.replace(l[0],l[0]+"/"+t);t=""}}}else var f=Craft.baseUrl;var a=f.indexOf("?");if(a!="-1"){n=f.substr(a+1)+(n?"&"+n:"");f=f.substr(0,a)}if(!Craft.omitScriptNameInUrls&&t)if(Craft.usePathInfo)f.search(Craft.scriptName)==-1&&(f=Craft.rtrim(f,"/")+"/"+Craft.scriptName);else{if(n&&n.substr(0,2)=="p="){var c=n.indexOf("&");if(c!=-1){var h=n.substring(2,c);n=n.substr(c+1)}else{var h=n.substr(2);n=null}h=Craft.rtrim(h);t=h+(t?"/"+t:"")}n="p="+t+(n?"&"+n:"");t=null}t&&(f=Craft.rtrim(f,"/")+"/"+t);n&&(f+="?"+n);i&&(f+="#"+i);return f},getCpUrl:function(e,t){return this.getUrl(e,t,Craft.baseCpUrl)},getSiteUrl:function(e,t){return this.getUrl(e,t,Craft.baseSiteUrl)},getResourceUrl:function(e,t){return Craft.getUrl(e,t,Craft.resourceUrl)},getActionUrl:function(e,t){return Craft.getUrl(e,t,Craft.actionUrl)},redirectTo:function(e){document.location.href=this.getUrl(e)},postActionRequest:function(t,n,r,i){if(typeof n=="function"){i=r;r=n;n=undefined}var s=e.ajax(e.extend({url:Craft.getActionUrl(t),type:"POST",data:n,success:r,error:function(e,t,n){r&&r(null,t,e)},complete:function(e,t){t!="success"&&(typeof Craft.cp!="undefined"?Craft.cp.displayError():alert(Craft.t("An unknown error occurred.")))}},i));i&&typeof i.send=="function"&&i.send(s);return s},_waitingOnAjax:!1,_ajaxQueue:[],queueActionRequest:function(e,t,n,r){if(typeof t=="function"){r=n;n=t;t=undefined}Craft._ajaxQueue.push([e,t,n,r]);Craft._waitingOnAjax||Craft._postNextActionRequestInQueue()},_postNextActionRequestInQueue:function(){Craft._waitingOnAjax=!0;var e=Craft._ajaxQueue.shift();Craft.postActionRequest(e[0],e[1],function(t,n,r){e[2]&&typeof e[2]=="function"&&e[2](t,n,r);Craft._ajaxQueue.length?Craft._postNextActionRequestInQueue():Craft._waitingOnAjax=!1},e[3])},stringToArray:function(t){if(typeof t!="string")return t;var n=t.split(",");for(var r=0;r<n.length;r++)n[r]=e.trim(n[r]);return n},expandPostArray:function(e){var t={};for(var n in e){var r=e[n],i=n.match(/^(\w+)(\[.*)?/);if(i[2]){var s=i[2].match(/\[[^\[\]]*\]/g);for(var o=0;o<s.length;o++)s[o]=s[o].substring(1,s[o].length-1)}else var s=[];s.unshift(i[1]);var u=t;for(var o=0;o<s.length;o++)if(o<s.length-1){typeof u[s[o]]!="object"&&(!s[o+1]||parseInt(s[o+1])==s[o+1]?u[s[o]]=[]:u[s[o]]={});u=u[s[o]]}else{s[o]||(s[o]=u.length);u[s[o]]=r}}return t},compare:function(e,t){if(typeof e!=typeof t)return!1;if(typeof e=="object"){if(e.length!=t.length)return!1;if(e instanceof Array!=t instanceof Array)return!1;if(e instanceof Array||!!Craft.compare(Craft.getObjectKeys(e),Craft.getObjectKeys(t))){for(var n in e)if(!Craft.compare(e[n],t[n]))return!1;return!0}return!1}return e===t},getObjectKeys:function(e){var t=[];for(var n in e)t.push(n);return t},escapeChars:function(e){Garnish.isArray(e)||(e=e.split());var t="";for(var n=0;n<e.length;n++)t+="\\"+e[n];return t},ltrim:function(e,t){if(!e)return e;t===undefined&&(t=" 	\n\r\0");var n=new RegExp("^["+Craft.escapeChars(t)+"]+");return e.replace(n,"")},rtrim:function(e,t){if(!e)return e;t===undefined&&(t=" 	\n\r\0");var n=new RegExp("["+Craft.escapeChars(t)+"]+$");return e.replace(n,"")},trim:function(e,t){e=Craft.ltrim(e,t);e=Craft.rtrim(e,t);return e},filterArray:function(e,t){var n=[];for(var r=0;r<e.length;r++){if(typeof t=="function")var i=t(e[r],r);else var i=e[r];i&&n.push(e[r])}return n},inArray:function(t,n){return e.inArray(t,n)!=-1},removeFromArray:function(t,n){var r=e.inArray(t,n);if(r!=-1){n.splice(r,1);return!0}return!1},getLast:function(e){return e.length?e[e.length-1]:null},uppercaseFirst:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},lowercaseFirst:function(e){return e.charAt(0).toLowerCase()+e.slice(1)},asciiString:function(e){var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r>=32&&r<128?t+=e.charAt(n):typeof Craft.asciiCharMap[r]!="undefined"&&(t+=Craft.asciiCharMap[r])}return t},preventOutlineOnMouseFocus:function(t){var n=e(t),r=".preventOutlineOnMouseFocus";n.on("mousedown"+r,function(){n.addClass("no-outline");n.focus()}).on("keydown"+r+" blur"+r,function(e){e.keyCode!=Garnish.SHIFT_KEY&&e.keyCode!=Garnish.CTRL_KEY&&e.keyCode!=Garnish.CMD_KEY&&n.removeClass("no-outline")})},createErrorList:function(t){var n=e(document.createElement("ul")).addClass("errors");for(var r=0;r<t.length;r++){var i=e(document.createElement("li"));i.appendTo(n);i.html(t[r])}return n},initUiElements:function(t){e(".grid",t).grid();e(".pane",t).pane();e(".info",t).infoicon();e(".checkbox-select",t).checkboxselect();e(".fieldtoggle",t).fieldtoggle();e(".lightswitch",t).lightswitch();e(".nicetext",t).nicetext();e(".pill",t).pill();e(".menubtn",t).menubtn();e("input[type!=password], textarea",t).placeholder()},_elementIndexClasses:{},_elementSelectorModalClasses:{},registerElementIndexClass:function(e,t){if(typeof this._elementIndexClasses[e]!="undefined")throw"An element index class has already been registered for the element type “"+e+"”.";this._elementIndexClasses[e]=t},registerElementSelectorModalClass:function(e,t){if(typeof this._elementSelectorModalClasses[e]!="undefined")throw"An element selector modal class has already been registered for the element type “"+e+"”.";this._elementSelectorModalClasses[e]=t},createElementIndex:function(e,t,n){if(typeof this._elementIndexClasses[e]!="undefined")var r=this._elementIndexClasses[e];else var r=Craft.BaseElementIndex;return new r(e,t,n)},createElementSelectorModal:function(e,t){if(typeof this._elementSelectorModalClasses[e]!="undefined")var n=this._elementSelectorModalClasses[e];else var n=Craft.BaseElementSelectorModal;return new n(e,t)},getLocalStorage:function(e,t){e="Craft-"+Craft.siteUid+"."+e;return typeof localStorage!="undefined"&&typeof localStorage[e]!="undefined"?JSON.parse(localStorage[e]):t},setLocalStorage:function(e,t){if(typeof localStorage!="undefined"){e="Craft-"+Craft.siteUid+"."+e;localStorage[e]=JSON.stringify(t)}},getElementInfo:function(t){var n=e(t);n.hasClass("element")||(n=n.find(".element:first"));var r={id:n.data("id"),label:n.data("label"),status:n.data("status"),url:n.data("url"),hasThumb:n.hasClass("hasthumb"),$element:n};return r},showElementEditor:function(e){e.data("editable")&&!e.hasClass("disabled")&&!e.hasClass("loading")&&new Craft.ElementEditor(e)}});e.extend(e.fn,{animateLeft:function(e,t,n,r){return Craft.orientation=="ltr"?this.animate({left:e},t,n,r):this.animate({right:e},t,n,r)},animateRight:function(e,t,n,r){return Craft.orientation=="ltr"?this.animate({right:e},t,n,r):this.animate({left:e},t,n,r)},disable:function(){return this.each(function(){var t=e(this);t.addClass("disabled");t.data("activatable")&&t.removeAttr("tabindex")})},enable:function(){return this.each(function(){var t=e(this);t.removeClass("disabled");t.data("activatable")&&t.attr("tabindex","0")})},grid:function(){return this.each(function(){var t=e(this),n={};t.data("item-selector")&&(n.itemSelector=t.data("item-selector"));t.data("cols")&&(n.cols=parseInt(t.data("cols")));t.data("min-col-width")&&(n.minColWidth=parseInt(t.data("min-col-width")));t.data("mode")&&(n.mode=t.data("mode"));t.data("fill-mode")&&(n.fillMode=t.data("fill-mode"));t.data("col-class")&&(n.colClass=t.data("col-class"));t.data("snap-to-grid")&&(n.snapToGrid=!!t.data("snap-to-grid"));new Craft.Grid(this,n)})},infoicon:function(){return this.each(function(){new Craft.InfoIcon(this)})},pane:function(){return this.each(function(){new Craft.Pane(this)})},checkboxselect:function(){return this.each(function(){e.data(this,"checkboxselect")||new Garnish.CheckboxSelect(this)})},fieldtoggle:function(){return this.each(function(){e.data(this,"fieldtoggle")||new Craft.FieldToggle(this)})},lightswitch:function(t,n,r){if(t=="settings"){if(typeof n=="string"){t={};t[n]=r}else t=n;return this.each(function(){var n=e.data(this,"lightswitch");n&&n.setSettings(t)})}return this.each(function(){e.data(this,"lightswitch")||new Craft.LightSwitch(this,t)})},nicetext:function(){return this.each(function(){e.data(this,"text")||new Garnish.NiceText(this)})},pill:function(){return this.each(function(){e.data(this,"pill")||new Garnish.Pill(this)})},menubtn:function(){return this.each(function(){var t=e(this);!t.data("menubtn")&&t.next().hasClass("menu")&&new Garnish.MenuBtn(t)})}});Garnish.$doc.ready(function(){Craft.initUiElements()});Craft.BaseElementIndex=Garnish.Base.extend({elementType:null,instanceState:null,sourceStates:null,sourceStatesStorageKey:null,searchTimeout:null,elementSelect:null,sourceSelect:null,$container:null,$main:null,$scroller:null,$toolbar:null,$search:null,$mainSpinner:null,$statusMenuBtn:null,statusMenu:null,status:null,$localeMenuBtn:null,localeMenu:null,locale:null,$viewModeBtnTd:null,$viewModeBtnContainer:null,viewModeBtns:null,viewMode:null,$loadingMoreSpinner:null,$sidebar:null,$sidebarButtonContainer:null,showingSidebar:null,$sources:null,sourceKey:null,sourceViewModes:null,$source:null,$sourceToggles:null,$elements:null,$table:null,$elementContainer:null,init:function(t,n,r){this.elementType=t;this.$container=n;this.setSettings(r,Craft.BaseElementIndex.defaults);this.instanceState={selectedSource:null};this.sourceStates={};this.settings.storageKey&&e.extend(this.instanceState,Craft.getLocalStorage(this.settings.storageKey),{});this.sourceStatesStorageKey="BaseElementIndex."+this.elementType+"."+this.settings.context;e.extend(this.sourceStates,Craft.getLocalStorage(this.sourceStatesStorageKey,{}));this.$main=this.$container.find(".main");this.$toolbar=this.$container.find(".toolbar:first");this.$statusMenuBtn=this.$toolbar.find(".statusmenubtn:first");this.$localeMenuBtn=this.$toolbar.find(".localemenubtn:first");this.$search=this.$toolbar.find(".search:first input:first");this.$mainSpinner=this.$toolbar.find(".spinner:first");this.$loadingMoreSpinner=this.$container.find(".spinner.loadingmore");this.$sidebar=this.$container.find(".sidebar:first");this.$sidebarButtonContainer=this.$sidebar.children(".buttons");this.$sources=this.$sidebar.find("nav a");this.$sourceToggles=this.$sidebar.find(".toggle");this.$elements=this.$container.find(".elements:first");this.$sidebarButtonContainer.length||(this.$sidebarButtonContainer=e('<div class="buttons"/>').prependTo(this.$sidebar));this.showingSidebar=this.$sidebar.length&&!this.$sidebar.hasClass("hidden");this.$viewModeBtnTd=this.$toolbar.find(".viewbtns:first");this.$viewModeBtnContainer=e('<div class="btngroup"/>').appendTo(this.$viewModeBtnTd);if(this.$sources.length==0)return;if(this.$localeMenuBtn.length){this.localeMenu=this.$localeMenuBtn.menubtn().data("menubtn").menu;var i=this.localeMenu.$options.filter(".sel:first");i.length||(i=this.localeMenu.$options.first());i.length?this.locale=i.data("locale"):this.settings.criteria={id:"0"};this.localeMenu.on("optionselect",e.proxy(this,"onLocaleChange"))}this.onAfterHtmlInit();this.settings.context=="index"?this.$scroller=Garnish.$win:this.$scroller=this.$main;var s=this.getDefaultSourceKey();if(s){var o=this.getSourceByKey(s);if(o){var u=o.parentsUntil(".sidebar","li");u.not(":first").addClass("expanded")}}if(!s||!o)var o=this.$sources.first();this.selectSource(o);this.updateElements();this.addListener(this.$sourceToggles,"click",function(t){e(t.currentTarget).parent().toggleClass("expanded");this.$sidebar.trigger("resize");t.stopPropagation()});this.sourceSelect=new Garnish.Select(this.$sidebar.find("nav"),this.$sources,{selectedClass:"sel",multi:!1,vertical:!0,onSelectionChange:e.proxy(this,"onSourceSelectionChange")});if(this.$statusMenuBtn.length){this.statusMenu=this.$statusMenuBtn.menubtn().data("menubtn").menu;this.statusMenu.on("optionselect",e.proxy(this,"onStatusChange"))}this.addListener(this.$search,"textchange",e.proxy(function(){this.searchTimeout&&clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(e.proxy(this,"updateElements"),500)},this));Garnish.isMobileBrowser(!0)||this.$search.focus()},getDefaultSourceKey:function(){return this.instanceState.selectedSource},onSourceSelectionChange:function(){var e=this.$sources.filter(".sel");e.length==0&&(e=this.$sources.filter(":first"));this.selectSource(e);this.updateElements()},setInstanceState:function(t,n){typeof t=="object"?e.extend(this.instanceState,t):this.instanceState[t]=n;this.settings.storageKey&&Craft.setLocalStorage(this.settings.storageKey,this.instanceState)},getSourceState:function(e,t,n){typeof this.sourceStates[e]=="undefined"&&(this.sourceStates[e]={});return typeof t=="undefined"?this.sourceStates[e]:typeof this.sourceStates[e][t]!="undefined"?this.sourceStates[e][t]:typeof n!="undefined"?n:null},getSelectedSourceState:function(e,t){return this.getSourceState(this.instanceState.selectedSource,e,t)},setSelecetedSourceState:function(t,n){var r=this.getSelectedSourceState();typeof t=="object"?e.extend(r,t):r[t]=n;this.sourceStates[this.instanceState.selectedSource]=r;Craft.setLocalStorage(this.sourceStatesStorageKey,this.sourceStates)},getControllerData:function(){return{context:this.settings.context,elementType:this.elementType,criteria:e.extend({status:this.status,locale:this.locale},this.settings.criteria),disabledElementIds:this.settings.disabledElementIds,source:this.instanceState.selectedSource,status:this.status,viewState:this.getSelectedSourceState(),search:this.$search?this.$search.val():null}},updateElements:function(){this.$mainSpinner.removeClass("hidden");this.removeListener(this.$scroller,"scroll");this.getSelectedSourceState("mode")=="table"&&this.$table&&(Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.not(this.$table));this.$search&&this.$search.val()?this.getSelectedSourceState("mode")=="structure"&&this.selectViewMode("table",!0):this.getSelectedSourceState("mode")=="table"&&!this.doesSourceHaveViewMode("table")&&this.selectViewMode(this.sourceViewModes[0].mode,!0);var t=this.getControllerData();Craft.postActionRequest("elements/getElements",t,e.proxy(function(e,t){this.$mainSpinner.addClass("hidden");t=="success"&&this.setNewElementDataHtml(e,!1)},this))},setNewElementDataHtml:function(t,n){if(!n){this.$elements.html(t.html);this.$scroller.scrollTop(0);if(this.getSelectedSourceState("mode")=="table"){var r=this.$elements.find("thead:first th");this.addListener(r,"click","onSortChange");this.$table=this.$elements.find("table:first");Craft.cp.$collapsibleTables=Craft.cp.$collapsibleTables.add(this.$table)}this.$elementContainer=this.getElementContainer()}else this.$elementContainer.append(t.html);e("head").append(t.headHtml);Garnish.$bod.append(t.footHtml);if(t.more){this.totalVisible=t.totalVisible;this.addListener(this.$scroller,"scroll",function(){if(this.$scroller[0]==Garnish.$win[0])var t=Garnish.$win.innerHeight(),n=Garnish.$win.scrollTop(),r=Garnish.$bod.height(),i=t+n>=r;else{var s=this.$scroller.prop("scrollHeight"),o=this.$scroller.scrollTop(),u=this.$scroller.outerHeight(),i=s-o<=u+15;console.log(s,o,u,i)}if(i){this.$loadingMoreSpinner.removeClass("hidden");this.removeListener(this.$scroller,"scroll");var a=this.getControllerData();a.offset=this.totalVisible;Craft.postActionRequest("elements/getElements",a,e.proxy(function(e,t){this.$loadingMoreSpinner.addClass("hidden");t=="success"&&this.setNewElementDataHtml(e,!0)},this))}})}this.getSelectedSourceState("mode")=="table"&&Craft.cp.updateResponsiveTables();this.onUpdateElements(n)},getElementContainer:function(){return this.getSelectedSourceState("mode")=="table"?this.$table.find("tbody:first"):this.$elements.children("ul")},onUpdateElements:function(e){this.settings.onUpdateElements(e)},onStatusChange:function(t){this.statusMenu.$options.removeClass("sel");var n=e(t.selectedOption).addClass("sel");this.$statusMenuBtn.html(n.html());this.status=n.data("status");this.updateElements()},onLocaleChange:function(t){this.localeMenu.$options.removeClass("sel");var n=e(t.selectedOption).addClass("sel");this.$localeMenuBtn.html(n.html());this.locale=n.data("locale");this.updateElements()},onSortChange:function(t){var n=e(t.currentTarget),r=n.attr("data-attribute");this.getSelectedSourceState("order")==r?this.getSelectedSourceState("sort")=="asc"?this.setSelecetedSourceState("sort","desc"):this.setSelecetedSourceState("sort","asc"):this.setSelecetedSourceState({order:r,sort:"asc"});this.updateElements()},getSourceByKey:function(t){for(var n=0;n<this.$sources.length;n++){var r=e(this.$sources[n]);if(r.data("key")==t)return r}},selectSource:function(t){if(this.$source==t)return;this.$source&&this.$source.removeClass("sel");this.sourceKey=t.data("key");this.$source=t.addClass("sel");this.setInstanceState("selectedSource",this.sourceKey);if(this.$search){this.$search.data("textchangeValue","");this.$search.val("")}this.$viewModeBtnContainer.empty();this.viewModeBtns={};this.viewMode=null;this.sourceViewModes=this.getViewModesForSource();if(this.sourceViewModes.length>1){this.$viewModeBtnTd.removeClass("hidden");for(var n=0;n<this.sourceViewModes.length;n++){var r=this.sourceViewModes[n],i=e('<div data-view="'+r.mode+'" role="button"'+' class="btn'+(typeof r.className!="undefined"?" "+r.className:"")+'"'+' title="'+r.title+'"'+(typeof r.icon!="undefined"?' data-icon="'+r.icon+'"':"")+"/>").appendTo(this.$viewModeBtnContainer);this.viewModeBtns[r.mode]=i;this.addListener(i,"click",{mode:r.mode},function(e){this.selectViewMode(e.data.mode);this.updateElements()})}}else this.$viewModeBtnTd.addClass("hidden");var r=this.getSelectedSourceState("mode");if(!r||!this.doesSourceHaveViewMode(r))this.$source.data("has-structure")?r="structure":this.viewMode&&this.doesSourceHaveViewMode(this.viewMode)?r=this.viewMode:r=this.sourceViewModes[0].mode;this.selectViewMode(r);this.onSelectSource()},getViewModesForSource:function(){var e=[{mode:"table",title:Craft.t("Display in a table"),icon:"list"}];this.$source.data("has-structure")&&e.push({mode:"structure",title:Craft.t("Display hierarchically"),icon:"structure"});this.$source.data("has-thumbs")&&e.push({mode:"thumbs",title:Craft.t("Display as thumbnails"),icon:"grid"});return e},onSelectSource:function(){this.settings.onSelectSource(this.sourceKey)},onAfterHtmlInit:function(){this.settings.onAfterHtmlInit()},doesSourceHaveViewMode:function(e){for(var t=0;t<this.sourceViewModes.length;t++)if(this.sourceViewModes[t].mode==e)return!0;return!1},selectViewMode:function(e,t){!t&&!this.doesSourceHaveViewMode(e)&&(e=this.sourceViewModes[0].mode);if(e==this.viewMode)return;this.viewMode&&typeof this.viewModeBtns[this.viewMode]!="undefined"&&this.viewModeBtns[this.viewMode].removeClass("active");this.viewMode=e;this.setSelecetedSourceState("mode",this.viewMode);typeof this.viewModeBtns[this.viewMode]!="undefined"&&this.viewModeBtns[this.viewMode].addClass("active")},rememberDisabledElementId:function(t){var n=e.inArray(t,this.settings.disabledElementIds);n==-1&&this.settings.disabledElementIds.push(t)},forgetDisabledElementId:function(t){var n=e.inArray(t,this.settings.disabledElementIds);n!=-1&&this.settings.disabledElementIds.splice(n,1)},enableElements:function(t){t.removeClass("disabled").parents(".disabled").removeClass("disabled");for(var n=0;n<t.length;n++){var r=e(t[n]).data("id");this.forgetDisabledElementId(r)}this.settings.onEnableElements(t)},disableElements:function(t){t.removeClass("sel").addClass("disabled").parent().removeClass("sel");for(var n=0;n<t.length;n++){var r=e(t[n]).data("id");this.rememberDisabledElementId(r)}this.settings.onDisableElements(t)},getElementById:function(e){return this.$elementContainer.find("[data-id="+e+"]:first")},enableElementsById:function(t){t=e.makeArray(t);for(var n=0;n<t.length;n++){var r=t[n],i=this.getElementById(r);i.length?this.enableElements(i):this.forgetDisabledElementId(r)}},disableElementsById:function(t){t=e.makeArray(t);for(var n=0;n<t.length;n++){var r=t[n],i=this.getElementById(r);i.length?this.disableElements(i):this.rememberDisabledElementId(r)}},setElementSelect:function(e){this.elementSelect=e},addButton:function(t){this.showingSidebar?this.$sidebarButtonContainer.append(t):e('<td class="thin"/>').prependTo(this.$toolbar.find("tr:first")).append(t)},addCallback:function(t,n){return e.proxy(function(){typeof t=="function"&&t.apply(this,arguments);n.apply(this,arguments)},this)},setIndexBusy:function(){this.$mainSpinner.removeClass("hidden");this.isIndexBusy=!0;this.$elements.fadeTo("fast",.5)},setIndexAvailable:function(){this.$mainSpinner.addClass("hidden");this.isIndexBusy=!1;this.$elements.fadeTo("fast",1)}},{defaults:{context:"index",storageKey:null,criteria:null,disabledElementIds:[],onUpdateElements:e.noop,onEnableElements:e.noop,onDisableElements:e.noop,onSelectSource:e.noop,onAfterHtmlInit:e.noop}});Craft.BaseElementSelectInput=Garnish.Base.extend({id:null,name:null,elementType:null,sources:null,criteria:null,sourceElementId:null,limit:null,modalStorageKey:null,elementSelect:null,elementSort:null,modal:null,$container:null,$elementsContainer:null,$elements:null,$addElementBtn:null,selectable:!0,sortable:!0,init:function(t,n,r,i,s,o,u,a){this.id=t;this.name=n;this.elementType=r;this.sources=i;this.criteria=s;this.sourceElementId=o;this.limit=u;a&&(this.modalStorageKey="BaseElementSelectInput."+a);this.$container=this.getContainer();this.$elementsContainer=this.getElementsContainer();this.$elements=this.getElements();this.$addElementBtn=this.getAddElementsBtn();this.updateAddElementsBtn();this.selectable&&(this.elementSelect=new Garnish.Select(this.$elements,{multi:!0,filter:":not(.delete)"}));this.sortable&&(this.elementSort=new Garnish.DragSort({container:this.$elementsContainer,filter:this.selectable?e.proxy(function(){return this.elementSelect.getSelectedItems()},this):null,caboose:e('<div class="caboose"/>'),onSortChange:this.selectable?e.proxy(function(){this.elementSelect.resetItemOrder()},this):null}));this.initElements(this.$elements);this.addListener(this.$addElementBtn,"activate","showModal")},getContainer:function(){return e("#"+this.id)},getElementsContainer:function(){return this.$container.children(".elements")},getElements:function(){return this.$elementsContainer.children()},getAddElementsBtn:function(){return this.$container.children(".btn.add")},canAddMoreElements:function(){return!this.limit||this.$elements.length<this.limit},updateAddElementsBtn:function(){this.canAddMoreElements()?this.enableAddElementsBtn():this.disableAddElementsBtn()},disableAddElementsBtn:function(){this.$addElementBtn.addClass("disabled")},enableAddElementsBtn:function(){this.$addElementBtn.removeClass("disabled")},initElements:function(t){this.selectable&&this.elementSelect.addItems(t);this.sortable&&this.elementSort.addItems(t);t.find(".delete").on("click",e.proxy(function(t){this.removeElement(e(t.currentTarget).closest(".element"))},this));this.addListener(t,"dblclick",function(t){Craft.showElementEditor(e(t.currentTarget))})},removeElement:function(t){var n=e(t);this.$elements=this.$elements.not(n);this.selectable&&this.elementSelect.removeItems(n);this.modal&&n.data("id")&&this.modal.elementIndex.enableElementsById(n.data("id"));this.$addElementBtn&&this.$addElementBtn.length&&this.updateAddElementsBtn();n.css("z-index",0);var r={opacity:-1};r["margin-"+Craft.left]=-(n.outerWidth()+parseInt(n.css("margin-"+Craft.right)));n.animate(r,"fast",function(){n.remove()})},showModal:function(){if(!this.canAddMoreElements())return;this.modal?this.modal.show():this.modal=this.createModal()},createModal:function(){return Craft.createElementSelectorModal(this.elementType,{storageKey:this.modalStorageKey,sources:this.sources,criteria:this.criteria,multiSelect:this.limit!=1,disabledElementIds:this.getSelectedElementIds(),onSelect:e.proxy(this,"onModalSelect")})},getSelectedElementIds:function(){var t=[];this.sourceElementId&&t.push(this.sourceElementId);for(var n=0;n<this.$elements.length;n++)t.push(e(this.$elements[n]).data("id"));return t},onModalSelect:function(e){if(this.limit){var t=this.limit-this.$elements.length;e.length>t&&(e=e.slice(0,t))}this.selectElements(e);this.modal.elementIndex&&this.modal.elementIndex.disableElementsById(this.getSelectedElementIds())},selectElements:function(t){for(var n=0;n<t.length;n++){var r=t[n],i=this.createNewElement(r),s=r.$element.offset(),o=i.offset(),u={top:s.top-o.top,zIndex:1e4};u[Craft.left]=s.left-o.left;i.css(u);var a={top:0};a[Craft.left]=0;i.animate(a,function(){e(this).css("z-index",1)});this.initElements(i);this.$elements=this.$elements.add(i)}this.updateAddElementsBtn();this.onSelectElements()},createNewElement:function(e){var t=e.$element.clone();t.addClass("removable");t.prepend('<input type="hidden" name="'+this.name+'[]" value="'+e.id+'">'+'<a class="delete icon" title="'+Craft.t("Remove")+'"></a>');t.appendTo(this.$elementsContainer);return t},onSelectElements:function(){this.trigger("selectElements")},forceModalRefresh:function(){this.modal&&(this.modal.elementIndex=null)}});Craft.BaseElementSelectorModal=Garnish.Modal.extend({elementType:null,elementIndex:null,elementSelect:null,$body:null,$selectBtn:null,$sidebar:null,$sources:null,$sourceToggles:null,$main:null,$search:null,$elements:null,$tbody:null,$buttons:null,$cancelBtn:null,$selectBtn:null,init:function(t,n){this.elementType=t;this.setSettings(n,Craft.BaseElementSelectorModal.defaults);var r=e('<div class="modal elementselectormodal"></div>').appendTo(Garnish.$bod),i=e('<div class="body"><div class="spinner big"></div></div>').appendTo(r),s=e('<div class="footer"/>').appendTo(r);this.base(r,this.settings);this.$buttons=e('<div class="buttons rightalign"/>').appendTo(s);this.$cancelBtn=e('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(this.$buttons);this.$selectBtn=e('<div class="btn disabled submit">'+Craft.t("Select")+"</div>").appendTo(this.$buttons);this.$body=i;this.addListener(this.$cancelBtn,"activate","cancel");this.addListener(this.$selectBtn,"activate","selectElements")},onFadeIn:function(){if(!this.elementIndex){var t={context:"modal",elementType:this.elementType,sources:this.settings.sources};Craft.postActionRequest("elements/getModalBody",t,e.proxy(function(t,n){if(n=="success"){this.$body.html(t);this.$body.has(".sidebar:not(.hidden)").length&&this.$body.addClass("has-sidebar");this.elementIndex=Craft.createElementIndex(this.elementType,this.$body,{context:"modal",storageKey:this.settings.storageKey,criteria:this.settings.criteria,disabledElementIds:this.settings.disabledElementIds,onUpdateElements:e.proxy(this,"onUpdateElements"),onEnableElements:e.proxy(this,"onEnableElements"),onDisableElements:e.proxy(this,"onDisableElements")})}},this))}else Garnish.isMobileBrowser(!0)||this.elementIndex.$search.focus();this.base()},onUpdateElements:function(t){t||this.addListener(this.elementIndex.$elementContainer,"dblclick","selectElements");if(this.elementSelect){this.elementSelect.destroy();delete this.elementSelect}if(this.elementIndex.getSelectedSourceState("mode")=="structure")var n=this.elementIndex.$elementContainer.find(".row:not(.disabled)");else var n=this.elementIndex.$elementContainer.children(":not(.disabled)");this.elementSelect=new Garnish.Select(this.elementIndex.$elementContainer,n,{multi:this.settings.multiSelect,vertical:this.elementIndex.getSelectedSourceState("mode")!="thumbs",onSelectionChange:e.proxy(this,"onSelectionChange")});this.elementIndex.setElementSelect(this.elementSelect)},onSelectionChange:function(){this.elementSelect.totalSelected?this.$selectBtn.removeClass("disabled"):this.$selectBtn.addClass("disabled")},onEnableElements:function(e){this.elementSelect.addItems(e)},onDisableElements:function(e){this.elementSelect.removeItems(e)},cancel:function(){this.hide()},selectElements:function(){if(this.elementIndex&&this.elementSelect&&this.elementSelect.totalSelected){this.elementSelect.clearMouseUpTimeout();this.hide();var e=this.elementSelect.getSelectedItems(),t=this.getElementInfo(e);this.onSelect(t);this.settings.disableOnSelect&&this.elementIndex.disableElements(this.elementSelect.getSelectedItems())}},getElementInfo:function(t){var n=[];for(var r=0;r<t.length;r++){var i=e(t[r]);n.push(Craft.getElementInfo(i))}return n},onSelect:function(e){this.settings.onSelect(e)}},{defaults:{resizable:!0,storageKey:null,sources:null,criteria:null,multiSelect:!1,disabledElementIds:[],disableOnSelect:!1,onCancel:e.noop,onSelect:e.noop}});Craft.BaseInputGenerator=Garnish.Base.extend({$source:null,$target:null,settings:null,listening:null,timeout:null,init:function(t,n,r){this.$source=e(t);this.$target=e(n);this.setSettings(r);this.startListening()},setNewSource:function(t){var n=this.listening;this.stopListening();this.$source=e(t);n&&this.startListening()},startListening:function(){if(this.listening)return;this.listening=!0;this.addListener(this.$source,"textchange","onTextChange");this.addListener(this.$target,"focus",function(){this.addListener(this.$target,"textchange","stopListening");this.addListener(this.$target,"blur",function(){this.removeListener(this.$target,"textchange,blur")})})},stopListening:function(){if(!this.listening)return;this.listening=!1;this.removeAllListeners(this.$source);this.removeAllListeners(this.$target)},onTextChange:function(){this.timeout&&clearTimeout(this.timeout);this.timeout=setTimeout(e.proxy(this,"updateTarget"),250)},updateTarget:function(){var e=this.$source.val(),t=this.generateTargetValue(e);this.$target.val(t);this.$target.trigger("textchange")},generateTargetValue:function(e){return e}});Craft.AdminTable=Garnish.Base.extend({settings:null,totalObjects:null,sorter:null,$noObjects:null,$table:null,$tbody:null,$deleteBtns:null,init:function(t){this.setSettings(t,Craft.AdminTable.defaults);this.settings.allowDeleteAll||(this.settings.minObjects=1);this.$noObjects=e(this.settings.noObjectsSelector);this.$table=e(this.settings.tableSelector);this.$tbody=this.$table.children("tbody");this.totalObjects=this.$tbody.children().length;this.settings.sortable&&(this.sorter=new Craft.DataTableSorter(this.$table,{onSortChange:e.proxy(this,"reorderObjects")}));this.$deleteBtns=this.$table.find(".delete");this.addListener(this.$deleteBtns,"click","deleteObject");this.updateUI()},addRow:function(t){if(this.settings.maxObjects&&this.totalObjects>=this.settings.maxObjects)return;var n=e(t).appendTo(this.$tbody),r=n.find(".delete");this.settings.sortable&&this.sorter.addItems(n);this.$deleteBtns=this.$deleteBtns.add(r);this.addListener(r,"click","deleteObject");this.totalObjects++;this.updateUI()},reorderObjects:function(){if(!this.settings.sortable)return!1;var t=[];for(var n=0;n<this.sorter.$items.length;n++){var r=e(this.sorter.$items[n]).attr(this.settings.idAttribute);t.push(r)}var i={ids:JSON.stringify(t)};Craft.postActionRequest(this.settings.reorderAction,i,e.proxy(function(e,t){t=="success"&&(e.success?Craft.cp.displayNotice(Craft.t(this.settings.reorderSuccessMessage)):Craft.cp.displayError(Craft.t(this.settings.reorderFailMessage)))},this))},deleteObject:function(t){if(this.settings.minObjects&&this.totalObjects<=this.settings.minObjects)return;var n=e(t.target).closest("tr"),r=n.attr(this.settings.idAttribute),i=n.attr(this.settings.nameAttribute);this.confirmDeleteObject(n)&&Craft.postActionRequest(this.settings.deleteAction
,{id:r},e.proxy(function(e,t){if(t=="success")if(e.success){n.remove();this.totalObjects--;this.updateUI();this.onDeleteObject(r);Craft.cp.displayNotice(Craft.t(this.settings.deleteSuccessMessage,{name:i}))}else Craft.cp.displayError(Craft.t(this.settings.deleteFailMessage,{name:i}))},this))},confirmDeleteObject:function(e){var t=e.attr(this.settings.nameAttribute);return confirm(Craft.t(this.settings.confirmDeleteMessage,{name:t}))},onDeleteObject:function(e){this.settings.onDeleteObject(e)},updateUI:function(){if(this.totalObjects==0){this.$table.hide();this.$noObjects.removeClass("hidden")}else{this.$table.show();this.$noObjects.addClass("hidden")}if(this.settings.sortable){var t=this.$table.find(".move");this.totalObjects==1?t.addClass("disabled"):t.removeClass("disabled")}this.settings.minObjects&&this.totalObjects<=this.settings.minObjects?this.$deleteBtns.addClass("disabled"):this.$deleteBtns.removeClass("disabled");this.settings.newObjectBtnSelector&&(this.settings.maxObjects&&this.totalObjects>=this.settings.maxObjects?e(this.settings.newObjectBtnSelector).addClass("hidden"):e(this.settings.newObjectBtnSelector).removeClass("hidden"))}},{defaults:{tableSelector:null,noObjectsSelector:null,newObjectBtnSelector:null,idAttribute:"data-id",nameAttribute:"data-name",sortable:!1,allowDeleteAll:!0,minObjects:0,maxObjects:null,reorderAction:null,deleteAction:null,reorderSuccessMessage:Craft.t("New order saved."),reorderFailMessage:Craft.t("Couldn’t save new order."),confirmDeleteMessage:Craft.t("Are you sure you want to delete “{name}”?"),deleteSuccessMessage:Craft.t("“{name}” deleted."),deleteFailMessage:Craft.t("Couldn’t delete “{name}”."),onDeleteObject:e.noop}});Craft.AssetIndex=Craft.BaseElementIndex.extend({$uploadButton:null,$uploadInput:null,$progressBar:null,$folders:null,$previouslySelectedFolder:null,uploader:null,promptHandler:null,progressBar:null,initialSourceKey:null,isIndexBusy:!1,_uploadTotalFiles:0,_uploadFileProgress:{},_uploadedFileIds:[],_selectedFileIds:[],_singleFileMenu:null,_multiFileMenu:null,_fileDrag:null,_folderDrag:null,_expandDropTargetFolderTimeout:null,_tempExpandedFolders:[],init:function(t,n,r){this.base(t,n,r);var i=this.settings.context;i=="index"&&this.initIndexMode();var s=this;this.$sources.each(function(){if(i=="index"){s._createFolderContextMenu.apply(s,[e(this),!0]);e(this).parents("ul").length>1&&s._folderDrag.addItems(e(this).parent())}else s._createFolderContextMenu.apply(s,[e(this),!1])})},initIndexMode:function(){var t=this;this._fileDrag=new Garnish.DragDrop({activeDropTargetClass:"sel assets-fm-dragtarget",helperOpacity:.5,filter:e.proxy(function(){return this.elementSelect.getSelectedItems()},this),helper:e.proxy(function(e){return this._getDragHelper(e)},this),dropTargets:e.proxy(function(){var t=[];this.$sources.each(function(){t.push(e(this))});return t},this),onDragStart:e.proxy(function(){this._tempExpandedFolders=[];this.$previouslySelectedFolder=this.$source.removeClass("sel")},this),onDropTargetChange:e.proxy(this,"_onDropTargetChange"),onDragStop:e.proxy(this,"_onFileDragStop")});this._folderDrag=new Garnish.DragDrop({activeDropTargetClass:"sel assets-fm-dragtarget",helperOpacity:.5,filter:e.proxy(function(){var t=this.sourceSelect.getSelectedItems(),n=[];for(var r=0;r<t.length;r++){var i=e(t[r]).parent();i.parents("ul").length>1&&i.hasClass("sel")&&n.push(i[0])}return e(n)},this),helper:e.proxy(function(t){var n=e('<ul class="assets-fm-folderdrag" />').append(t);t.removeClass("expanded");n.width(this.$sidebar[0].scrollWidth);return n},this),dropTargets:e.proxy(function(){var n=[];this.$sources.each(function(){e(this).is(t._folderDrag.$draggee)||n.push(e(this))});return n},this),onDragStart:e.proxy(function(){this._tempExpandedFolders=[];this._folderDrag.$draggee.filter(".expanded").removeClass("expanded").addClass("expanded-tmp")},this),onDropTargetChange:e.proxy(this,"_onDropTargetChange"),onDragStop:e.proxy(this,"_onFolderDragStop")})},_onFileDragStop:function(){if(this._fileDrag.$activeDropTarget){this._fileDrag.$activeDropTarget.addClass("sel");var t=this._getFolderIdFromSourceKey(this._fileDrag.$activeDropTarget.data("key")),n=[],r=[];for(var i=0;i<this._fileDrag.$draggee.length;i++){var s=Craft.getElementInfo(this._fileDrag.$draggee[i]).id,o=Craft.getElementInfo(this._fileDrag.$draggee[i]).url.split("/").pop();n.push(s);r.push(o)}if(n.length){this.setIndexBusy();this._positionProgressBar();this.progressBar.resetProgressBar();this.progressBar.setItemCount(n.length);this.progressBar.showProgressBar();var u=[];for(i=0;i<n.length;i++)u.push({fileId:n[i],folderId:t,fileName:r[i]});var a=e.proxy(function(n){this.promptHandler.resetPrompts();for(var r=0;r<n.length;r++){var i=n[r];i.prompt&&this.promptHandler.addPrompt(i);i.error&&alert(i.error)}this.setIndexAvailable();this.progressBar.hideProgressBar();if(this.promptHandler.getPromptCount()){var s=e.proxy(function(e){var n=[];for(var r=0;r<e.length;r++){if(e[r].choice=="cancel")continue;for(var i=0;i<u.length;i++)if(u[i].fileName==e[r].fileName){u[i].action=e[r].choice;n.push(u[i])}}if(n.length==0)this._selectSourceByFolderId(t);else{this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(this.promptHandler.getPromptCount());this.progressBar.showProgressBar();this._moveFile(n,0,a)}},this);this._fileDrag.fadeOutHelpers();this.promptHandler.showBatchPrompts(s)}else{this._fileDrag.fadeOutHelpers();this._selectSourceByFolderId(t)}},this);this._moveFile(u,0,a);return}}else this._collapseExtraExpandedFolders();this.$previouslySelectedFolder.addClass("sel");this._fileDrag.returnHelpersToDraggees()},_onFolderDragStop:function(){this._folderDrag.$draggee.filter(".expanded-tmp").removeClass("expanded-tmp").addClass("expanded");if(this._folderDrag.$activeDropTarget&&this._folderDrag.$activeDropTarget.siblings("ul").find(">li").filter(this._folderDrag.$draggee).length==0){var t=this._getFolderIdFromSourceKey(this._folderDrag.$activeDropTarget.data("key"));this._collapseExtraExpandedFolders(t);var n=[];for(var r=0;r<this._folderDrag.$draggee.length;r++){var i=e("> a",this._folderDrag.$draggee[r]),s=this._getFolderIdFromSourceKey(i.data("key")),o=this._getSourceByFolderId(s);this._getFolderIdFromSourceKey(this._getParentSource(o).data("key"))!=t&&n.push(s)}if(n.length){n.sort();n.reverse();this.setIndexBusy();this._positionProgressBar();this.progressBar.resetProgressBar();this.progressBar.setItemCount(n.length);this.progressBar.showProgressBar();var u=[],a=[];for(var r=0;r<n.length;r++)a.push({folderId:n[r],parentId:t});this.requestId++;var f=[],l=[],c={},h=[],p=e.proxy(function(n){this.promptHandler.resetPrompts();for(var r=0;r<n.length;r++){var i=n[r];if(i.success&&i.transferList&&i.deleteList&&i.changedFolderIds){for(var s=0;s<i.transferList.length;s++)f.push(i.transferList[s]);for(var s=0;s<i.deleteList.length;s++)l.push(i.deleteList[s]);for(var o in i.changedFolderIds)c[o]=i.changedFolderIds[o];h.push(i.removeFromTree)}i.prompt&&this.promptHandler.addPrompt(i);i.error&&alert(i.error)}if(this.promptHandler.getPromptCount()){var u=e.proxy(function(t){this.promptHandler.resetPrompts();this.setNewElementDataHtml("");var n=[];for(var r=0;r<t.length;r++){if(t[r].choice=="cancel")continue;a[0].action=t[r].choice;n.push(a[0])}if(n.length==0)e.proxy(this,"_performActualFolderMove",f,l,c,h)();else{this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(this.promptHandler.getPromptCount());this.progressBar.showProgressBar();d(n,0,p)}},this);this.promptHandler.showBatchPrompts(u);this.setIndexAvailable();this.progressBar.hideProgressBar()}else e.proxy(this,"_performActualFolderMove",f,l,c,h,t)()},this),d=e.proxy(function(t,n,r){n==0&&(u=[]);Craft.postActionRequest("assets/moveFolder",t[n],e.proxy(function(e,i){n++;this.progressBar.incrementProcessedItemCount(1);this.progressBar.updateProgressBar();i=="success"&&u.push(e);n>=t.length?r(u):d(t,n,r)},this))},this);d(a,0,p);return}}else this._collapseExtraExpandedFolders();this._folderDrag.returnHelpersToDraggees()},_performActualFolderMove:function(t,n,r,i,s){this.setIndexBusy();this.progressBar.resetProgressBar();this.progressBar.setItemCount(1);this.progressBar.showProgressBar();var o=e.proxy(function(t,n,r){var i=e(),o=e(),u=0;for(var a in n){o=this._getSourceByFolderId(a);o=o.attr("data-key","folder:"+n[a].newId).data("key","folder:"+n[a].newId).parent();if(i.length==0||i.parents().filter(o).length>0){i=o;topFolderMovedId=n[a].newId}}if(i.length==0){this.setIndexAvailable();this.progressBar.hideProgressBar();this._folderDrag.returnHelpersToDraggees();return}var f=i.find(">a"),l=i.siblings("ul, .toggle"),c=this._getParentSource(f),h=this._getSourceByFolderId(s);this._prepareParentForChildren(h);this._addSubfolder(h,i);f.after(l);this._cleanUpTree(c);this.$sidebar.find("ul>ul, ul>.toggle").remove();for(var p=0;p<t.length;p++)Craft.postActionRequest("assets/deleteFolder",{folderId:t[p]});this.setIndexAvailable();this.progressBar.hideProgressBar();this._folderDrag.returnHelpersToDraggees();this._selectSourceByFolderId(topFolderMovedId)},this);t.length>0?this._moveFile(t,0,e.proxy(function(){o(n,r,i)},this)):o(n,r,i)},_getParentSource:function(e){return e.parents("ul").length==1?null:e.parent().parent().siblings("a")},_moveFile:function(t,n,r){n==0&&(this.responseArray=[]);Craft.postActionRequest("assets/moveFile",t[n],e.proxy(function(e,i){this.progressBar.incrementProcessedItemCount(1);this.progressBar.updateProgressBar();if(i=="success"){this.responseArray.push(e);Craft.cp.runPendingTasks()}n++;n>=t.length?r(this.responseArray):this._moveFile(t,n,r)},this))},_selectSourceByFolderId:function(t){var n=this._getSourceByFolderId(t),r=n.parent().parents("li");r.each(function(){e(this).hasClass("expanded")||e(this).find("> .toggle").click()});this.selectSource(n);this.updateElements()},onAfterHtmlInit:function(){if(!this.$uploadButton){this.$uploadButton=e('<div class="btn submit assets-upload-button" data-icon="↑" style="position: relative; overflow: hidden;" role="button">'+Craft.t("Upload files")+"</div>");this.addButton(this.$uploadButton);this.$uploadInput=e('<input type="file" multiple="multiple" name="assets-upload" />').hide().insertBefore(this.$uploadButton)}this.promptHandler=new Craft.PromptHandler;this.progressBar=new Craft.ProgressBar(this.$main,!0);var t={url:Craft.getActionUrl("assets/uploadFile"),fileInput:this.$uploadInput,dropZone:this.$main};t.events={fileuploadstart:e.proxy(this,"_onUploadStart"),fileuploadprogressall:e.proxy(this,"_onUploadProgress"),fileuploaddone:e.proxy(this,"_onUploadComplete")};typeof this.settings.criteria.kind!="undefined"&&(t.allowedKinds=this.settings.criteria.kind);this.uploader=new Craft.Uploader(this.$uploadButton,t);this.$uploadButton.on("click",e.proxy(function(){this.isIndexBusy||this.$uploadButton.parent().find("input[name=assets-upload]").click()},this));this.base()},onSelectSource:function(){this.uploader.setParams({folderId:this._getFolderIdFromSourceKey(this.sourceKey)});this.base()},_getFolderIdFromSourceKey:function(e){return e.split(":")[1]},_onUploadStart:function(e){this.setIndexBusy();this._positionProgressBar();this.progressBar.resetProgressBar();this.progressBar.showProgressBar()},_onUploadProgress:function(e,t){var n=parseInt(t.loaded/t.total*100,10);this.progressBar.setProgressPercentage(n)},_onUploadComplete:function(t,n){var r=n.result,i=n.files[0].name,s=!0;if(r.success||r.prompt){this._uploadedFileIds.push(r.fileId);r.prompt&&this.promptHandler.addPrompt(r)}else{r.error?alert(Craft.t("Upload failed for {filename}. The error message was: ”{error}“",{filename:i,error:r.error})):alert(Craft.t("Upload failed for {filename}.",{filename:i}));s=!1}if(this.uploader.isLastUpload()){this.setIndexAvailable();this.progressBar.hideProgressBar();this.promptHandler.getPromptCount()?this.promptHandler.showBatchPrompts(e.proxy(this,"_uploadFollowup")):s&&this.updateElements()}},_uploadFollowup:function(t){this.setIndexBusy();this.progressBar.resetProgressBar();this.promptHandler.resetPrompts();var n=e.proxy(function(){this.setIndexAvailable();this.progressBar.hideProgressBar();this.updateElements()},this);this.progressBar.setItemCount(t.length);var r=e.proxy(function(t,n,i){var s={additionalInfo:t[n].additionalInfo,fileName:t[n].fileName,userResponse:t[n].choice};Craft.postActionRequest("assets/uploadFile",s,e.proxy(function(e,s){s=="success"&&e.fileId&&this._uploadedFileIds.push(e.fileId);n++;this.progressBar.incrementProcessedItemCount(1);this.progressBar.updateProgressBar();n==t.length?i():r(t,n,i)},this))},this);this.progressBar.showProgressBar();r(t,0,n)},onUpdateElements:function(e){this.base(e);if(this.settings.context=="index"){$elements=this.$elementContainer.children(":not(.disabled)");this._initElementSelect($elements);this._attachElementEvents($elements);this._initElementDragger($elements)}if(this._uploadedFileIds.length){var t=null;for(var n=0;n<this._uploadedFileIds.length;n++){t=this.$main.find("[data-id="+this._uploadedFileIds[n]+"]:first").parent();this.getSelectedSourceState("mode")=="table"&&(t=t.parent());this.elementSelect.selectItem(t)}this._uploadedFileIds=[]}},_initElementSelect:function(t){if(typeof this.elementSelect=="object"&&this.elementSelect!=null){this.elementSelect.destroy();delete this.elementSelect}var n=new Garnish.Select(this.$elementContainer,t,{multi:!0,vertical:this.getSelectedSourceState("mode")=="table",onSelectionChange:e.proxy(this,"_onElementSelectionChange")});this.setElementSelect(n)},_onElementSelectionChange:function(){this._enableElementContextMenu();var e=this.elementSelect.getSelectedItems();this._selectedFileIds=[];for(var t=0;t<e.length;t++)this._selectedFileIds[t]=Craft.getElementInfo(e[t]).id},_attachElementEvents:function(t){this.removeListener(t,"dlbclick");this.addListener(t,"dblclick",e.proxy(this,"_editProperties"));this._destroyElementContextMenus();this._createElementContextMenus(t)},_initElementDragger:function(e){this._fileDrag.removeAllItems();this._fileDrag.addItems(e)},_editProperties:function(t){var n=e(t.currentTarget).find(".element");new Craft.ElementEditor(n)},_createElementContextMenus:function(t){var n={menuClass:"menu assets-contextmenu"},r=[{label:Craft.t("View file"),onClick:e.proxy(this,"_viewFile")}];r.push({label:Craft.t("Edit properties"),onClick:e.proxy(this,"_showProperties")});r.push({label:Craft.t("Rename file"),onClick:e.proxy(this,"_renameFile")});r.push({label:Craft.t("Copy reference tag"),onClick:e.proxy(this,"_copyRefTag")});r.push("-");r.push({label:Craft.t("Delete file"),onClick:e.proxy(this,"_deleteFile")});this._singleFileMenu=new Garnish.ContextMenu(t,r,n);r=[{label:Craft.t("Delete"),onClick:e.proxy(this,"_deleteFiles")}];this._multiFileMenu=new Garnish.ContextMenu(t,r,n);this._enableElementContextMenu()},_destroyElementContextMenus:function(){this._singleFileMenu!==null&&this._singleFileMenu.destroy();this._multiFileMenu!==null&&this._singleFileMenu.destroy()},_enableElementContextMenu:function(){this._multiFileMenu.disable();this._singleFileMenu.disable();this.elementSelect.getTotalSelected()==1?this._singleFileMenu.enable():this.elementSelect.getTotalSelected()>1&&this._multiFileMenu.enable()},_showProperties:function(t){e(t.currentTarget).dblclick()},_viewFile:function(e){window.open(Craft.getElementInfo(e.currentTarget).url)},_renameFile:function(t){var n=e(t.currentTarget),r=Craft.getElementInfo(n).id,i=Craft.getElementInfo(n).url.split("/").pop();i.indexOf("?")!==-1&&(i=i.split("?").shift());var s=prompt(Craft.t("Rename file"),i);if(s&&s!=i){this.setIndexBusy();var o={fileId:r,folderId:this._getFolderIdFromSourceKey(this.$source.data("key")),fileName:s},u=function(t,n){this.setIndexAvailable();this.promptHandler.resetPrompts();if(n=="success"){if(t.prompt){this.promptHandler.addPrompt(t);var r=e.proxy(function(t){t=t[0].choice;if(t!="cancel"){o.action=t;Craft.postActionRequest("assets/moveFile",o,e.proxy(u,this))}},this);this.promptHandler.showBatchPrompts(r)}if(t.success){this.updateElements();Craft.cp.runPendingTasks()}t.error&&alert(t.error)}};Craft.postActionRequest("assets/moveFile",o,e.proxy(u,this))}},_copyRefTag:function(t){var n=Craft.t("{ctrl}C to copy.",{ctrl:navigator.appVersion.indexOf("Mac")?"⌘":"Ctrl-"});prompt(n,"{asset:"+Craft.getElementInfo(e(t.currentTarget)).id+"}")},_deleteFile:function(t){var n=e(t.currentTarget),r=Craft.getElementInfo(n).id,i=Craft.getElementInfo(n).label;if(confirm(Craft.t("Are you sure you want to delete “{name}”?",{name:i}))){n.data("AssetEditor")&&n.data("AssetEditor").removeHud();this.setIndexBusy();Craft.postActionRequest("assets/deleteFile",{fileId:r},e.proxy(function(e,t){this.setIndexAvailable();if(t=="success"){e.error&&alert(e.error);this.updateElements()}},this))}},_deleteFiles:function(){if(confirm(Craft.t("Are you sure you want to delete these {number} files?",{number:this.elementSelect.getTotalSelected()}))){this.setIndexBusy();var t={};for(var n=0;n<this._selectedFileIds.length;n++)t["fileId["+n+"]"]=this._selectedFileIds[n];Craft.postActionRequest("assets/deleteFile",t,e.proxy(function(e,t){this.setIndexAvailable();if(t=="success"){e.error&&alert(e.error);this.updateElements()}},this))}},_getDragHelper:function(t){var n=this.getSelectedSourceState("mode");switch(n){case"table":var r=e('<div class="assets-listview assets-lv-drag" />'),i=e('<table cellpadding="0" cellspacing="0" border="0" />').appendTo(r),s=e("<tbody />").appendTo(i);i.width(this.$table.width());s.append(t);return r;case"thumbs":return e('<ul class="thumbsview assets-tv-drag" />').append(t.removeClass("sel"))}return e()},_onDropTargetChange:function(t){clearTimeout(this._expandDropTargetFolderTimeout);if(t){var n=this._getFolderIdFromSourceKey(t.data("key"));if(n){this.dropTargetFolder=this._getSourceByFolderId(n);this._hasSubfolders(this.dropTargetFolder)&&!this._isExpanded(this.dropTargetFolder)&&(this._expandDropTargetFolderTimeout=setTimeout(e.proxy(this,"_expandFolder"),500))}else this.dropTargetFolder=null}},_collapseExtraExpandedFolders:function(e){clearTimeout(this._expandDropTargetFolderTimeout);if(e)var t=this._getSourceByFolderId(e).parents("li").find(">a");for(var n=this._tempExpandedFolders.length-1;n>=0;n--){var r=this._tempExpandedFolders[n];if(!e||t.filter('[data-key="'+r.data("key")+'"]').length==0){this._collapseFolder(r);this._tempExpandedFolders.splice(n,1)}}},_getSourceByFolderId:function(e){return this.$sources.filter('[data-key="folder:'+e+'"]')},_hasSubfolders:function(e){return e.siblings("ul").find("li").length},_isExpanded:function(e){return e.parent("li").hasClass("expanded")},_expandFolder:function(){this._collapseExtraExpandedFolders(this._getFolderIdFromSourceKey(this.dropTargetFolder.data("key")));this.dropTargetFolder.parent().find("> .toggle").click();this._tempExpandedFolders.push(this.dropTargetFolder)},_collapseFolder:function(e){var t=e.parent();t.hasClass("expanded")&&t.find("> .toggle").click()},_createFolderContextMenu:function(t,n){t=e(t);var r=[{label:Craft.t("New subfolder"),onClick:e.proxy(this,"_createSubfolder",t)}];if(t.parents("ul").length>1&&n){r.push({label:Craft.t("Rename folder"),onClick:e.proxy(this,"_renameFolder",t)});r.push({label:Craft.t("Delete folder"),onClick:e.proxy(this,"_deleteFolder",t)})}new Garnish.ContextMenu(t,r,{menuClass:"menu assets-contextmenu"})},_createSubfolder:function(t){var n=prompt(Craft.t("Enter the name of the folder"));if(n){var r={parentId:this._getFolderIdFromSourceKey(t.data("key")),folderName:n};this.setIndexBusy();Craft.postActionRequest("assets/createFolder",r,e.proxy(function(n,r){this.setIndexAvailable();if(r=="success"&&n.success){this._prepareParentForChildren(t);var i=e('<li><a data-key="folder:'+n.folderId+'" data-has-thumbs="'+t.data("has-thumbs")+'">'+n.folderName+"</a></li>"),s=i.find("a");this._addSubfolder(t,i);this._createFolderContextMenu(s,this.settings.context=="index");this.sourceSelect.addItems(s);this._folderDrag&&this._folderDrag.addItems(s.parent());this.$sources=this.$sources.add(s)}r=="success"&&n.error&&alert(n.error)},this))}},_deleteFolder:function(t){if(confirm(Craft.t("Really delete folder “{folder}”?",{folder:e.trim(t.text())}))){var n={folderId:this._getFolderIdFromSourceKey(t.data("key"))};this.setIndexBusy();Craft.postActionRequest("assets/deleteFolder",n,e.proxy(function(e,n){this.setIndexAvailable();if(n=="success"&&e.success){var r=this._getParentSource(t);this.$sources=this.$sources.not(t);this.sourceSelect.removeItems(t);t.parent().remove();this._cleanUpTree(r)}n=="success"&&e.error&&alert(e.error)},this))}},_renameFolder:function(t){var n=e.trim(t.text()),r=prompt(Craft.t("Rename folder"),n);if(r&&r!=n){var i={folderId:this._getFolderIdFromSourceKey(t.data("key")),newName:r};this.setIndexBusy();Craft.postActionRequest("assets/renameFolder",i,e.proxy(function(e,n){this.setIndexAvailable();n=="success"&&e.success&&t.text(e.newName);n=="success"&&e.error&&alert(e.error)},this),"json")}},_prepareParentForChildren:function(t){if(!this._hasSubfolders(t)){t.parent().addClass("expanded").append('<div class="toggle"></div><ul></ul>');this.addListener(t.siblings(".toggle"),"click",function(t){e(t.currentTarget).parent().toggleClass("expanded")})}},_addSubfolder:function(t,n){var r=t.siblings("ul").find(">li"),i=!1;r.each(function(){if(!i&&e.trim(e(this).text())>e.trim(n.text())){e(this).before(n);i=!0}});i||t.siblings("ul").append(n)},_cleanUpTree:function(e){if(e!==null&&e.siblings("ul").find("li").length==0){e.siblings("ul").remove();e.siblings(".toggle").remove();e.parent().removeClass("expanded")}},_positionProgressBar:function(){var t=e(),n=0;this.settings.context=="index"?t=this.progressBar.$progressBar.parents("#content"):t=this.progressBar.$progressBar.parents(".main");var r=t.offset().top,i=Garnish.$doc.scrollTop(),s=i-r,o=Garnish.$win.height();t.height()>o?n=o/2-6+s:n=t.height()/2-6;this.progressBar.$progressBar.css({top:n})}});Craft.registerElementIndexClass("Asset",Craft.AssetIndex);Craft.AssetSelectInput=Craft.BaseElementSelectInput.extend({requestId:0,hud:null,fieldId:0,uploader:null,progressBar:null,init:function(e,t,n,r,i,s,o,u,a){this.base(e,t,n,r,i,s,o,u);this.fieldId=a;this._attachDragEvents()},_attachDragEvents:function(){this.progressBar=new Craft.ProgressBar(e('<div class="progress-shade"></div>').appendTo(this.$container));var t={url:Craft.getActionUrl("assets/expressUpload"),dropZone:this.$container,formData:{fieldId:this.fieldId,entryId:e("input[name=entryId]").val()}};typeof this.criteria.kind!="undefined"&&(t.allowedKinds=this.criteria.kind);t.events={};t.events.fileuploadstart=e.proxy(this,"_onUploadStart");t.events.fileuploadprogressall=e.proxy(this,"_onUploadProgress");t.events.fileuploaddone=e.proxy(this,"_onUploadComplete");this.uploader=new Craft.Uploader(this.$container,t)},selectUploadedFile:function(e){if(this.limit&&this.totalElements+1==this.limit)return;var t=e.$element;t.addClass("removable");t.prepend('<input type="hidden" name="'+this.name+'[]" value="'+e.id+'">'+'<a class="delete icon" title="'+Craft.t("Remove")+'"></a>');t.appendTo(this.$elementsContainer);var n=-(t.outerWidth()+10);this.$addElementBtn.css("margin-"+Craft.left,n+"px");var r={};r["margin-"+Craft.left]=0;this.$addElementBtn.animate(r,"fast");this.$elements=this.$elements.add(t);this.initElements(t);this.totalElements++;this.limit&&this.totalElements==this.limit&&this.$addElementBtn.addClass("disabled");this.modal&&this.modal.elementIndex.rememberDisabledElementId(e.id)},_onUploadStart:function(e){this.progressBar.$progressBar.css({top:Math.round(this.$container.outerHeight()/2)-6});this.$container.addClass("uploading");this.progressBar.resetProgressBar();this.progressBar.showProgressBar()},_onUploadProgress:function(e,t){var n=parseInt(t.loaded/t.total*100,10);this.progressBar.setProgressPercentage(n)},_onUploadComplete:function(t,n){var r=e(n.result.html);e("head").append(n.result.css);this.selectUploadedFile(Craft.getElementInfo(r));if(this.uploader.isLastUpload()){this.progressBar.hideProgressBar();this.$container.removeClass("uploading")}this.forceModalRefresh()}});Craft.AssetSelectorModal=Craft.BaseElementSelectorModal.extend({$selectTransformBtn:null,$transformSpinner:null,_selectedTransform:null,init:function(t,n){n=e.extend({},Craft.AssetSelectorModal.defaults,n);if(n.canSelectImageTransforms&&typeof Craft.AssetSelectorModal.transforms=="undefined"){var r=this.base;this.fetchTransformInfo(e.proxy(function(){r.call(this,t,n);this.createSelectTransformButton()},this));return}this.base(t,n);n.canSelectImageTransforms&&this.createSelectTransformButton()},fetchTransformInfo:function(t){Craft.postActionRequest("assets/getTransformInfo",e.proxy(function(e,n){n=="success"&&e instanceof Array?Craft.AssetSelectorModal.transforms=e:Craft.AssetSelectorModal.transforms=[];t()},this))},createSelectTransformButton:function(){if(!Craft.AssetSelectorModal.transforms.length)return;var t=e('<div class="btngroup"/>').appendTo(this.$buttons);this.$selectBtn.appendTo(t);this.$selectTransformBtn=e('<div class="btn menubtn disabled">'+Craft.t("Select Transform")+"</div>").appendTo(t);var n=e('<div class="menu" data-align="right"></div>').insertAfter(this.$selectTransformBtn),r=e("<ul></ul>").appendTo(n);for(var i=0;i<Craft.AssetSelectorModal.transforms.length;i++)e('<li><a data-transform="'+Craft.AssetSelectorModal.transforms[i].handle+'">'+Craft.AssetSelectorModal.transforms[i].name+"</a></li>").appendTo(r);new Garnish.MenuBtn(this.$selectTransformBtn,{onOptionSelect:e.proxy(this,"onSelectTransform")});this.$transformSpinner=e('<div class="spinner hidden" style="margin-'+Craft.right+': -24px;"/>').insertAfter(t)},onSelectionChange:function(t){if(this.elementSelect.totalSelected&&this.settings.canSelectImageTransforms&&Craft.AssetSelectorModal.transforms.length){var n=!0,r=this.elementSelect.getSelectedItems();for(var i=0;i<r.length;i++)if(!e(".element.hasthumb:first",r[i]).length){n=!1;break}}else var n=!1;n?this.$selectTransformBtn.removeClass("disabled"):this.$selectTransformBtn&&this.$selectTransformBtn.addClass("disabled");this.base()},onSelectTransform:function(t){var n=e(t).data("transform");this.selectImagesWithTransform(n)},selectImagesWithTransform:function(t){typeof Craft.AssetSelectorModal.transformUrls[t]=="undefined"&&(Craft.AssetSelectorModal.transformUrls[t]={});var n=this.elementSelect.getSelectedItems(),r=[];for(var i=0;i<n.length;i++){var s=e(n[i]),o=Craft.getElementInfo(s).id;typeof Craft.AssetSelectorModal.transformUrls[t][o]=="undefined"&&r.push(o)}if(r.length){this.$transformSpinner.removeClass("hidden");this.fetchMissingTransformUrls(r,t,e.proxy(function(){this.$transformSpinner.addClass("hidden");this.selectImagesWithTransform(t)},this))}else{this._selectedTransform=t;this.selectElements();this._selectedTransform=null}},fetchMissingTransformUrls:function(t,n,r){var i=t.pop(),s={fileId:i,handle:n,returnUrl:!0};Craft.postActionRequest("assets/generateTransform",s,e.proxy(function(e,s){Craft.AssetSelectorModal.transformUrls[n][i]=!1;s=="success"&&e.url&&(Craft.AssetSelectorModal.transformUrls[n][i]=e.url);t.length?this.fetchMissingTransformUrls(t,n,r):r()},this))},getElementInfo:function(e){var t=this.base(e);if(this._selectedTransform)for(var n=0;n<t.length;n++){var r=t[n].id;typeof Craft.AssetSelectorModal.transformUrls[this._selectedTransform][r]!="undefined"&&Craft.AssetSelectorModal.transformUrls[this._selectedTransform][r]!==!1&&(t[n].url=Craft.AssetSelectorModal.transformUrls[this._selectedTransform][r])}return t},onSelect:function(e){this.settings.onSelect(e,this._selectedTransform)}},{defaults:{canSelectImageTransforms:!1},transformUrls:{}});Craft.registerElementSelectorModalClass("Asset",Craft.AssetSelectorModal);Craft.CategoryIndex=Craft.BaseElementIndex.extend({groupId:null,structure:null,$noCats:null,$addCategoryForm:null,$addCategoryInput:null,$addCategorySpinner:null,getDefaultSourceKey:function(){if(this.settings.context=="index"&&typeof defaultGroupHandle!="undefined")for(var t=0;t<this.$sources.length;t++){var n=e(this.$sources[t]);if(n.data("handle")==defaultGroupHandle)return n.data("key")}return this.base()},onSelectSource:function(){if(this.settings.context=="index"&&typeof history!="undefined"){var e="categories/"+this.$source.data("handle");history.replaceState({},"",Craft.getUrl(e))}this.base()},getViewModesForSource:function(){return[{mode:"structure",title:Craft.t("Display hierarchically"),icon:"structure"}]},onUpdateElements:function(e){if(this.getSelectedSourceState("mode")=="structure"){this.$noCats=this.$elements.children(".nocats");this.$addCategoryForm=this.$elements.children("form");this.$addCategoryInput=this.$addCategoryForm.find("input[type=text]");this.$addCategorySpinner=this.$addCategoryForm.find(".spinner");this.structure=this.$elementContainer.data("structure");this.groupId=this.$addCategoryForm.data("group-id");this.addListener(this.$addCategoryForm,"submit","onAddCategorySubmit")}this.initElements(this.$elementContainer.find(".element"));this.base(e)},initElements:function(t){if(this.settings.context=="index"){this.addListener(t,"dblclick",function(t){Craft.showElementEditor(e(t.currentTarget))});this.addListener(t.siblings(".delete"),"click","onDeleteClick")}},onDeleteClick:function(t){var n=e(t.currentTarget).siblings(".element"),r=Craft.getElementInfo(n);confirm(Craft.t("Are you sure you want to delete “{name}” and its descendants?",{name:r.label}))&&Craft.postActionRequest("categories/deleteCategory",{categoryId:r.id},e.proxy(function(e,t){if(t=="success")if(e.success){this.structure.removeElement(n);Craft.cp.displayNotice(Craft.t("“{name}” deleted.",{name:r.label}));this.$elementContainer.find(".element").not(n).length||this.$noCats.removeClass("hidden")}else Craft.cp.displayError(Craft.t("Couldn’t delete “{name}”.",{name:r.label}))},this))},onAddCategorySubmit:function(t){t.preventDefault();this.$addCategorySpinner.removeClass("hidden");var n={title:this.$addCategoryInput.val(),groupId:this.groupId};Craft.postActionRequest("categories/createCategory",n,e.proxy(function(t,n){this.$addCategorySpinner.addClass("hidden");if(n=="success"){this.$noCats.addClass("hidden");var r=e('<div class="element" data-editable="1"data-id="'+t.id+'" '+'data-locale="'+Craft.locale+'" '+'data-status="'+t.status+'" '+'data-label="'+t.title+'" '+'data-url="'+t.url+'">'+'<div class="label">'+'<span class="status '+t.status+'"></span>'+'<span class="title">'+t.title+"</span>"+"</div>"+"</div>");this.structure.addElement(r);var i=r.parent();e('<a class="delete icon" title="'+Craft.t("Delete")+'"></a>').appendTo(i);this.initElements(r);this.$addCategoryInput.val("");var s={top:24};s[Craft.left]=-5;var o={top:0};o[Craft.left]=0;r.css(s).animate(o,"fast")}},this))}});Craft.registerElementIndexClass("Category",Craft.CategoryIndex);Craft.CategorySelectInput=Craft.BaseElementSelectInput.extend({selectable:!1,sortable:!1,init:function(){this.base.apply(this,arguments);this.addLastClasses()},getElements:function(){return this.$elementsContainer.find("li:not(.hidden) > .row .element")},initElements:function(e){this.initCheckboxes(e.siblings(".checkbox"))},initCheckboxes:function(e){this.removeListener(e,"change");this.addListener(e,"change","onCheckboxChange")},onCheckboxChange:function(t){var n=e(t.currentTarget);n.prop("checked")?n.closest("li").parentsUntil(this.$elementsContainer,"li").children(".row").find(".checkbox").prop("checked",!0):n.closest("li").children("ul").find(".checkbox").prop("checked",!1)},createNewElement:function(e){var t=this.$container.find("#"+this.id+"-category-"+e.id),n=t.parentsUntil(this.$elementsContainer,"li"),r=t.add(n),i=n.children(".row").find(".element"),s=r.children(".row").find(".checkbox"),o=t.children(".row").find(".element");r.removeClass("hidden");s.prop("checked",!0);this.initCheckboxes(s);this.$elements=this.$elements.add(i);return o},onSelectElements:function(){this.addLastClasses();this.base.apply(this,arguments)},addLastClasses:function(){var t=this.$elementsContainer.find("ul");for(var n=0;n<t.length;n++){var r=e(t[n]);r.children(".last").removeClass("last");r.children(":not(.hidden):last").addClass("last")}}});Craft.DataTableSorter=Garnish.DragSort.extend({$table:null,init:function(t,n){this.$table=e(t);var r=this.$table.children("tbody").children(":not(.filler)");n=e.extend({},Craft.DataTableSorter.defaults,n);n.container=this.$table.children("tbody");n.helper=e.proxy(this,"getHelper");n.caboose="<tr/>";n.axis=Garnish.Y_AXIS;this.base(r,n)},getHelper:function(t){var n=e('<div class="'+this.settings.helperClass+'"/>').appendTo(Garnish.$bod),r=e("<table/>").appendTo(n),i=e("<tbody/>").appendTo(r);t.appendTo(i);r.width(this.$table.width());r.prop("className",this.$table.prop("className"
));var s=this.$table.find("tr:first"),o=s.children(),u=t.children();for(var a=0;a<u.length;a++)e(u[a]).width(e(o[a]).width());return n}},{defaults:{handle:".move",helperClass:"datatablesorthelper"}});Craft.EditableTable=Garnish.Base.extend({id:null,baseName:null,columns:null,sorter:null,biggestId:-1,$table:null,$tbody:null,$addRowBtn:null,init:function(t,n,r,i){this.id=t;this.baseName=n;this.columns=r;this.setSettings(i,Craft.EditableTable.defaults);this.$table=e("#"+t);this.$tbody=this.$table.children("tbody");this.sorter=new Craft.DataTableSorter(this.$table,{helperClass:"editabletablesorthelper"});var s=this.$tbody.children();for(var o=0;o<s.length;o++)new Craft.EditableTable.Row(this,s[o]);this.$addRowBtn=this.$table.next(".add");this.addListener(this.$addRowBtn,"activate","addRow")},addRow:function(){var t=this.settings.rowIdPrefix+(this.biggestId+1),n=Craft.EditableTable.getRowHtml(t,this.columns,this.baseName,{}),r=e(n).appendTo(this.$tbody);new Craft.EditableTable.Row(this,r);this.sorter.addItems(r);r.find("input,textarea,select").first().focus();this.settings.onAddRow(r)}},{textualColTypes:["singleline","multiline","number"],defaults:{rowIdPrefix:"",onAddRow:e.noop,onDeleteRow:e.noop},getRowHtml:function(e,t,n,r){var i='<tr data-id="'+e+'">';for(var s in t){var o=t[s],u=n+"["+e+"]["+s+"]",a=typeof r[s]!="undefined"?r[s]:"",f=Craft.inArray(o.type,Craft.EditableTable.textualColTypes);i+='<td class="'+(f?"textual":"")+" "+(typeof o["class"]!="undefined"?o["class"]:"")+'"'+(typeof o["width"]!="undefined"?' width="'+o.width+'"':"")+">";switch(o.type){case"select":i+='<div class="select small"><select name="'+u+'">';var l=!1;for(var c in o.options){var h=o.options[c];if(typeof h.optgroup!="undefined"){l?i+="</optgroup>":l=!0;i+='<optgroup label="'+h.optgroup+'">'}else{var p=typeof h.label!="undefined"?h.label:h,d=typeof h.value!="undefined"?h.value:c,v=typeof h.disabled!="undefined"?h.disabled:!1;i+='<option value="'+d+'"'+(d==a?" selected":"")+(v?" disabled":"")+">"+p+"</option>"}}l&&(i+="</optgroup>");i+="</select></div>";break;case"checkbox":i+='<input type="hidden" name="'+u+'">'+'<input type="checkbox" name="'+u+'" value="1"'+(a?" checked":"")+">";break;default:i+='<textarea name="'+u+'" rows="1">'+a+"</textarea>"}i+="</td>"}i+='<td class="thin action"><a class="move icon" title="'+Craft.t("Reorder")+'"></a></td>'+'<td class="thin action"><a class="delete icon" title="'+Craft.t("Delete")+'"></a></td>'+"</tr>";return i}});Craft.EditableTable.Row=Garnish.Base.extend({table:null,id:null,niceTexts:null,$tr:null,$tds:null,$textareas:null,$deleteBtn:null,init:function(t,n){this.table=t;this.$tr=e(n);this.$tds=this.$tr.children();var r=parseInt(this.$tr.attr("data-id").substr(this.table.settings.rowIdPrefix.length));r>this.table.biggestId&&(this.table.biggestId=r);this.$textareas=e();this.niceTexts=[];var i={},s=0;for(var o in this.table.columns){var u=this.table.columns[o];if(Craft.inArray(u.type,Craft.EditableTable.textualColTypes)){$textarea=e("textarea",this.$tds[s]);this.$textareas=this.$textareas.add($textarea);this.addListener($textarea,"focus","onTextareaFocus");this.addListener($textarea,"mousedown","ignoreNextTextareaFocus");this.niceTexts.push(new Garnish.NiceText($textarea,{onHeightChange:e.proxy(this,"onTextareaHeightChange")}));(u.type=="singleline"||u.type=="number")&&this.addListener($textarea,"keypress",{type:u.type},"validateKeypress");i[o]=$textarea}s++}this.onTextareaHeightChange();for(var o in this.table.columns){var u=this.table.columns[o];u.autopopulate&&typeof i[u.autopopulate]!="undefined"&&!i[o].val()&&(u.autopopulate=="handle"?new Craft.HandleGenerator(i[o],i[u.autopopulate]):new Craft.BaseInputGenerator(i[o],i[u.autopopulate]))}var a=this.$tr.children().last().find(".delete");this.addListener(a,"click","deleteRow")},onTextareaFocus:function(t){var n=e(t.currentTarget);if(n.data("ignoreNextFocus")){n.data("ignoreNextFocus",!1);return}setTimeout(function(){var e=n.val();if(typeof n[0].setSelectionRange!="undefined"){var t=e.length*2;n[0].setSelectionRange(0,t)}else n.val(e)},0)},ignoreNextTextareaFocus:function(t){e.data(t.currentTarget,"ignoreNextFocus",!0)},validateKeypress:function(e){var t=e.keyCode?e.keyCode:e.charCode;!e.metaKey&&!e.ctrlKey&&(t==Garnish.RETURN_KEY||e.data.type=="number"&&!Craft.inArray(t,Craft.EditableTable.Row.numericKeyCodes))&&e.preventDefault()},onTextareaHeightChange:function(){var e=-1;for(var t=0;t<this.niceTexts.length;t++)this.niceTexts[t].height>e&&(e=this.niceTexts[t].height);this.$textareas.css("min-height",e)},deleteRow:function(){this.table.sorter.removeItems(this.$tr);this.$tr.remove();this.table.settings.onDeleteRow(this.$tr)}},{numericKeyCodes:[9,8,37,38,39,40,45,91,46,190,48,49,50,51,52,53,54,55,56,57]});Craft.ElementEditor=Garnish.Base.extend({$element:null,elementId:null,locale:null,$form:null,$fieldsContainer:null,$cancelBtn:null,$saveBtn:null,$spinner:null,$localeSelect:null,$localeSpinner:null,hud:null,init:function(t){this.$element=t;this.elementId=t.data("id");this.$element.addClass("loading");var n={elementId:this.elementId,locale:this.$element.data("locale"),includeLocales:!0};Craft.postActionRequest("elements/getEditorHtml",n,e.proxy(this,"showHud"))},showHud:function(t,n){this.$element.removeClass("loading");if(n=="success"){var r=e();if(t.locales){var i=e('<div class="header"/>'),s=e('<div class="select"/>').appendTo(i);this.$localeSelect=e("<select/>").appendTo(s);this.$localeSpinner=e('<div class="spinner hidden"/>').appendTo(i);for(var o=0;o<t.locales.length;o++){var u=t.locales[o];e('<option value="'+u.id+'"'+(u.id==t.locale?' selected="selected"':"")+">"+u.name+"</option>").appendTo(this.$localeSelect)}this.addListener(this.$localeSelect,"change","switchLocale");r=r.add(i)}this.$form=e("<form/>");this.$fieldsContainer=e('<div class="fields"/>').appendTo(this.$form);this.updateForm(t);var a=e('<div class="footer"/>').appendTo(this.$form);this.$spinner=e('<div class="spinner hidden"/>').appendTo(a);var f=e('<div class="buttons right"/>').appendTo(a);this.$cancelBtn=e('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(f);this.$saveBtn=e('<input class="btn submit" type="submit" value="'+Craft.t("Save")+'"/>').appendTo(f);r=r.add(this.$form);this.hud=new Garnish.HUD(this.$element,r,{bodyClass:"body elementeditor",closeOtherHUDs:!1});this.hud.on("hide",e.proxy(function(){delete this.hud},this));this.addListener(this.$form,"submit","saveElement");this.addListener(this.$cancelBtn,"click",function(){this.hud.hide()})}},switchLocale:function(){var t=this.$localeSelect.val();if(t==this.locale)return;this.$localeSpinner.removeClass("hidden");var n={elementId:this.elementId,locale:t};Craft.postActionRequest("elements/getEditorHtml",n,e.proxy(function(e,t){this.$localeSpinner.addClass("hidden");t=="success"?this.updateForm(e):this.$localeSelect.val(this.locale)},this))},updateForm:function(e){this.locale=e.locale;this.$fieldsContainer.html(e.html);Craft.initUiElements(this.$fieldsContainer)},saveElement:function(t){t.preventDefault();this.$spinner.removeClass("hidden");var n=this.$form.serialize();Craft.postActionRequest("elements/saveElement",n,e.proxy(function(e,t){this.$spinner.addClass("hidden");if(t=="success")if(t=="success"&&e.success){this.locale==this.$element.data("locale")&&this.$element.find(".title").text(e.newTitle);typeof Craft.livePreview!="undefined"&&Craft.livePreview.updateIframe(!0);this.closeHud()}else{this.updateForm(e);Garnish.shake(this.hud.$hud)}},this))},closeHud:function(){this.hud.hide();delete this.hud}});Craft.EntryIndex=Craft.BaseElementIndex.extend({getDefaultSourceKey:function(){if(this.settings.context=="index"&&typeof defaultSectionHandle!="undefined"){if(defaultSectionHandle=="singles")return"singles";for(var t=0;t<this.$sources.length;t++){var n=e(this.$sources[t]);if(n.data("handle")==defaultSectionHandle)return n.data("key")}}return this.base()},onSelectSource:function(){if(this.settings.context=="index"&&typeof history!="undefined"){if(this.$source.data("key")=="singles")var e="singles";else var e=this.$source.data("handle");var t="entries";e&&(t+="/"+e);history.replaceState({},"",Craft.getUrl(t))}this.base()}});Craft.registerElementIndexClass("Entry",Craft.EntryIndex);Craft.EntryUrlFormatGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(e){e=e.replace("/<(.*?)>/g","");e=e.toLowerCase();e=Craft.asciiString(e);e=e.replace(/^[^a-z]+/,"");e=e.replace(/[^a-z0-9]+$/,"");var t=Craft.filterArray(e.split(/[^a-z0-9]+/)),n=t.join("-");n&&this.settings.suffix&&(n+=this.settings.suffix);return n}});Craft.FieldLayoutDesigner=Garnish.Base.extend({$container:null,$tabContainer:null,$unusedFieldContainer:null,$newTabBtn:null,$allFields:null,tabGrid:null,unusedFieldGrid:null,tabDrag:null,fieldDrag:null,init:function(t,n){this.$container=e(t);this.setSettings(n,Craft.FieldLayoutDesigner.defaults);this.$tabContainer=this.$container.children(".fld-tabs");this.$unusedFieldContainer=this.$container.children(".unusedfields");this.$newTabBtn=e("#newtabbtn");this.$allFields=this.$unusedFieldContainer.find(".fld-field");this.tabGrid=new Craft.Grid(this.$tabContainer,Craft.FieldLayoutDesigner.gridSettings);this.unusedFieldGrid=new Craft.Grid(this.$unusedFieldContainer,Craft.FieldLayoutDesigner.gridSettings);var r=this.$tabContainer.children();for(var i=0;i<r.length;i++)this.initTab(e(r[i]));this.fieldDrag=new Craft.FieldLayoutDesigner.FieldDrag(this);if(this.settings.customizableTabs){this.tabDrag=new Craft.FieldLayoutDesigner.TabDrag(this);this.addListener(this.$newTabBtn,"activate","addTab")}},initTab:function(t){if(this.settings.customizableTabs){var n=t.find(".tabs .settings"),r=e('<div class="menu" data-align="center"/>').insertAfter(n),i=e("<ul/>").appendTo(r);e('<li><a data-action="rename">'+Craft.t("Rename")+"</a></li>").appendTo(i);e('<li><a data-action="delete">'+Craft.t("Delete")+"</a></li>").appendTo(i);new Garnish.MenuBtn(n,{onOptionSelect:e.proxy(this,"onTabOptionSelect")})}var s=t.children(".fld-tabcontent").children();for(var o=0;o<s.length;o++)this.initField(e(s[o]))},initField:function(t){var n=t.find(".settings"),r=e('<div class="menu" data-align="center"/>').insertAfter(n),i=e("<ul/>").appendTo(r);t.hasClass("fld-required")?e('<li><a data-action="toggle-required">'+Craft.t("Make not required")+"</a></li>").appendTo(i):e('<li><a data-action="toggle-required">'+Craft.t("Make required")+"</a></li>").appendTo(i);e('<li><a data-action="remove">'+Craft.t("Remove")+"</a></li>").appendTo(i);new Garnish.MenuBtn(n,{onOptionSelect:e.proxy(this,"onFieldOptionSelect")})},onTabOptionSelect:function(t){if(!this.settings.customizableTabs)return;var n=e(t),r=n.data("menu").$trigger.parent().parent().parent(),i=n.data("action");switch(i){case"rename":this.renameTab(r);break;case"delete":this.deleteTab(r)}},onFieldOptionSelect:function(t){var n=e(t),r=n.data("menu").$trigger.parent(),i=n.data("action");switch(i){case"toggle-required":this.toggleRequiredField(r,n);break;case"remove":this.removeField(r)}},renameTab:function(e){if(!this.settings.customizableTabs)return;var t=e.find(".tabs .tab span"),n=t.text(),r=prompt(Craft.t("Give your tab a name."),n);if(r&&r!=n){t.text(r);e.find(".id-input").attr("name","fieldLayout["+Craft.encodeUriComponent(r)+"][]")}},deleteTab:function(t){if(!this.settings.customizableTabs)return;var n=t.find(".fld-field");for(var r=0;r<n.length;r++){var i=e(n[r]).attr("data-id");this.removeFieldById(i)}this.tabGrid.removeItems(t);this.tabDrag.removeItems(t);t.remove()},toggleRequiredField:function(t,n){if(t.hasClass("fld-required")){t.removeClass("fld-required");t.find(".required-input").remove();setTimeout(function(){n.text(Craft.t("Make required"))},500)}else{t.addClass("fld-required");e('<input class="required-input" type="hidden" name="requiredFields[]" value="'+t.data("id")+'">').appendTo(t);setTimeout(function(){n.text(Craft.t("Make not required"))},500)}},removeField:function(e){var t=e.attr("data-id");e.remove();this.removeFieldById(t);this.tabGrid.refreshCols()},removeFieldById:function(e){var t=this.$allFields.filter("[data-id="+e+"]:first"),n=t.closest(".fld-tab");t.removeClass("hidden");if(n.hasClass("hidden")){n.removeClass("hidden");this.unusedFieldGrid.addItems(n);this.settings.customizableTabs&&this.tabDrag.addItems(n)}else this.unusedFieldGrid.refreshCols()},addTab:function(){if(!this.settings.customizableTabs)return;var t=e('<div class="fld-tab"><div class="tabs"><div class="tab sel draggable"><span>Tab '+(this.tabGrid.$items.length+1)+"</span>"+'<a class="settings icon" title="'+Craft.t("Rename")+'"></a>'+"</div>"+"</div>"+'<div class="fld-tabcontent"></div>'+"</div>").appendTo(this.$tabContainer);this.tabGrid.addItems(t);this.tabDrag.addItems(t);this.initTab(t)}},{gridSettings:{itemSelector:".fld-tab:not(.hidden)",minColWidth:240,percentageWidths:!1,fillMode:"grid",snapToGrid:30},defaults:{customizableTabs:!0}});Craft.FieldLayoutDesigner.BaseDrag=Garnish.Drag.extend({designer:null,$insertion:null,showingInsertion:!1,$caboose:null,draggingUnusedItem:!1,addToTabGrid:!1,init:function(e,t){this.designer=e;var n=this.designer.$tabContainer.find(this.itemSelector).add(this.designer.$unusedFieldContainer.find(this.itemSelector));this.base(n,t)},onDragStart:function(){this.base();this.draggingUnusedItem=this.$draggee.hasClass("unused");this.$insertion=this.getInsertion();this.addCaboose();this.$items=e().add(this.$items.add(this.$caboose));this.addToTabGrid&&this.designer.tabGrid.addItems(this.$caboose);if(this.draggingUnusedItem)this.showingInsertion=!1;else{this.$insertion.insertBefore(this.$draggee);this.$draggee.detach();this.$items=e().add(this.$items.not(this.$draggee).add(this.$insertion));this.showingInsertion=!0;if(this.addToTabGrid){this.designer.tabGrid.removeItems(this.$draggee);this.designer.tabGrid.addItems(this.$insertion)}}this.setMidpoints()},addCaboose:e.noop,getItemContainer:e.noop,isItemInTabContainer:function(e){return this.getItemContainer(e)[0]==this.designer.$tabContainer[0]},setMidpoints:function(){for(var t=0;t<this.$items.length;t++){var n=e(this.$items[t]);if(!this.isItemInTabContainer(n))continue;var r=n.offset();n.data("midpoint",{left:r.left+n.outerWidth()/2,top:r.top+n.outerHeight()/2})}},onDrag:function(){if(this.draggingUnusedItem&&!Garnish.hitTest(this.mouseX,this.mouseY,this.designer.$tabContainer)){if(this.showingInsertion){this.$insertion.remove();this.$items=e().add(this.$items.not(this.$insertion));this.showingInsertion=!1;this.addToTabGrid?this.designer.tabGrid.removeItems(this.$insertion):this.designer.tabGrid.refreshCols();this.setMidpoints()}}else{this.onDrag._closestItem=this.getClosestItem();if(this.onDrag._closestItem!=this.$insertion[0]){this.showingInsertion&&e.inArray(this.$insertion[0],this.$items)<e.inArray(this.onDrag._closestItem,this.$items)&&e.inArray(this.onDrag._closestItem,this.$caboose)==-1?this.$insertion.insertAfter(this.onDrag._closestItem):this.$insertion.insertBefore(this.onDrag._closestItem);this.$items=e().add(this.$items.add(this.$insertion));this.showingInsertion=!0;this.addToTabGrid?this.designer.tabGrid.addItems(this.$insertion):this.designer.tabGrid.refreshCols();this.setMidpoints()}}this.base()},getClosestItem:function(){this.getClosestItem._closestItem=null;this.getClosestItem._closestItemMouseDiff=null;for(this.getClosestItem._i=0;this.getClosestItem._i<this.$items.length;this.getClosestItem._i++){this.getClosestItem._$item=e(this.$items[this.getClosestItem._i]);if(!this.isItemInTabContainer(this.getClosestItem._$item))continue;this.getClosestItem._midpoint=this.getClosestItem._$item.data("midpoint");this.getClosestItem._mouseDiff=Garnish.getDist(this.getClosestItem._midpoint.left,this.getClosestItem._midpoint.top,this.mouseX,this.mouseY);if(this.getClosestItem._closestItem===null||this.getClosestItem._mouseDiff<this.getClosestItem._closestItemMouseDiff){this.getClosestItem._closestItem=this.getClosestItem._$item[0];this.getClosestItem._closestItemMouseDiff=this.getClosestItem._mouseDiff}}return this.getClosestItem._closestItem},onDragStop:function(){if(this.showingInsertion){this.$insertion.replaceWith(this.$draggee);this.$items=e().add(this.$items.not(this.$insertion).add(this.$draggee));if(this.addToTabGrid){this.designer.tabGrid.removeItems(this.$insertion);this.designer.tabGrid.addItems(this.$draggee)}}this.$items=this.$items.not(this.$caboose);this.$caboose.remove();this.addToTabGrid&&this.designer.tabGrid.removeItems(this.$caboose);this.$draggee.css({display:this.draggeeDisplay,visibility:"hidden"});this.designer.tabGrid.refreshCols();this.designer.unusedFieldGrid.refreshCols();this.returnHelpersToDraggees();this.base()}});Craft.FieldLayoutDesigner.TabDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab",addToTabGrid:!0,init:function(e){var t={handle:".tab"};this.base(e,t)},addCaboose:function(){this.$caboose=e('<div class="fld-tab fld-tab-caboose"/>').appendTo(this.designer.$tabContainer)},getInsertion:function(){var t=this.$draggee.find(".tab");return e('<div class="fld-tab fld-insertion" style="height: '+this.$draggee.height()+'px;">'+'<div class="tabs"><div class="tab sel draggable" style="width: '+t.width()+"px; height: "+t.height()+'px;"></div></div>'+'<div class="fld-tabcontent" style="height: '+this.$draggee.find(".fld-tabcontent").height()+'px;"></div>'+"</div>")},getItemContainer:function(e){return e.parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var t=this.$draggee.clone().removeClass("unused"),n=t.find(".tab span").text();t.find(".fld-field").removeClass("unused");t.find(".tabs .tab").append('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');var r=t.find(".fld-field"),i=r.filter(".hidden").remove();r=r.not(i);r.prepend('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');for(var s=0;s<r.length;s++){var o=e(r[s]);o.append('<input class="id-input" type="hidden" name="fieldLayout['+Craft.encodeUriComponent(n)+'][]" value="'+o.data("id")+'">')}this.designer.fieldDrag.addItems(r);this.designer.initTab(t);this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden");this.$draggee.find(".fld-field").addClass("hidden");this.$draggee=t;this.addItems(t);this.designer.tabGrid.addItems(t);this.designer.unusedFieldGrid.removeItems(this.$draggee)}this.base()}});Craft.FieldLayoutDesigner.FieldDrag=Craft.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab .fld-field",addCaboose:function(){this.$caboose=e();var t=this.designer.$tabContainer.children().children(".fld-tabcontent");for(var n=0;n<t.length;n++){var r=e('<div class="fld-tab fld-tab-caboose"/>').appendTo(t[n]);this.$caboose=this.$caboose.add(r)}},getInsertion:function(){return e('<div class="fld-field fld-insertion" style="height: '+this.$draggee.height()+'px;"/>')},getItemContainer:function(e){return e.parent().parent().parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var e=this.$draggee.clone().removeClass("unused");e.prepend('<a class="settings icon" title="'+Craft.t("Edit")+'"></a>');this.designer.initField(e);this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden");if(this.$draggee.siblings(":not(.hidden)").length==0){var t=this.$draggee.parent().parent();t.addClass("hidden");this.designer.unusedFieldGrid.removeItems(t)}this.$draggee=e;this.addItems(e)}if(this.showingInsertion){var n=this.$insertion.parent().parent().find(".tab span").text(),r="fieldLayout["+Craft.encodeUriComponent(n)+"][]";this.draggingUnusedItem?this.$draggee.append('<input class="id-input" type="hidden" name="'+r+'" value="'+this.$draggee.data("id")+'">'):this.$draggee.find(".id-input").attr("name",r)}this.base()}});Craft.FieldToggle=Garnish.Base.extend({$toggle:null,targetPrefix:null,targetSelector:null,reverseTargetSelector:null,_$target:null,_$reverseTarget:null,type:null,init:function(t){this.$toggle=e(t);if(this.$toggle.data("fieldtoggle")){Garnish.log("Double-instantiating a field toggle on an element");this.$toggle.data("fieldtoggle").destroy()}this.$toggle.data("fieldtoggle",this);this.type=this.getType();if(this.type=="select")this.targetPrefix=this.$toggle.attr("data-target-prefix")||"";else{this.targetSelector=this.normalizeTargetSelector(this.$toggle.data("target"));this.reverseTargetSelector=this.normalizeTargetSelector(this.$toggle.data("reverse-target"))}this.findTargets();this.type=="link"?this.addListener(this.$toggle,"click","onToggleChange"):this.addListener(this.$toggle,"change","onToggleChange")},normalizeTargetSelector:function(e){e&&!e.match(/^[#\.]/)&&(e="#"+e);return e},getType:function(){if(this.$toggle.prop("nodeName")=="INPUT"&&this.$toggle.attr("type").toLowerCase()=="checkbox")return"checkbox";if(this.$toggle.prop("nodeName")=="SELECT")return"select";if(this.$toggle.prop("nodeName")=="A")return"link"},findTargets:function(){if(this.type=="select")this._$target=e(this.normalizeTargetSelector(this.targetPrefix+this.getToggleVal()));else{this.targetSelector&&(this._$target=e(this.targetSelector));this.reverseTargetSelector&&(this._$reverseTarget=e(this.reverseTargetSelector))}},getToggleVal:function(){return Garnish.getInputPostVal(this.$toggle)},onToggleChange:function(){if(this.type=="select"){this.hideTarget(this._$target);this.findTargets();this.showTarget(this._$target)}else{if(this.type=="link")var e=this.$toggle.hasClass("collapsed")||!this.$toggle.hasClass("expanded");else var e=!!this.getToggleVal();if(e){this.showTarget(this._$target);this.hideTarget(this._$reverseTarget)}else{this.hideTarget(this._$target);this.showTarget(this._$reverseTarget)}}},showTarget:function(e){if(e&&e.length){e.removeClass("hidden");if(this.type!="select"){if(this.type=="link"){this.$toggle.removeClass("collapsed");this.$toggle.addClass("expanded")}e.height("auto");var t=e.height();e.height(0);e.stop().animate({height:t},"fast",function(){e.height("auto")})}}},hideTarget:function(e){if(e&&e.length)if(this.type=="select")e.addClass("hidden");else{if(this.type=="link"){this.$toggle.removeClass("expanded");this.$toggle.addClass("collapsed")}e.stop().animate({height:0},"fast",function(){e.addClass("hidden")})}}});Craft.Grid=Garnish.Base.extend({$container:null,$items:null,items:null,totalCols:null,colPctWidth:null,sizeUnit:null,possibleItemColspans:null,possibleItemPositionsByColspan:null,itemPositions:null,itemColspansByPosition:null,layouts:null,layout:null,itemHeights:null,leftPadding:null,init:function(t,n){this.$container=e(t);this.setSettings(n,Craft.Grid.defaults);this.settings.mode=="pct"?this.sizeUnit="%":this.sizeUnit="px";this.$items=this.$container.children(this.settings.itemSelector);this.setItems();this.refreshCols();this.addListener(this.$container,"resize","refreshCols");Garnish.$win.trigger("resize")},addItems:function(t){this.$items=e().add(this.$items.add(t));this.setItems();this.refreshCols()},removeItems:function(t){this.$items=e().add(this.$items.not(t));this.setItems();this.refreshCols()},setItems:function(){this.items=[];for(var t=0;t<this.$items.length;t++)this.items.push(e(this.$items[t]))},refreshCols:function(){if(!this.items.length)return;this.settings.cols?this.totalCols=this.settings.cols:this.totalCols=Math.floor(this.$container.width()/this.settings.minColWidth);this.totalCols==0&&(this.totalCols=1);if(this.settings.fillMode=="grid"){var t=0;while(t<this.items.length){var n=-1,r=0;for(var i=t;i<t+this.totalCols&&i<this.items.length;i++){var s=this.items[i].height("auto").height();s>n&&(n=s);r++}if(this.settings.snapToGrid){var o=n%this.settings.snapToGrid;o&&(n+=this.settings.snapToGrid-o)}for(var i=t;i<t+this.totalCols&&i<this.items.length;i++)this.items[i].height(n);t+=this.totalCols}}else{this.removeListener(this.$items,"resize");this.settings.mode=="pct"&&(this.colPctWidth=100/this.totalCols);this.layouts=[];this.itemPositions=[];this.itemColspansByPosition=[];this.possibleItemColspans=[];this.possibleItemPositionsByColspan=[];this.itemHeightsByColspan=[];for(var u=0;u<this.items.length;u++){this.possibleItemColspans[u]=[];this.possibleItemPositionsByColspan[u]={};this.itemHeightsByColspan[u]={};var a=this.items[u].show(),f=a.data("position")=="right",l=a.data("position")=="left",c=a.data("colspan")?a.data("colspan"):a.data("min-colspan")?a.data("min-colspan"):1,h=a.data("colspan")?a.data("colspan"):a.data("max-colspan")?a.data("max-colspan"):this.totalCols;c>this.totalCols&&(c=this.totalCols);h>this.totalCols&&(h=this.totalCols);for(var p=c;p<=h;p++){a.css("width",this.getItemWidth(p)+this.sizeUnit);this.itemHeightsByColspan[u][p]=a.outerHeight();this.possibleItemColspans[u].push(p);this.possibleItemPositionsByColspan[u][p]=[];if(l)var d=0,v=0;else if(f)var d=this.totalCols-p,v=d;else var d=0,v=this.totalCols-p;for(var m=d;m<=v;m++)this.possibleItemPositionsByColspan[u][p].push(m)}}var g=[];for(var i=0;i<this.totalCols;i++)g.push(0);this.createLayouts(0,[],[],g,0);var y=[];for(var i=0;i<this.layouts.length;i++)y.push(Math.max.apply(null,this.layouts[i].colHeights));var b=Math.min.apply(null,y),w=[],E=[];for(var i=0;i<y.length;i++)if(y[i]==b){w.push(this.layouts[i]);var S=this.layouts[i].emptySpace;for(var x=0;x<this.totalCols;x++)S+=b-this.layouts[i].colHeights[x];E.push(S)}this.layout=w[e.inArray(Math.min.apply(null,E),E)];var T=0;for(var i=this.layout.colHeights.length-1;i>=0;i--){if(this.layout.colHeights[i]!=0)break;T++}this.leftPadding=this.getItemWidth(T)/2;this.settings.mode=="fixed"&&(this.leftPadding+=(this.$container.width()-this.settings.minColWidth*this.totalCols)/2);this.positionItems();this.addListener(this.$items,"resize","onItemResize")}},getItemWidth:function(e){return this.settings.mode=="pct"?this.colPctWidth*e:this.settings.minColWidth*e},createLayouts:function(t,n,r,i,s){for(var o=0;o<this.possibleItemColspans[t].length;o++){var u=this.possibleItemColspans[t][o],a=[];for(var f=0;f<this.possibleItemPositionsByColspan[t][u].length;f++){var l=this.possibleItemPositionsByColspan[t][u][f],c=[],h=l+u-1;for(var p=l;p<=h;p++)c.push(i[p]);a[f]=Math.max.apply(null,c)}var f=e.inArray(Math.min.apply(null,a),a),l=this.possibleItemPositionsByColspan[t][u][f],d=n.slice(0),v=r.slice(0),m=i.slice(0),g=s;d.push(l);v.push(u);var y=a[f],h=l+u-1;for(var p=l;p<=h;p++){g+=y-m[p];m[p]=y+this.itemHeightsByColspan[t][u]}t==this.items.length-1?this.layouts.push({positions:d,colspans:v,colHeights:m,emptySpace:g}):this.createLayouts(t+1,d,v,m,g)}},positionItems:function(){var e=[];for(var t=0;t<this.totalCols;t++)e.push(0);for(var t=0;t<this.items.length;t++){var n=this.layout.positions[t]+this.layout.colspans[t]-1,r=[];for(var i=this.layout.positions[t];i<=n;i++)r.push(e[i]);var s=Math.max.apply(null,r),o={top:s,width:this.getItemWidth(this.layout.colspans[t])+this.sizeUnit};o[Craft.left]=this.leftPadding+this.getItemWidth(this.layout.positions[t])+this.sizeUnit;this.items[t].css(o);for(var i=this.layout.positions[t];i<=n;i++)e[i]=s+this.itemHeightsByColspan[t][this.layout.colspans[t]]}this.$container.css({height:Math.max.apply(null,e)})},onItemResize:function(t){t.stopPropagation();var n=e.inArray(t.currentTarget,this.$items);if(n!=-1){var r=this.items[n].outerHeight();if(r!=this.itemHeightsByColspan[n][this.layout.colspans[n]]){this.itemHeightsByColspan[n][this.layout.colspans[n]]=r;this.positionItems()}}}},{defaults:{itemSelector:".item",cols:null,minColWidth:320,mode:"pct",fillMode:"top",colClass:"col",snapToGrid:null}});Craft.HandleGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(e){var t=e.replace("/<(.*?)>/g","");t=t.replace(/['"‘’“”\[\]\(\)\{\}:]/g,"");t=t.toLowerCase();t=Craft.asciiString(t);t=t.replace(/^[^a-z]+/,"");var n=Craft.filterArray(t.split(/[^a-z0-9]+/)),t="";for(var r=0;r<n.length;r++)r==0?t+=n[r]:t+=n[r].charAt(0).toUpperCase()+n[r].substr(1);return t}});Craft.ImageUpload=Garnish.Base.extend({_imageHandler:null,init:function(e){this.setSettings(e,Craft.ImageUpload.defaults);this._imageHandler=new Craft.ImageHandler(e)}},{$modalContainerDiv:null,defaults:{postParameters:{},modalClass:"",uploadButton:{},uploadAction:"",deleteButton:{},deleteMessage:"",deleteAction:"",cropAction:"",areaToolOptions:{aspectRatio:"1:1",initialRectangle:{mode:"auto",x1:0,x2:0,y1:0,y2:0}},onImageDelete:function(e){location.reload()},onImageSave:function(e){location.reload()}}});Craft.ImageHandler=Garnish.Base.extend({modal:null,progressBar:null,$container:null,init:function(t){this.setSettings(t);var n=this,r=t.uploadButton,i=e('<input type="file" name="image-upload" id="image-upload" />').hide().insertBefore(r);this.progressBar=new Craft.ProgressBar(e('<div class="progress-shade"></div>').insertBefore(r));this.progressBar.$progressBar.css({top:Math.round(r.outerHeight()/2)-6});this.$container=r.parent();var s={url:Craft.getActionUrl(this.settings.uploadAction),fileInput:i,element:this.settings.uploadButton[0],action:Craft.actionUrl+"/"+this.settings.uploadAction,formData:this.settings.postParameters,events:{fileuploadstart:e.proxy(function(){this.$container.addClass("uploading");this.progressBar.resetProgressBar();this.progressBar.showProgressBar()},this),fileuploadprogressall:e.proxy(function(e){var t=parseInt(e.loaded/e.total*100,10);this.progressBar.setProgressPercentage(t)},this),fileuploaddone:e.proxy(function(r,i){this.progressBar.hideProgressBar();this.$container.removeClass("uploading");var s=i.result;Craft.ImageUpload.$modalContainerDiv==null&&(Craft.ImageUpload.$modalContainerDiv=e('<div class="modal fitted"></div>').addClass(t.modalClass).appendTo(Garnish.$bod));if(s.html){Craft.ImageUpload.$modalContainerDiv.empty().append(s.html);if(!this.modal){this.modal=new Craft.ImageModal(Craft.ImageUpload.$modalContainerDiv,{postParameters:t.postParameters,cropAction:t.cropAction});this.modal.imageHandler=n}else this.modal.show();this.modal.bindButtons();this.modal.addListener(this.modal.$saveBtn,"click","saveImage");this.modal.addListener(this.modal.$cancelBtn,"click","cancel");this.modal.removeListener(Garnish.Modal.$shade,"click");setTimeout(e.proxy(function(){Craft.ImageUpload.$modalContainerDiv.find("img").load(e.proxy(function(){var e=new Craft.ImageAreaTool(t.areaToolOptions);e.showArea(this.modal);this.modal.cropAreaTool=e},this))},this),1)}},this)},acceptFileTypes:/(jpg|jpeg|gif|png)/};this.uploader=new Craft.Uploader(r,s);e(t.deleteButton).click(function(){if(confirm(t.deleteMessage)){e(this).parent().append('<div class="blocking-modal"></div>');Craft.postActionRequest(t.deleteAction,t.postParameters,e.proxy(function(e,t){t=="success"&&n.onImageDelete.apply(n,[e])},this))}});e(t.uploadButton).on("click",function(t){e(this).siblings("input[type=file]").click()})},onImageSave:function(e){this.settings.onImageSave.apply(this,[e])},onImageDelete:function(e){this.settings.onImageDelete.apply(this,[e])}});Craft.ImageModal=Garnish.Modal.extend({$container:null,$saveBtn:null,$cancelBtn:null,areaSelect:null,factor:null,source:null,_postParameters:null,_cropAction:"",imageHandler:null,originalWidth:0,originalHeight:0,constraint:0,cropAreaTool:null,init:function(t,n){this.cropAreaTool=null;this.base(t,n);this._postParameters=n.postParameters;this._cropAction=n.cropAction;this.addListener(this.$container,"resize",e.proxy(this,"_onResize"));this.addListener(Garnish.$bod,"resize",e.proxy(this,"_onResize"))},_onResize:function(){var e=this.$container.find("img"),t=parseInt(this.$container.css("left"),10),n=parseInt(this.$container.css("top"),10),r=this.originalWidth/this.originalHeight,i=t-10,s=n-10;i/r>s?o=this.$container.width()+s*r:o=this.$container.width()+i;o=Math.min(o,this.constraint,this.constraint*r,this.originalWidth);this.$container.width(o);var o=this.$container.width(),u=o/this.originalWidth,a=this.originalHeight*u;e.height(a).width(o);this.factor=u;this.cropAreaTool&&e.imgAreaSelect({instance:!0}).update()},bindButtons:function(){this.$saveBtn=this.$container.find(".submit:first");this.$cancelBtn=this.$container.find(".cancel:first")},cancel:function(){this.hide();this.areaSelect.setOptions({remove:!0,hide:!0,disable:!0});this.$container.empty()},saveImage:function(){var t=this.areaSelect.getSelection(),n={x1:Math.round(t.x1/this.factor),x2:Math.round(t.x2/this.factor),y1:Math.round(t.y1/this.factor),y2:Math.round(t.y2/this.factor),source:this.source};n=e.extend(this._postParameters,n);Craft.postActionRequest(this._cropAction,n,e.proxy(function(e,t){t=="success"&&(e.error?Craft.cp.displayError(e.error):this.imageHandler.onImageSave.apply(this.imageHandler,[e]));this.hide();this.$container.empty();this.areaSelect.setOptions({remove:!0,hide:!0,disable:!0})},this));this.areaSelect.setOptions({disable:!0});this.removeListener(this.$saveBtn,"click");this.removeListener(this.$cancelBtn,"click");this.$container.find(".crop-image").fadeTo(50,.5)}});Craft.ImageAreaTool=
Garnish.Base.extend({$container:null,init:function(e){this.$container=Craft.ImageUpload.$modalContainerDiv;this.setSettings(e)},showArea:function(e){var t=this.$container.find("img"),n={aspectRatio:this.settings.aspectRatio,maxWidth:t.width(),maxHeight:t.height(),instance:!0,resizable:!0,show:!0,persistent:!0,handles:!0,parent:t.parent(),classPrefix:"imgareaselect"},r=t.imgAreaSelect(n),i=this.settings.initialRectangle.x1,s=this.settings.initialRectangle.x2,o=this.settings.initialRectangle.y1,u=this.settings.initialRectangle.y2;if(this.settings.initialRectangle.mode=="auto"){var a=this.settings.aspectRatio.split(":"),f=0,l=0;if(a[0]>a[1]){f=t.width();l=f*a[1]/a[0]}else if(a[0]>a[1]){l=t.height();f=l*a[0]/a[1]}else l=f=Math.min(t.width(),t.height());i=Math.round((t.width()-f)/2);o=Math.round((t.height()-l)/2);s=i+f;u=o+l}r.setSelection(i,o,s,u);r.update();e.areaSelect=r;e.factor=t.data("factor");e.originalHeight=t.attr("height")/e.factor;e.originalWidth=t.attr("width")/e.factor;e.constraint=t.data("constraint");e.source=t.attr("src").split("/").pop();e.updateSizeAndPosition()}});Craft.InfoIcon=Garnish.Base.extend({$icon:null,hud:null,init:function(t){this.$icon=e(t);this.addListener(this.$icon,"click","showHud")},showHud:function(){this.hud?this.hud.show():this.hud=new Garnish.HUD(this.$icon,this.$icon.html(),{hudClass:"hud info-hud"})}});Craft.LightSwitch=Garnish.Base.extend({settings:null,$outerContainer:null,$innerContainer:null,$input:null,$toggleTarget:null,on:null,dragger:null,dragStartMargin:null,init:function(t,n){this.$outerContainer=e(t);if(this.$outerContainer.data("lightswitch")){Garnish.log("Double-instantiating a lightswitch on an element");this.$outerContainer.data("lightswitch").destroy()}this.$outerContainer.data("lightswitch",this);this.setSettings(n,Craft.LightSwitch.defaults);this.$innerContainer=this.$outerContainer.find(".lightswitch-container:first");this.$input=this.$outerContainer.find("input:first");this.$toggleTarget=e(this.$outerContainer.attr("data-toggle"));this.on=this.$outerContainer.hasClass("on");this.addListener(this.$outerContainer,"mousedown","_onMouseDown");this.addListener(this.$outerContainer,"keydown","_onKeyDown");this.dragger=new Garnish.BaseDrag(this.$outerContainer,{axis:Garnish.X_AXIS,ignoreHandleSelector:null,onDragStart:e.proxy(this,"_onDragStart"),onDrag:e.proxy(this,"_onDrag"),onDragStop:e.proxy(this,"_onDragStop")})},turnOn:function(){this.$outerContainer.addClass("dragging");var t={};t["margin-"+Craft.left]=0;this.$innerContainer.stop().animate(t,Craft.LightSwitch.animationDuration,e.proxy(this,"_onSettle"));this.$input.val("1");this.$outerContainer.addClass("on");this.on=!0;this.settings.onChange();this.$toggleTarget.show();this.$toggleTarget.height("auto");var n=this.$toggleTarget.height();this.$toggleTarget.height(0);this.$toggleTarget.stop().animate({height:n},Craft.LightSwitch.animationDuration,e.proxy(function(){this.$toggleTarget.height("auto")},this))},turnOff:function(){this.$outerContainer.addClass("dragging");var t={};t["margin-"+Craft.left]=Craft.LightSwitch.offMargin;this.$innerContainer.stop().animate(t,Craft.LightSwitch.animationDuration,e.proxy(this,"_onSettle"));this.$input.val("");this.$outerContainer.removeClass("on");this.on=!1;this.settings.onChange();this.$toggleTarget.stop().animate({height:0},Craft.LightSwitch.animationDuration)},toggle:function(e){this.on?this.turnOff():this.turnOn()},_onMouseDown:function(){this.addListener(Garnish.$doc,"mouseup","_onMouseUp")},_onMouseUp:function(){this.removeListener(Garnish.$doc,"mouseup");this.dragger.dragging||this.toggle()},_onKeyDown:function(e){switch(e.keyCode){case Garnish.SPACE_KEY:this.toggle();e.preventDefault();break;case Garnish.RIGHT_KEY:Craft.orientation=="ltr"?this.turnOn():this.turnOff();e.preventDefault();break;case Garnish.LEFT_KEY:Craft.orientation=="ltr"?this.turnOff():this.turnOn();e.preventDefault()}},_getMargin:function(){return parseInt(this.$innerContainer.css("margin-"+Craft.left))},_onDragStart:function(){this.$outerContainer.addClass("dragging");this.dragStartMargin=this._getMargin()},_onDrag:function(){if(Craft.orientation=="ltr")var e=this.dragStartMargin+this.dragger.mouseDistX;else var e=this.dragStartMargin-this.dragger.mouseDistX;e<Craft.LightSwitch.offMargin?e=Craft.LightSwitch.offMargin:e>0&&(e=0);this.$innerContainer.css("margin-"+Craft.left,e)},_onDragStop:function(){var e=this._getMargin();e>Craft.LightSwitch.offMargin/2?this.turnOn():this.turnOff()},_onSettle:function(){this.$outerContainer.removeClass("dragging")},destroy:function(){this.base();this.dragger.destroy()}},{offMargin:-9,animationDuration:100,defaults:{onChange:e.noop}});Craft.Pane=Garnish.Base.extend({$pane:null,$content:null,$sidebar:null,$sidebarBtn:null,tabs:null,selectedTab:null,hasSidebar:null,showingSidebar:null,peekingSidebar:null,fixedSidebar:null,init:function(t){this.$pane=e(t);if(this.$pane.data("pane")){Garnish.log("Double-instantiating a pane on an element");this.$pane.data("pane").destroy()}this.$pane.data("pane",this);this.$content=this.$pane.find(".content:not(.hidden):first");var n=this.$pane.children(".tabs"),r=n.find("a");if(r.length){this.tabs={};for(var i=0;i<r.length;i++){var s=e(r[i]),o=s.attr("href");if(o&&o.charAt(0)=="#"){this.tabs[o]={$tab:s,$target:e(o)};this.addListener(s,"activate","selectTab")}!this.selectedTab&&s.hasClass("sel")&&(this.selectedTab=o)}document.location.hash&&typeof this.tabs[document.location.hash]!="undefined"?this.tabs[document.location.hash].$tab.trigger("activate"):this.selectedTab||e(r[0]).trigger("activate")}this.initContent()},selectTab:function(t){if(!this.selectedTab||t.currentTarget!=this.tabs[this.selectedTab].$tab[0]){this.deselectTab();var n=e(t.currentTarget).addClass("sel");this.selectedTab=n.attr("href");var r=this.tabs[this.selectedTab].$target;r.removeClass("hidden");if(r.hasClass("content")){if(this.hasSidebar){this.removeListener(this.$content,"resize");this.removeListener(this.$sidebar,"resize");this.removeListener(Garnish.$win,"scroll resize")}this.$content=r;this.initContent()}Garnish.$win.trigger("resize")}},deselectTab:function(){if(this.selectedTab){this.tabs[this.selectedTab].$tab.removeClass("sel");this.tabs[this.selectedTab].$target.addClass("hidden")}},initContent:function(){this.hasSidebar=this.$content.hasClass("has-sidebar");if(this.hasSidebar){this.$sidebar=this.$content.children(".sidebar");this.showingSidebar=!0;this.updateResponsiveSidebar();this.addListener(this.$content,"resize",function(){this.updateResponsiveSidebar();this.updateSidebarStyles()});this.addListener(this.$sidebar,"resize","setMinContentSizeForSidebar");this.setMinContentSizeForSidebar();this.addListener(Garnish.$win,"scroll resize","updateSidebarStyles");this.updateSidebarStyles()}},updateResponsiveSidebar:function(){this.$content.width()+parseInt(this.$content.css("margin-"+Craft.left))<Craft.Pane.minContentWidthForSidebar?this.showingSidebar&&this.hideSidebar():this.showingSidebar||this.showSidebar()},showSidebar:function(){this.$content.removeClass("hiding-sidebar");this.$sidebarBtn.remove();this.showingSidebar=!0;this.updateSidebarStyles();this.setMinContentSizeForSidebar();this.peekingSidebar&&this.stopPeeking()},hideSidebar:function(){this.$content.addClass("hiding-sidebar");this.$sidebarBtn=e('<a class="show-sidebar" title="'+Craft.t("Show sidebar")+'"></a>').appendTo(this.$content);this.addListener(this.$sidebarBtn,"click","togglePeekingSidebar");this.showingSidebar=!1;this.setMinContentSizeForSidebar()},togglePeekingSidebar:function(){this.peekingSidebar?this.stopPeeking():this.startPeeking();this.setMinContentSizeForSidebar()},startPeeking:function(){this.$content.animateLeft(194,"fast");this.$sidebarBtn.addClass("showing").attr("title",Craft.t("Hide sidebar"));this.peekingSidebar=!0;this.updateSidebarStyles();this.addListener(this.$sidebar,"click",e.proxy(function(e){e.target.nodeName=="A"&&this.togglePeekingSidebar()},this))},stopPeeking:function(){this.$content.animateLeft(0,"fast");this.$sidebarBtn.removeClass("showing").attr("title",Craft.t("Show sidebar"));this.peekingSidebar=!1;this.removeListener(this.$sidebar,"click")},setMinContentSizeForSidebar:function(){this.showingSidebar||this.peekingSidebar?this.setMinContentSizeForSidebar._minHeight=this.$sidebar.prop("scrollHeight")-48:this.setMinContentSizeForSidebar._minHeight=0;this.$content.css("min-height",this.setMinContentSizeForSidebar._minHeight)},updateSidebarStyles:function(){if(this.showingSidebar||this.peekingSidebar){this.updateSidebarStyles._styles={};this.updateSidebarStyles._scrollTop=Garnish.$win.scrollTop();this.updateSidebarStyles._contentOffset=this.$content.offset().top;this.updateSidebarStyles._contentHeight=this.$content.height()-24;this.updateSidebarStyles._windowHeight=Garnish.$win.height();this.updateSidebarStyles._scrollTop>this.updateSidebarStyles._contentOffset-24?this.updateSidebarStyles._styles.top=this.updateSidebarStyles._scrollTop-this.updateSidebarStyles._contentOffset:this.updateSidebarStyles._styles.top=-24;this.updateSidebarStyles._styles.maxHeight=Math.min(this.updateSidebarStyles._contentHeight-this.updateSidebarStyles._styles.top,this.updateSidebarStyles._windowHeight-48);if(this.updateSidebarStyles._styles.top!=0&&this.updateSidebarStyles._styles.maxHeight<100){this.updateSidebarStyles.newTop=Math.max(-24,this.updateSidebarStyles._styles.top-(100-this.updateSidebarStyles._styles.maxHeight));this.updateSidebarStyles._styles.maxHeight+=this.updateSidebarStyles._styles.top-this.updateSidebarStyles.newTop;this.updateSidebarStyles._styles.top=this.updateSidebarStyles.newTop}this.$sidebar.css(this.updateSidebarStyles._styles)}},destroy:function(){this.base();this.$pane.data("pane",null)}},{minContentWidthForSidebar:514});Craft.PasswordInput=Garnish.Base.extend({$passwordInput:null,$textInput:null,$currentInput:null,$showPasswordToggle:null,showingPassword:null,init:function(t,n){this.$passwordInput=e(t);this.settings=e.extend({},Craft.PasswordInput.defaults,n);if(this.$passwordInput.data("passwordInput")){Garnish.log("Double-instantiating a password input on an element");this.$passwordInput.data("passwordInput").destroy()}this.$passwordInput.data("passwordInput",this);this.$showPasswordToggle=e("<a/>").hide();this.$showPasswordToggle.addClass("password-toggle");this.$showPasswordToggle.insertAfter(this.$passwordInput);this.addListener(this.$showPasswordToggle,"mousedown","onToggleMouseDown");this.hidePassword()},setCurrentInput:function(e){if(this.$currentInput){e.addClass("focus");this.$currentInput.replaceWith(e);e.focus();e.removeClass("focus");e.val(this.$currentInput.val())}this.$currentInput=e;this.addListener(this.$currentInput,"keypress,keyup,change,blur","onInputChange")},updateToggleLabel:function(e){this.$showPasswordToggle.text(e)},showPassword:function(){if(this.showingPassword)return;if(!this.$textInput){this.$textInput=this.$passwordInput.clone(!0);this.$textInput.attr("type","text")}this.setCurrentInput(this.$textInput);this.updateToggleLabel(Craft.t("Hide"));this.showingPassword=!0},hidePassword:function(){if(this.showingPassword===!1)return;this.setCurrentInput(this.$passwordInput);this.updateToggleLabel(Craft.t("Show"));this.showingPassword=!1;this.addListener(this.$passwordInput,"keydown","onKeyDown")},togglePassword:function(){this.showingPassword?this.hidePassword():this.showPassword();this.settings.onToggleInput(this.$currentInput)},onKeyDown:function(e){if(e.keyCode==Garnish.ALT_KEY&&this.$currentInput.val()){this.showPassword();this.$showPasswordToggle.hide();this.addListener(this.$textInput,"keyup","onKeyUp")}},onKeyUp:function(e){e.preventDefault();if(e.keyCode==Garnish.ALT_KEY){this.hidePassword();this.$showPasswordToggle.show()}},onInputChange:function(){this.$currentInput.val()?this.$showPasswordToggle.show():this.$showPasswordToggle.hide()},onToggleMouseDown:function(e){e.preventDefault();if(this.$currentInput[0].setSelectionRange)var t=this.$currentInput[0].selectionStart,n=this.$currentInput[0].selectionEnd;this.togglePassword();this.$currentInput[0].setSelectionRange&&this.$currentInput[0].setSelectionRange(t,n)}},{defaults:{onToggleInput:e.noop}});Craft.ProgressBar=Garnish.Base.extend({$progressBar:null,$innerProgressBar:null,_itemCount:0,_processedItemCount:0,init:function(t){this.$progressBar=e('<div class="progressbar pending hidden"/>').appendTo(t);this.$innerProgressBar=e('<div class="progressbar-inner"/>').appendTo(this.$progressBar);this.resetProgressBar()},resetProgressBar:function(){this.setProgressPercentage(100);this.$progressBar.addClass("pending");this.setItemCount(1);this.setProcessedItemCount(0)},hideProgressBar:function(){this.$progressBar.fadeTo("fast",.01,e.proxy(function(){this.$progressBar.addClass("hidden").fadeTo(1,1,e.noop)},this))},showProgressBar:function(){this.$progressBar.removeClass("hidden")},setItemCount:function(e){this._itemCount=e},incrementItemCount:function(e){this._itemCount+=e},setProcessedItemCount:function(e){this._processedItemCount=e},incrementProcessedItemCount:function(e){this._processedItemCount+=e},updateProgressBar:function(){this._itemCount=Math.max(this._itemCount,1);var e=Math.min(100,Math.round(100*this._processedItemCount/this._itemCount));this.setProgressPercentage(e)},setProgressPercentage:function(e,t){if(e==0)this.$progressBar.addClass("pending");else{this.$progressBar.removeClass("pending");t?this.$innerProgressBar.stop().animate({width:e+"%"},"fast"):this.$innerProgressBar.stop().width(e+"%")}}});Craft.PromptHandler=Garnish.Base.extend({$modalContainerDiv:null,$prompt:null,$promptApplyToRemainingContainer:null,$promptApplyToRemainingCheckbox:null,$promptApplyToRemainingLabel:null,$promptButtons:null,_prompts:[],_promptBatchCallback:e.noop,_promptBatchReturnData:[],_promptBatchNum:0,init:function(){},resetPrompts:function(){this._prompts=[];this._promptBatchCallback=e.noop;this._promptBatchReturnData=[];this._promptBatchNum=0},addPrompt:function(e){this._prompts.push(e)},getPromptCount:function(){return this._prompts.length},showBatchPrompts:function(e){this._promptBatchCallback=e;this._promptBatchReturnData=[];this._promptBatchNum=0;this._showNextPromptInBatch()},_showNextPromptInBatch:function(){var t=this._prompts[this._promptBatchNum].prompt,n=this._prompts.length-(this._promptBatchNum+1);this._showPrompt(t.message,t.choices,e.proxy(this,"_handleBatchPromptSelection"),n)},_handleBatchPromptSelection:function(t,n){var r=this._prompts[this._promptBatchNum],i=this._prompts.length-(this._promptBatchNum+1),s=e.extend(r,{choice:t});this._promptBatchReturnData.push(s);if(i){this._promptBatchNum++;n?this._handleBatchPromptSelection(t,!0):this._showNextPromptInBatch()}else typeof this._promptBatchCallback=="function"&&this._promptBatchCallback(this._promptBatchReturnData)},_showPrompt:function(t,n,r,i){this._promptCallback=r;this.modal==null&&(this.modal=new Garnish.Modal({closeOtherModals:!1}));this.$modalContainerDiv==null&&(this.$modalContainerDiv=e('<div class="modal fitted prompt-modal"></div>').addClass().appendTo(Garnish.$bod));this.$prompt=e('<div class="body"></div>').appendTo(this.$modalContainerDiv.empty());this.$promptMessage=e('<p class="prompt-msg"/>').appendTo(this.$prompt);e("<p>").html(Craft.t("What do you want to do?")).appendTo(this.$prompt);this.$promptApplyToRemainingContainer=e('<label class="assets-applytoremaining"/>').appendTo(this.$prompt).hide();this.$promptApplyToRemainingCheckbox=e('<input type="checkbox"/>').appendTo(this.$promptApplyToRemainingContainer);this.$promptApplyToRemainingLabel=e("<span/>").appendTo(this.$promptApplyToRemainingContainer);this.$promptButtons=e('<div class="buttons"/>').appendTo(this.$prompt);this.modal.setContainer(this.$modalContainerDiv);this.$promptMessage.html(t);for(var s=0;s<n.length;s++){var o=e('<div class="btn" data-choice="'+n[s].value+'">'+n[s].title+"</div>");this.addListener(o,"activate",function(e){var t=e.currentTarget.getAttribute("data-choice"),n=this.$promptApplyToRemainingCheckbox.prop("checked");this._selectPromptChoice(t,n)});this.$promptButtons.append(o)}if(i){this.$promptApplyToRemainingContainer.show();this.$promptApplyToRemainingLabel.html(" "+Craft.t("Apply this to the {number} remaining conflicts?",{number:i}))}this.modal.show();this.modal.removeListener(Garnish.Modal.$shade,"click");this.addListener(Garnish.Modal.$shade,"click","_cancelPrompt")},_selectPromptChoice:function(t,n){this.$prompt.fadeOut("fast",e.proxy(function(){this.modal.hide();this._promptCallback(t,n)},this))},_cancelPrompt:function(){this._selectPromptChoice("cancel",!0)}});Craft.SlugGenerator=Craft.BaseInputGenerator.extend({generateTargetValue:function(e){e=e.replace(/<(.*?)>/g,"");e=e.replace(/['"‘’“”\[\]\(\)\{\}:]/g,"");e=e.toLowerCase();var t=Craft.filterArray(XRegExp.matchChain(e,[XRegExp("[\\p{L}\\p{N}\\.]+")]));return t.length?t.join(Craft.slugWordSeparator):""}});Craft.Structure=Garnish.Base.extend({id:null,$container:null,state:null,structureDrag:null,init:function(t,n,r){this.id=t;this.$container=e(n);this.setSettings(r,Craft.Structure.defaults);if(this.$container.data("structure")){Garnish.log("Double-instantiating a structure on an element");this.$container.data("structure").destroy()}this.$container.data("structure",this);this.state={};this.settings.storageKey&&e.extend(this.state,Craft.getLocalStorage(this.settings.storageKey,{}));typeof this.state.collapsedElementIds=="undefined"&&(this.state.collapsedElementIds=[]);var i=this.$container.find("ul").prev(".row");for(var s=0;s<i.length;s++){var o=e(i[s]),u=o.parent(),a=e('<div class="toggle" title="'+Craft.t("Show/hide children")+'"/>').prependTo(o);e.inArray(o.children(".element").data("id"),this.state.collapsedElementIds)!=-1&&u.addClass("collapsed");this.initToggle(a)}this.settings.sortable&&(this.structureDrag=new Craft.StructureDrag(this,this.settings.maxLevels));this.settings.newChildUrl&&this.initNewChildMenus(this.$container.find(".add"))},initToggle:function(t){t.click(e.proxy(function(t){var n=e(t.currentTarget).closest("li"),r=n.children(".row").find(".element:first").data("id"),i=e.inArray(r,this.state.collapsedElementIds);if(n.hasClass("collapsed")){n.removeClass("collapsed");i!=-1&&this.state.collapsedElementIds.splice(i,1)}else{n.addClass("collapsed");i==-1&&this.state.collapsedElementIds.push(r)}this.settings.storageKey&&Craft.setLocalStorage(this.settings.storageKey,this.state)},this))},initNewChildMenus:function(e){this.addListener(e,"click","onNewChildMenuClick")},onNewChildMenuClick:function(t){var n=e(t.currentTarget);if(!n.data("menubtn")){var r=n.parent().children(".element").data("id"),i=Craft.getUrl(this.settings.newChildUrl,"parentId="+r),s=e('<div class="menu"><ul><li><a href="'+i+'">'+Craft.t("New child")+"</a></li></ul></div>").insertAfter(n),o=new Garnish.MenuBtn(n);o.showMenu()}},getIndent:function(e){return Craft.Structure.baseIndent+(e-1)*Craft.Structure.nestedIndent},addElement:function(t){var n=e('<li data-level="1"/>').appendTo(this.$container),r=e('<div class="row" style="margin-'+Craft.left+": -"+Craft.Structure.baseIndent+"px; padding-"+Craft.left+": "+Craft.Structure.baseIndent+'px;">').appendTo(n);r.append(t);if(this.settings.sortable){r.append('<a class="move icon" title="'+Craft.t("Move")+'"></a>');this.structureDrag.addItems(n)}if(this.settings.newChildUrl){var i=e('<a class="add icon" title="'+Craft.t("New Child")+'"></a>').appendTo(r);this.initNewChildMenus(i)}r.css("margin-bottom",-30);r.animate({"margin-bottom":0},"fast")},removeElement:function(t){var n=t.parent().parent();this.settings.sortable&&this.structureDrag.removeItems(n);if(!n.siblings().length)var r=n.parent();n.css("visibility","hidden").animate({marginBottom:-n.height()},"fast",e.proxy(function(){n.remove();typeof r!="undefined"&&this._removeUl(r)},this))},_removeUl:function(e){e.siblings(".row").children(".toggle").remove();e.remove()}},{baseIndent:8,nestedIndent:35,defaults:{storageKey:null,sortable:!1,newChildUrl:null,maxLevels:null}});Craft.StructureDrag=Garnish.Drag.extend({structure:null,maxLevels:null,draggeeLevel:null,$helperLi:null,$targets:null,draggeeHeight:null,init:function(t,n){this.structure=t;this.maxLevels=n;this.$insertion=e('<li class="draginsertion"/>');var r=this.structure.$container.find("li");this.base(r,{handle:".element:first, .move:first",helper:e.proxy(this,"getHelper")})},getHelper:function(t){this.$helperLi=t;var n=e('<ul class="structure draghelper"/>').append(t);t.css("padding-"+Craft.left,this.$draggee.css("padding-"+Craft.left));t.find(".move").removeAttr("title");return n},onDragStart:function(){this.$targets=e();this.findTargets(this.structure.$container);this.draggeeLevel=0;var t=this.$draggee;do{this.draggeeLevel++;t=t.find("> ul > li")}while(t.length);this.draggeeHeight=this.$draggee.height();this.$draggee.animate({height:0},"fast",e.proxy(function(){this.$draggee.addClass("hidden")},this));this.base();this.addListener(Garnish.$doc,"keydown",function(e){e.keyCode==Garnish.ESC_KEY&&this.cancelDrag()})},findTargets:function(t){var n=t.children().not(this.$draggee);for(var r=0;r<n.length;r++){var i=e(n[r]);this.$targets=this.$targets.add(i.children(".row"));i.hasClass("collapsed")||this.findTargets(i.children("ul"))}},onDrag:function(){if(this._.$closestTarget){this._.$closestTarget.removeClass("draghover");this.$insertion.remove()}this._.$closestTarget=null;this._.closestTargetPos=null;this._.closestTargetYDiff=null;this._.closestTargetOffset=null;this._.closestTargetHeight=null;for(this._.i=0;this._.i<this.$targets.length;this._.i++){this._.$target=e(this.$targets[this._.i]);this._.targetOffset=this._.$target.offset();this._.targetHeight=this._.$target.outerHeight();this._.targetYMidpoint=this._.targetOffset.top+this._.targetHeight/2;this._.targetYDiff=Math.abs(this.mouseY-this._.targetYMidpoint);if(!(this._.i==0||this.mouseY>=this._.targetOffset.top+5&&this._.targetYDiff<this._.closestTargetYDiff))break;this._.$closestTarget=this._.$target;this._.closestTargetPos=this._.i;this._.closestTargetYDiff=this._.targetYDiff;this._.closestTargetOffset=this._.targetOffset;this._.closestTargetHeight=this._.targetHeight}if(!this._.$closestTarget)return;if(this._.closestTargetPos==0&&this.mouseY<this._.closestTargetOffset.top+5)this.$insertion.prependTo(this.structure.$container);else{this._.$closestTargetLi=this._.$closestTarget.parent();this._.closestTargetLevel=this._.$closestTargetLi.data("level");if(this._.closestTargetPos<this.$targets.length-1){this._.$nextTargetLi=e(this.$targets[this._.closestTargetPos+1]).parent();this._.nextTargetLevel=this._.$nextTargetLi.data("level")}else{this._.$nextTargetLi=null;this._.nextTargetLevel=null}this._.hoveringBetweenRows=this.mouseY>=this._.closestTargetOffset.top+this._.closestTargetHeight-5;if(this._.$nextTargetLi&&this._.nextTargetLevel==this._.closestTargetLevel)this._.hoveringBetweenRows?(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel-1)&&this.$insertion.insertAfter(this._.$closestTargetLi):(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel)&&this._.$closestTarget.addClass("draghover");else if(this._.$nextTargetLi&&this._.nextTargetLevel>this._.closestTargetLevel){if(!this.maxLevels||this.maxLevels>=this._.nextTargetLevel+this.draggeeLevel-1)if(this._.hoveringBetweenRows)this.$insertion.insertBefore(this._.$nextTargetLi);else{this._.$closestTarget.addClass("draghover");this.$insertion.appendTo(this._.$closestTargetLi.children("ul"))}}else if(this._.hoveringBetweenRows){this._.draggeeX=this.mouseX-this.targetItemMouseDiffX;Craft.orientation=="rtl"&&(this._.draggeeX+=this.$helperLi.width());this._.$parentLis=this._.$closestTarget.parentsUntil(this.structure.$container,"li");this._.$closestParentLi=null;this._.closestParentLiXDiff=null;this._.closestParentLevel=null;for(this._.i=0;this._.i<this._.$parentLis.length;this._.i++){this._.$parentLi=e(this._.$parentLis[this._.i]);this._.parentLiX=this._.$parentLi.offset().left;Craft.orientation=="rtl"&&(this._.parentLiX+=this._.$parentLi.width());this._.parentLiXDiff=Math.abs(this._.parentLiX-this._.draggeeX);this._.parentLevel=this._.$parentLi.data("level");if((!this.maxLevels||this.maxLevels>=this._.parentLevel+this.draggeeLevel-1)&&(!this._.$closestParentLi||this._.parentLiXDiff<this._.closestParentLiXDiff&&(!this._.$nextTargetLi||this._.parentLevel>=this._.nextTargetLevel))){this._.$closestParentLi=this._.$parentLi;this._.closestParentLiXDiff=this._.parentLiXDiff;this._.closestParentLevel=this._.parentLevel}}this._.$closestParentLi&&this.$insertion.insertAfter(this._.$closestParentLi)}else(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel)&&this._.$closestTarget.addClass("draghover")}},cancelDrag:function(){this.$insertion.remove();this._.$closestTarget&&this._.$closestTarget.removeClass("draghover");this.onMouseUp()},onDragStop:function(){if(this._.$closestTarget&&(this.$insertion.parent().length||this._.$closestTarget.hasClass("draghover"))){if(!this.$draggee.siblings().length)var t=this.$draggee.parent();else var t=null;if(this.$insertion.parent().length){var n=this.$insertion.next().add(this.$insertion.prev());if(e.inArray(this.$draggee[0],n)==-1){this.$insertion.replaceWith(this.$draggee);var r=!0}else{this.$insertion.remove();var r=!1}}else{var i=this._.$closestTargetLi.children("ul");if(!t||!i.length||i[0]!=t[0]){if(!i.length){var s=e('<div class="toggle" title="'+Craft.t("Show/hide children")+'"/>').prependTo(this._.$closestTarget);this.structure.initToggle(s);i=e("<ul>").appendTo(this._.$closestTargetLi)}else this._.$closestTargetLi.hasClass("collapsed")&&this._.$closestTarget.children(".toggle").trigger("click");this.$draggee.appendTo(i);var r=!0}else var r=!1}this._.$closestTarget.removeClass("draghover");if(r){t&&this.structure._removeUl(t);var o=this.$draggee.parentsUntil(this.structure.$container,"li").length+1;if(o!=this.$draggee.data("level")){if(this.$draggee.data("level")==1){var u={};u["padding-"+Craft.left]=38;this.$helperLi.animate(u,"fast")}else if(o==1){var u={};u["padding-"+Craft.left]=Craft.Structure.baseIndent;this.$helperLi.animate(u,"fast")}this.setLevel(this.$draggee,o)}var a={structureId:this.structure.id,elementId:this.$draggee.children(".row").children(".element").data("id"),prevId:this.$draggee.prev().children(".row").children(".element").data("id"),parentId:this.$draggee.parent("ul").parent("li").children(".row").children(".element").data("id")};Craft.postActionRequest("structures/moveElement",a,function(e,t){t=="success"&&Craft.cp.displayNotice(Craft.t("New order saved."))})}}this.$draggee.stop().removeClass("hidden").animate({height:this.draggeeHeight},"fast",e.proxy(function(){this.$draggee.css("height","auto")},this));this.returnHelpersToDraggees();this.base()},setLevel:function(t,n){t.data("level",n);var r=this.structure.getIndent(n),i={};i["margin-"+Craft.left]="-"+r+"px";i["padding-"+Craft.left]=r+"px";this.$draggee.children(".row").css(i);var s=t.children("ul").children();for(var o=0;o<s.length;o++)this.setLevel(e(s[o]),n+1)}});Craft.TagSelectInput=Craft.BaseElementSelectInput.extend({id:null,name:null,tagGroupId:null,sourceElementId:null,elementSort:null,searchTimeout:null,searchMenu:null,$container:null,$elementsContainer:null,$elements:null,$addTagInput:null,$spinner:null,init:function(t,n,r,i){this.id=t;this.name=n;this.tagGroupId=r;this.sourceElementId=i;this.$container=e("#"+this.id);this.$elementsContainer=this.$container.children(".elements");this.$elements=this.$elementsContainer.children();this.$addTagInput=this.$container.children(".add").children(".text");this.$spinner=this.$addTagInput.next();this.totalElements=this.$elements.length;this.elementSelect=new Garnish.Select(this.$elements,{multi:!0,filter:":not(.delete)"});this.elementSort=new Garnish.DragSort({container:this.$elementsContainer,filter:e.proxy(function(){return this.elementSelect.getSelectedItems()},this),caboose:e('<div class="caboose"/>'),onSortChange:e.proxy(function(){this.elementSelect.resetItemOrder()},this)});this.initElements(this.$elements);this.addListener(this.$addTagInput,"textchange",e.proxy(function(){this.searchTimeout&&clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(e.proxy(this,"searchForTags"),500)},this));this.addListener(this.$addTagInput,"keypress",function(e){if(e.keyCode==Garnish.RETURN_KEY){e.preventDefault();this.searchMenu&&this.selectTag(this.searchMenu.$options[0])}});this.addListener(this.$addTagInput,"focus",function(){this.searchMenu&&this.searchMenu.show()});this.addListener(this.$addTagInput,"blur",function(){setTimeout(e.proxy(function(){this.searchMenu&&this.searchMenu.hide()},this),1)})},searchForTags:function(){this.searchMenu&&this.killSearchMenu();var t=this.$addTagInput.val();if(t){this.$spinner.removeClass("hidden");var n=[];for(var r=0;r<this.$elements.length;r++){var i=e(this.$elements[r]).data("id");i&&n.push(i)}this.sourceElementId&&n.push(this.sourceElementId);var s={search:this.$addTagInput.val(),tagGroupId:this.tagGroupId,excludeIds:n};Craft.postActionRequest("tags/searchForTags",s,e.proxy(function(t,n){this.$spinner.addClass("hidden");if(n=="success"){var r=e('<div class="menu tagmenu"/>').appendTo(Garnish.$bod),i=e("<ul/>").appendTo(r);for(var o=0;o<t.tags.length;o++){var u=e("<li/>").appendTo(i);e('<a data-icon="tag"/>').appendTo(u).text(t.tags[o].name).data("id",t.tags[o].id)}if(!t.exactMatch){var u=e("<li/>").appendTo(i);e('<a data-icon="+"/>').appendTo(u).text(s.search)}i.find("> li:first-child > a").addClass("hover");this.searchMenu=new Garnish.Menu(r,{attachToElement:this.$addTagInput,onOptionSelect:e.proxy(this,"selectTag")});this.searchMenu.show()}},this))}else this.$spinner.addClass("hidden")},selectTag:function(t){var n=e(t),r=n.data("id"),i=n.text(),s=e('<div class="element removable" data-id="'+r+'" data-editable="1"/>').appendTo(this.$elementsContainer),o=e('<input type="hidden" name="'+this.name+'[]" value="'+r+'"/>').appendTo(s);e('<a class="delete icon" title="'+Craft.t("Remove")+'"></a>').appendTo(s);e('<span class="label">'+i+"</span>").appendTo(s);var u=-(s.outerWidth()+10);this.$addTagInput.css("margin-"+Craft.left,u+"px");var a={};a["margin-"+Craft.left]=0;this.$addTagInput.animate(a,"fast");this.$elements=this.$elements.add(s);this.totalElements++;this.initElements(s);this.killSearchMenu();this.$addTagInput.val("");this.$addTagInput.focus();if(!r){s.addClass("loading disabled");var f={groupId:this.tagGroupId,name:i};Craft.postActionRequest("tags/createTag",f,e.proxy(function(e,t){if(t=="success"&&e.success){s.attr("data-id",e.id);o.val(e.id);s.removeClass("loading disabled")}else{this.removeElement(s);t=="success"&&Craft.cp.displayError(Craft.t("An unknown error occurred."))}},this))}},killSearchMenu:function(){this.searchMenu.hide();this.searchMenu.destroy();this.searchMenu=null}});Craft.UpgradeModal=Garnish.Modal.extend({$container:null,$body:null,$compareScreen:null,$checkoutScreen:null,$successScreen:null,$checkoutForm:null,$checkoutLogo:null,$checkoutPrice:null,$checkoutSubmitBtn:null,$checkoutSpinner:null,$checkoutFormError:null,$checkoutSecure:null,clearCheckoutFormTimeout:null,$ccNameInput:null,$ccNumInput:null,$ccMonthInput:null,$ccYearInput:null,$ccCvcInput:null,submittingPurchase:!1,editions:null,edition:null,init:function(t){this.$container=e('<div id="upgrademodal" class="modal loading"/>').appendTo(Garnish.$bod),this.base(this.$container,e.extend({resizable:!0},t));Craft.postActionRequest("app/getUpgradeModal",e.proxy(function(t,n){this.$container.removeClass("loading");if(n=="success"){if(t.success){this.editions=t.editions;this.$container.append(t.modalHtml);this.$compareScreen=this.$container.children("#upgrademodal-compare");this.$checkoutScreen=this.$container.children("#upgrademodal-checkout");this.$successScreen=this.$container.children("#upgrademodal-success");this.$checkoutLogo=this.$checkoutScreen.find(".logo:first");this.$checkoutPrice=this.$checkoutScreen.find(".price:first");this.$checkoutForm=this.$checkoutScreen.find("form:first");this.$checkoutSubmitBtn=this.$checkoutForm.find(".submit:first");this.$checkoutSpinner=this.$checkoutForm.find(".spinner:first");this.$ccNameInput=this.$checkoutForm.find("#cc-name");this.$ccNumInput=this.$checkoutForm.find("#cc-num");this.$ccMonthInput=this.$checkoutForm.find("#cc-month");this.$ccYearInput=this.$checkoutForm.find("#cc-year");this.$ccCvcInput=this.$checkoutForm.find("#cc-cvc");this.$checkoutSecure=this.$checkoutScreen.find(".secure:first");var r=this.$compareScreen.find(".buybtn");this.addListener(r,"click","onBuyBtnClick");var i=this.$compareScreen.find(".btn.test");this.addListener(i,"click","onTestBtnClick");this.addListener(this.$checkoutForm,"submit","submitPurchase");var s=this.$checkoutScreen
.find("#upgrademodal-cancelcheckout");this.addListener(s,"click","cancelCheckout")}else{if(t.error)var o=t.error;else var o=Craft.t("An unknown error occurred.");this.$container.append('<div class="body">'+o+"</div>")}e('<script type="text/javascript" src="https://js.stripe.com/v1/"></script>').appendTo(Garnish.$bod)}},this))},onHide:function(){this.clearCheckoutFormInABit();this.base()},onBuyBtnClick:function(t){var n=e(t.currentTarget);this.edition=n.data("edition");var r=this.editions[this.edition],i=this.getWidth();switch(this.edition){case 1:this.$checkoutLogo.attr("class","logo craftclient").text("Craft Client");break;case 2:this.$checkoutLogo.attr("class","logo craftpro").text("Craft Pro")}r.salePrice?this.$checkoutPrice.html('<span class="listedprice">'+r.formattedPrice+"</span> "+r.formattedSalePrice):this.$checkoutPrice.html(r.formattedPrice);this.clearCheckoutFormTimeout&&clearTimeout(this.clearCheckoutFormTimeout);this.$compareScreen.stop().animateLeft(-i,"fast",e.proxy(function(){this.$compareScreen.addClass("hidden")},this));this.$checkoutScreen.stop().css(Craft.left,i).removeClass("hidden").animateLeft(0,"fast")},onTestBtnClick:function(t){var n={edition:e(t.currentTarget).data("edition")};Craft.postActionRequest("app/testUpgrade",n,e.proxy(function(t,n){if(n=="success"){var r=this.getWidth();this.$compareScreen.stop().animateLeft(-r,"fast",e.proxy(function(){this.$compareScreen.addClass("hidden")},this));this.onUpgrade()}},this))},cancelCheckout:function(){var t=this.getWidth();this.$compareScreen.stop().removeClass("hidden").animateLeft(0,"fast");this.$checkoutScreen.stop().animateLeft(t,"fast",e.proxy(function(){this.$checkoutScreen.addClass("hidden")},this));this.clearCheckoutFormInABit()},submitPurchase:function(t){t.preventDefault();if(this.submittingPurchase)return;this.cleanupCheckoutForm();var n=t.data.pkg,r={name:this.$ccNameInput.val(),number:this.$ccNumInput.val(),exp_month:this.$ccMonthInput.val(),exp_year:this.$ccYearInput.val(),cvc:this.$ccCvcInput.val()},i=!0;if(!r.name){i=!1;this.$ccNameInput.addClass("error")}if(!Stripe.validateCardNumber(r.number)){i=!1;this.$ccNumInput.addClass("error")}if(!Stripe.validateExpiry(r.exp_month,r.exp_year)){i=!1;this.$ccMonthInput.addClass("error");this.$ccYearInput.addClass("error")}if(!Stripe.validateCVC(r.cvc)){i=!1;this.$ccCvcInput.addClass("error")}if(i){this.submittingPurchase=!0;this.$checkoutSubmitBtn.addClass("active");this.$checkoutSpinner.removeClass("hidden");Stripe.setPublishableKey(Craft.UpgradeModal.stripeApiKey);Stripe.createToken(r,e.proxy(function(t,n){if(!n.error){var r={ccTokenId:n.id,edition:this.edition,expectedPrice:this.editions[this.edition].salePrice?this.editions[this.edition].salePrice:this.editions[this.edition].price};Craft.postActionRequest("app/purchaseUpgrade",r,e.proxy(this,"onPurchaseUpgrade"))}else{this.onPurchaseResponse();this.showError(n.error.message);Garnish.shake(this.$checkoutForm,"left")}},this))}else Garnish.shake(this.$checkoutForm,"left")},onPurchaseResponse:function(){this.submittingPurchase=!1;this.$checkoutSubmitBtn.removeClass("active");this.$checkoutSpinner.addClass("hidden")},onPurchaseUpgrade:function(t,n){this.onPurchaseResponse();if(n=="success")if(t.success){var r=this.getWidth();this.$checkoutScreen.stop().animateLeft(-r,"fast",e.proxy(function(){this.$checkoutScreen.addClass("hidden")},this));this.onUpgrade()}else{if(t.errors){var i="";for(var s in t.errors){i&&(i+="<br>");i+=t.errors[s]}this.showError(i)}else var i=Craft.t("An unknown error occurred.");Garnish.shake(this.$checkoutForm,"left")}},showError:function(t){this.$checkoutFormError=e('<p class="error centeralign">'+t+"</p>").insertBefore(this.$checkoutSecure)},onUpgrade:function(){this.$successScreen.css(Craft.left,this.getWidth()).removeClass("hidden").animateLeft(0,"fast");var e=this.$successScreen.find(".btn:first");this.addListener(e,"click",function(){location.reload()});this.trigger("upgrade")},cleanupCheckoutForm:function(){this.$checkoutForm.find(".error").removeClass("error");if(this.$checkoutFormError){this.$checkoutFormError.remove();this.$checkoutFormError=null}},clearCheckoutForm:function(){this.$ccNameInput.val("");this.$ccNumInput.val("");this.$ccMonthInput.val("");this.$ccYearInput.val("");this.$ccCvcInput.val("")},clearCheckoutFormInABit:function(){this.clearCheckoutFormTimeout=setTimeout(e.proxy(this,"clearCheckoutForm"),Craft.UpgradeModal.clearCheckoutFormTimeoutDuration)}},{stripeApiKey:"pk_J2nJpozDxit0V6wYuT8xSvCKArONs",clearCheckoutFormTimeoutDuration:3e4});Craft.Uploader=Garnish.Base.extend({uploader:null,allowedKinds:null,_rejectedFiles:[],$element:null,_extensionList:null,_fileCounter:0,init:function(t,n){this._rejectedFiles=[];this.$element=t;this.allowedKinds=null;this._extensionList=null;this._fileCounter=0;n=e.extend({},this.defaultSettings,n);var r=n.events;delete n.events;if(n.allowedKinds&&n.allowedKinds.length){typeof n.allowedKinds=="string"&&(n.allowedKinds=[n.allowedKinds]);this.allowedKinds=n.allowedKinds;delete n.allowedKinds;n.autoUpload=!1}this.uploader=t.fileupload(n);for(var i in r)this.uploader.on(i,r[i]);n.dropZone!=null&&e(document).bind("drop dragover",function(e){e.preventDefault()});this.allowedKinds&&this.uploader.on("fileuploadadd",e.proxy(this,"onFileAdd"))},setParams:function(e){this.uploader.fileupload("option",{formData:e})},getInProgress:function(){return this.uploader.fileupload("active")},isLastUpload:function(){return this.getInProgress()==1},onFileAdd:function(t,n){t.stopPropagation();if(!this._extensionList){this._extensionList=[];for(var r=0;r<this.allowedKinds.length;r++){var i=this.allowedKinds[r];for(var s=0;s<Craft.fileKinds[i].length;s++){var o=Craft.fileKinds[i][s];this._extensionList.push(o)}}}n.process().done(e.proxy(function(){var t=n.files[0],r=t.name.match(/\.([a-z0-4_]+)$/i),i=r[1];e.inArray(i.toLowerCase(),this._extensionList)>-1?n.submit():this._rejectedFiles.push('"'+t.name+'"');if(++this._fileCounter==n.originalFiles.length){this._fileCounter=0;this.processErrorMessages()}},this));return!0},processErrorMessages:function(){if(this._rejectedFiles.length){if(this._rejectedFiles.length==1)var e="The file {files} could not be uploaded. The allowed file kinds are: {kinds}.";else var e="The files {files} could not be uploaded. The allowed file kinds are: {kinds}.";e=Craft.t(e,{files:this._rejectedFiles.join(", "),kinds:this.allowedKinds.join(", ")});this._rejectedFiles=[];alert(e)}},defaultSettings:{dropZone:null,pasteZone:null,fileInput:null,autoUpload:!0,sequentialUploads:!0,maxFileSize:Craft.maxUploadSize,alloweKinds:null,events:{}}});Craft.WrongEditionModal=Garnish.Modal.extend({upgradeModal:null,init:function(t){this.base(t.removeClass("hidden"));this.$switchBtn=e("#wrongedition-switchbtn");this.$upgradeBtn=e("#wrongedition-upgradebtn");this.addListener(this.$switchBtn,"click","switchToLicensedEdition");this.addListener(this.$upgradeBtn,"click","showUpgradeModal")},show:function(){this.base();this.removeAllListeners(this.$shade);Garnish.escManager.unregister(this)},switchToLicensedEdition:function(){this.$switchBtn.addClass("disabled");this.$upgradeBtn.addClass("disabled");this.removeAllListeners(this.$switchBtn);this.removeAllListeners(this.$upgradeBtn);Craft.postActionRequest("app/switchToLicensedEdition",e.proxy(function(e,t){location.reload()},this))},showUpgradeModal:function(){if(!this.upgradeModal){this.upgradeModal=new Craft.UpgradeModal({closeOtherModals:!1});this.upgradeModal.on("upgrade",e.proxy(function(){this.hide()},this))}else this.upgradeModal.show()}})})(jQuery);