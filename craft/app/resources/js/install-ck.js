/**
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2014, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */(function(e){Craft.Installer=Garnish.Base.extend({$bg:null,$screens:null,$currentScreen:null,$accountSubmitBtn:null,$siteSubmitBtn:null,loading:!1,init:function(){this.$bg=e("#bg");this.$screens=Garnish.$bod.children(".modal");this.addListener(e("#beginbtn"),"activate","showAccountScreen")},showAccountScreen:function(t){this.showScreen(1,e.proxy(function(){e("#beginbtn").remove();this.$accountSubmitBtn=e("#accountsubmit");this.addListener(this.$accountSubmitBtn,"activate","validateAccount");this.addListener(e("#accountform"),"submit","validateAccount")},this))},validateAccount:function(t){t.preventDefault();var n=["username","email","password"];this.validate("account",n,e.proxy(this,"showSiteScreen"))},showSiteScreen:function(){this.showScreen(2,e.proxy(function(){this.$siteSubmitBtn=e("#sitesubmit");this.addListener(this.$siteSubmitBtn,"activate","validateSite");this.addListener(e("#siteform"),"submit","validateSite")},this))},validateSite:function(t){t.preventDefault();var n=["siteName","siteUrl"];this.validate("site",n,e.proxy(this,"showInstallScreen"))},showInstallScreen:function(){this.showScreen(3,e.proxy(function(){var t=["username","email","password","siteName","siteUrl","locale"],n={};for(var r=0;r<t.length;r++){var i=t[r],s=e("#"+i);n[i]=Garnish.getInputPostVal(s)}Craft.postActionRequest("install/install",n,e.proxy(this,"allDone"),{complete:e.noop})},this))},allDone:function(t,n){if(n=="success"&&t.success){this.$currentScreen.find("h1:first").text(Craft.t("All done!"));var r=e('<div class="buttons"/>'),i=e('<div class="btn big submit">'+Craft.t("Go to Craft")+"</div>").appendTo(r);e("#spinner").replaceWith(r);this.addListener(i,"click",function(){this.showScreen(30,null,1e3);setTimeout(function(){window.location.href=Craft.getUrl("dashboard")},Craft.Installer.duration)})}else this.$currentScreen.find("h1:first").text("Oops.")},showScreen:function(t,n,r){r||(r=Craft.Installer.duration);this.$bg.animate({left:"-"+t*5+"%"},r);var i=Garnish.$win.width(),s=Math.floor(i/2);this.$currentScreen&&this.$currentScreen.css("left",s).animate({left:-400},Craft.Installer.duration);this.$currentScreen=e(this.$screens[t-1]).css({display:"block",left:i+400}).animate({left:s},Craft.Installer.duration,e.proxy(function(){this.$currentScreen.css("left","50%");this.focusFirstInput();n()},this))},validate:function(t,n,r){if(this.loading)return;this.loading=!0;e("#"+t+"form").find(".errors").remove();var i=this["$"+t+"SubmitBtn"];i.addClass("sel loading");var s="install/validate"+Craft.uppercaseFirst(t),o={};for(var u=0;u<n.length;u++){var a=n[u],f=e("#"+a);o[a]=Garnish.getInputPostVal(f)}Craft.postActionRequest(s,o,e.proxy(function(t,n){this.loading=!1;i.removeClass("sel loading");if(n=="success")if(t.validates)r();else{for(var s in t.errors){var o=t.errors[s],u=e("#"+s),a=u.closest(".field"),f=e('<ul class="errors"/>').appendTo(a);for(var l=0;l<o.length;l++){var c=o[l];e("<li>"+c+"</li>").appendTo(f)}if(!u.is(":focus")){u.addClass("error");e.proxy(function(e){this.addListener(e,"focus",function(){e.removeClass("error");this.removeListener(e,"focus")})},this)(u)}}Garnish.shake(this.$currentScreen)}},this))},focusFirstInput:function(){setTimeout(e.proxy(function(){this.$currentScreen.find("input:first").focus()},this),Craft.Installer.duration)}},{duration:300});Garnish.$win.on("load",function(){Craft.installer=new Craft.Installer})})(jQuery);