/**
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2014, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */(function(e){var t=Garnish.Base.extend({$form:null,$loginNameInput:null,$loginFields:null,$passwordPaneItem:null,$passwordInput:null,$forgotPasswordLink:null,$rememberMeCheckbox:null,$sslIcon:null,$submitBtn:null,$spinner:null,$error:null,passwordInputInterval:null,forgotPassword:!1,loading:!1,init:function(){this.$form=e("#login-form"),this.$loginNameInput=e("#loginName");this.$loginFields=e("#login-fields");this.$passwordPaneItem=this.$loginFields.children();this.$passwordInput=e("#password");this.$forgotPasswordLink=e("#forgot-password");this.$sslIcon=e("#ssl-icon");this.$submitBtn=e("#submit");this.$spinner=e("#spinner");this.$rememberMeCheckbox=e("#rememberMe");new Craft.PasswordInput(this.$passwordInput,{onToggleInput:e.proxy(function(e){this.removeListener(this.$passwordInput,"textchange");this.$passwordInput=e;this.addListener(this.$passwordInput,"textchange","validate")},this)});this.addListener(this.$loginNameInput,"textchange","validate");this.addListener(this.$passwordInput,"textchange","validate");this.addListener(this.$forgotPasswordLink,"click","onForgetPassword");this.addListener(this.$form,"submit","onSubmit");this.addListener(this.$sslIcon,"mouseover",function(){if(this.$sslIcon.hasClass("disabled"))return;this.$submitBtn.addClass("hover")});this.addListener(this.$sslIcon,"mouseout",function(){if(this.$sslIcon.hasClass("disabled"))return;this.$submitBtn.removeClass("hover")});this.addListener(this.$sslIcon,"mousedown",function(){if(this.$sslIcon.hasClass("disabled"))return;this.$submitBtn.addClass("active");this.addListener(Garnish.$doc,"mouseup",function(){this.$submitBtn.removeClass("active");this.removeListener(Garnish.$doc,"mouseup")})});this.passwordInputInterval=setInterval(e.proxy(this,"validate"),250);this.addListener(this.$sslIcon,"click",function(){this.$submitBtn.click()})},validate:function(){if(this.$loginNameInput.val()&&(this.forgotPassword||this.$passwordInput.val().length>=6)){this.$sslIcon.enable();this.$submitBtn.enable();return!0}this.$sslIcon.disable();this.$submitBtn.disable();return!1},onSubmit:function(e){e.preventDefault();if(!this.validate())return;this.$submitBtn.addClass("active");this.$spinner.removeClass("hidden");this.loading=!0;this.$error&&this.$error.remove();this.forgotPassword?this.submitForgotPassword():this.submitLogin()},submitForgotPassword:function(){var t={loginName:this.$loginNameInput.val()};Craft.postActionRequest("users/forgotpassword",t,e.proxy(function(e,t){t=="success"&&(e.success?new n:this.showError(e.error));this.onSubmitResponse()},this))},submitLogin:function(){var t={loginName:this.$loginNameInput.val(),password:this.$passwordInput.val(),rememberMe:this.$rememberMeCheckbox.prop("checked")?"y":""};Craft.postActionRequest("users/login",t,e.proxy(function(e,t){if(t=="success")if(e.success)window.location.href=Craft.getUrl(window.returnUrl);else{Garnish.shake(this.$form);this.onSubmitResponse();this.showError(e.error)}else this.onSubmitResponse()},this));return!1},onSubmitResponse:function(){this.$submitBtn.removeClass("active");this.$spinner.addClass("hidden");this.loading=!1},showError:function(t){t||(t=Craft.t("An unknown error occurred."));this.$error=e('<p class="error" style="display:none">'+t+"</p>").appendTo(this.$form);this.$error.fadeIn()},onForgetPassword:function(e){e.preventDefault();this.$loginNameInput.focus();this.$error&&this.$error.remove();var t=parseInt(this.$form.css("margin-top")),n=this.$loginFields.height(),r=t+Math.round(n/2);this.$form.animate({marginTop:r},"fast");this.$loginFields.animate({height:0},"fast");this.$submitBtn.addClass("reset-password");this.$submitBtn.attr("value",Craft.t("Reset Password"));this.$submitBtn.enable();this.$sslIcon.remove();this.forgotPassword=!0;this.validate()}}),n=Garnish.Modal.extend({init:function(){var t=e('<div class="modal fitted email-sent"><div class="body">'+Craft.t("Check your email for instructions to reset your password.")+"</div></div>").appendTo(Garnish.$bod);this.base(t)},hide:function(){}}),r=new t})(jQuery);